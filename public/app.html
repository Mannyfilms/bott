<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/webp" href="data:image/webp;base64,UklGRu4yAABXRUJQVlA4WAoAAAAoAAAArQEAXgEASUNDUKgBAAAAAAGobGNtcwIQAABtbnRyUkdCIFhZWiAH3AABABkAAwApADlhY3NwQVBQTAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWxjbXMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAAF9jcHJ0AAABTAAAAAx3dHB0AAABWAAAABRyWFlaAAABbAAAABRnWFlaAAABgAAAABRiWFlaAAABlAAAABRyVFJDAAABDAAAAEBnVFJDAAABDAAAAEBiVFJDAAABDAAAAEBkZXNjAAAAAAAAAAVjMmNpAAAAAAAAAAAAAAAAY3VydgAAAAAAAAAaAAAAywHJA2MFkghrC/YQPxVRGzQh8SmQMhg7kkYFUXdd7WtwegWJsZp8rGm/fdPD6TD//3RleHQAAAAAQ0MwAFhZWiAAAAAAAAD21gABAAAAANMtWFlaIAAAAAAAAG+iAAA49QAAA5BYWVogAAAAAAAAYpkAALeFAAAY2lhZWiAAAAAAAAAkoAAAD4QAALbP">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket Bitcoin Prediction Bot</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#08090d;--bg2:#0e1017;--sf:#13151c;--sf2:#181b24;--sf3:#1e222e;--bd:rgba(255,255,255,.06);--bdh:rgba(255,255,255,.1);--tx:#edeef2;--tx2:#a0a5b8;--tx3:#5d6277;--btc:#f7931a;--btcs:rgba(247,147,26,.1);--btcm:rgba(247,147,26,.2);--up:#00dc82;--ups:rgba(0,220,130,.1);--upm:rgba(0,220,130,.18);--dn:#ff4757;--dns:rgba(255,71,87,.1);--dnm:rgba(255,71,87,.18);--bl:#636bff;--bls:rgba(99,107,255,.1);--r:12px;--rs:8px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;-webkit-font-smoothing:antialiased;overflow-x:hidden}
        .shell{max-width:1320px;margin:0 auto;padding:20px 20px 60px}

        /* NAV */
        .nav{display:flex;align-items:center;gap:14px;padding:14px 0 20px;border-bottom:1px solid var(--bd);margin-bottom:22px}
        .nav-mark{width:36px;height:36px;border-radius:10px;background:linear-gradient(140deg,var(--btc),#e07c0e);display:grid;place-items:center;font-size:16px;flex-shrink:0}
        .nav-text h1{font-size:1.05em;font-weight:600;letter-spacing:-.01em}
        .nav-text span{font-size:.72em;color:var(--tx3)}
        .nav-right{margin-left:auto;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
        .nav-user{font-size:.8em;color:var(--tx2);padding:0 10px}

        .btn{display:inline-flex;align-items:center;gap:5px;padding:8px 16px;border:none;border-radius:var(--rs);font-family:'Outfit',sans-serif;font-size:.8em;font-weight:500;cursor:pointer;transition:all .15s;white-space:nowrap}
        .btn-go{background:linear-gradient(140deg,var(--btc),#e07c0e);color:#fff;box-shadow:0 2px 10px rgba(247,147,26,.15)}
        .btn-go:hover{box-shadow:0 3px 16px rgba(247,147,26,.22);transform:translateY(-1px)}
        .btn-g{background:var(--sf2);color:var(--tx2);border:1px solid var(--bd)}
        .btn-g:hover{background:var(--sf3);color:var(--tx)}
        .btn-r{background:var(--dns);color:var(--dn);border:1px solid rgba(255,71,87,.12)}
        .btn-r:hover{background:var(--dnm)}
        .btn:disabled{opacity:.35;cursor:not-allowed;transform:none!important}
        .tf-btn{background:var(--sf2);color:var(--tx2);border:1px solid var(--bd);padding:10px 24px;font-size:.85em;font-weight:600;letter-spacing:.02em}
        .tf-btn:hover{background:var(--sf3);color:var(--tx)}
        .tf-active{background:linear-gradient(140deg,var(--btc),#e07c0e)!important;color:#fff!important;border-color:transparent!important;box-shadow:0 2px 12px rgba(247,147,26,.2)}

        .disc{display:flex;align-items:center;gap:8px;padding:9px 15px;background:var(--sf);border:1px solid var(--bd);border-radius:var(--rs);margin-bottom:20px;font-size:.76em;color:var(--tx3);line-height:1.4}
        .disc svg{flex-shrink:0;opacity:.45}

        .card{background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:22px;margin-bottom:14px;transition:border-color .2s}
        .card:hover{border-color:var(--bdh)}
        .ct{font-size:.68em;font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--tx3);margin-bottom:16px}

        .g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
        .g3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
        .g6{display:grid;grid-template-columns:repeat(auto-fill,minmax(145px,1fr));gap:10px}
        @media(max-width:768px){
          .g2,.g3{grid-template-columns:1fr}
          .nav{flex-wrap:wrap;gap:8px;padding:10px}
          .nav-right{width:100%;justify-content:flex-end}
          .shell{padding:10px 10px 40px}
          .card{padding:14px}
          .price-big{font-size:1.6em}
          .pred{padding:16px}
          #predictionValue{font-size:1.8em}
          .sig{font-size:.72em;padding:5px 8px}
          h1{font-size:1.1em}
        }
        .light-mode{--bg:#f5f5f7;--sf1:#ffffff;--sf2:#f0f0f3;--sf3:#e5e5ea;--tx1:#1d1d1f;--tx2:#6e6e73;--tx3:#8e8e93;--bd:rgba(0,0,0,.08)}
        .light-mode .card{box-shadow:0 1px 4px rgba(0,0,0,.08)}
        .light-mode .pred-up{background:linear-gradient(135deg,#d4edda,#c3e6cb)}
        .light-mode .pred-dn{background:linear-gradient(135deg,#f8d7da,#f5c6cb)}
        .light-mode .nav{background:rgba(255,255,255,.85)}
        .light-mode .sig{background:var(--sf2)}
        .theme-toggle{cursor:pointer;background:var(--sf2);border:1px solid var(--bd);border-radius:6px;padding:6px 12px;color:var(--tx2);font-size:.8em}

        .status{padding:10px 16px;background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);text-align:center;font-size:.82em;color:var(--tx2);margin-bottom:12px}
        .mlbar{padding:10px 16px;background:var(--bls);border:1px solid rgba(99,107,255,.1);border-radius:var(--rs);font-size:.76em;color:var(--bl);line-height:1.7}

        .plbl{font-size:.68em;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:4px}
        .pbig{font-family:'JetBrains Mono',monospace;font-size:2.1em;font-weight:700;letter-spacing:-.03em}
        .psub{font-size:.72em;color:var(--tx3);margin-top:3px}

        .vs{background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);padding:14px;text-align:center;margin-top:14px}
        .vsl{font-size:.66em;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:5px}
        .vsv{font-family:'JetBrains Mono',monospace;font-size:1.1em;font-weight:600}

        .pred{padding:20px;border-radius:var(--r);text-align:center}
        .pred-up{background:var(--ups);border:1px solid rgba(0,220,130,.12)}
        .pred-dn{background:var(--dns);border:1px solid rgba(255,71,87,.12)}
        .pred-nu{background:var(--sf2);border:1px solid var(--bd)}
        .pred-info{background:var(--btcs);border:1px solid rgba(247,147,26,.1)}
        .pred h3{font-size:.74em;font-weight:500;color:var(--tx2);margin-bottom:8px}
        .pred .val{font-family:'JetBrains Mono',monospace;font-size:1.4em;font-weight:700}
        .pred .conf{font-size:.76em;color:var(--tx2);margin-top:6px}

        .cftrack{width:100%;height:6px;background:var(--sf3);border-radius:3px;overflow:hidden;margin:12px 0 4px}
        .cffill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--up),#00b86e);transition:width .5s}
        .cflbl{text-align:right;font-family:'JetBrains Mono',monospace;font-size:.72em;color:var(--tx3)}
        .skipmsg{background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);padding:10px;text-align:center;font-size:.78em;color:var(--tx3);margin-top:10px;display:none}

        .mc{background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);padding:15px}
        .mc h4{font-size:.68em;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:8px}
        .mc .mp{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:.88em}
        .mc .mcc{font-size:.75em;color:var(--tx3);margin-top:3px}

        .pat{background:var(--btcs);border:1px solid rgba(247,147,26,.12);border-radius:var(--rs);padding:10px 16px;font-size:.82em;color:var(--btc);margin-top:10px;display:none;font-weight:500}
        .sigw{background:var(--sf2);border-radius:var(--rs);padding:16px;margin-top:14px}
        .sigw h3{font-size:.68em;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:10px}
        .sig{display:flex;justify-content:space-between;align-items:center;padding:8px 11px;margin:4px 0;background:var(--sf);border-radius:6px;font-size:.78em;border-left:3px solid var(--bd)}
        .sig-u{border-left-color:var(--up)}.sig-d{border-left-color:var(--dn)}

        .chip{background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);padding:11px 13px}
        .chip .cl{font-size:.64em;text-transform:uppercase;letter-spacing:.07em;color:var(--tx3);margin-bottom:4px}
        .chip .cv{font-family:'JetBrains Mono',monospace;font-size:.86em;font-weight:600}
        .echip{background:var(--btcs);border:1px solid rgba(247,147,26,.08);border-radius:var(--rs);padding:11px 13px}
        .echip .cl{font-size:.64em;text-transform:uppercase;letter-spacing:.07em;color:rgba(247,147,26,.5);margin-bottom:4px}
        .echip .cv{font-family:'JetBrains Mono',monospace;font-size:.86em;font-weight:600;color:var(--btc)}

        .sbox{background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);padding:14px;text-align:center}
        .sbox .sl{font-size:.64em;text-transform:uppercase;letter-spacing:.07em;color:var(--tx3);margin-bottom:5px}
        .sbox .sv{font-family:'JetBrains Mono',monospace;font-size:1.3em;font-weight:700;color:var(--btc)}

        .perf{background:var(--sf2);border-radius:var(--rs);padding:14px;margin-top:14px}
        .perf h3{font-size:.68em;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:10px}
        .prow{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--sf);margin:3px 0;border-radius:5px;font-size:.78em}

        .hist{max-height:330px;overflow-y:auto;margin-top:10px}
        .hist::-webkit-scrollbar{width:3px}
        .hist::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px}
        .hitem{padding:11px;border-bottom:1px solid var(--bd);font-size:.8em}
        .hitem:last-child{border-bottom:none}
        .correct{color:var(--up);font-weight:600}.incorrect{color:var(--dn);font-weight:600}

        /* ‚ïê‚ïê‚ïê RESULT HISTORY BAR ‚ïê‚ïê‚ïê */
        .rhb-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .rhb-scroll{display:flex;gap:5px;overflow-x:auto;padding:4px 2px 10px;scroll-behavior:smooth}
        .rhb-scroll::-webkit-scrollbar{height:4px}
        .rhb-scroll::-webkit-scrollbar-track{background:var(--sf2);border-radius:2px}
        .rhb-scroll::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px}
        .rhb-scroll::-webkit-scrollbar-thumb:hover{background:var(--bdh)}
        .rhb-block{flex-shrink:0;width:54px;height:72px;border-radius:9px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;cursor:default;transition:transform .15s,box-shadow .15s,opacity .15s;position:relative;border:1px solid transparent}
        .rhb-block:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(0,0,0,.3);z-index:2}
        .rhb-correct{background:var(--ups);border-color:rgba(0,220,130,.2)}
        .rhb-wrong{background:var(--dns);border-color:rgba(255,71,87,.2)}
        .rhb-new{animation:rhbPop .45s cubic-bezier(.34,1.56,.64,1) both}
        @keyframes rhbPop{from{transform:scale(0.4) translateY(12px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}
        .rhb-icon{font-size:1.35em;font-weight:700;line-height:1}
        .rhb-correct .rhb-icon{color:var(--up)}
        .rhb-wrong .rhb-icon{color:var(--dn)}
        .rhb-arrow{font-size:.9em;line-height:1;opacity:.75}
        .rhb-correct .rhb-arrow{color:var(--up)}
        .rhb-wrong .rhb-arrow{color:var(--dn)}
        .rhb-time{font-family:'JetBrains Mono',monospace;font-size:.55em;color:var(--tx3);text-align:center;line-height:1.3;margin-top:2px}
        .rhb-conf{font-family:'JetBrains Mono',monospace;font-size:.5em;text-align:center;line-height:1;opacity:.6}
        .rhb-correct .rhb-conf{color:var(--up)}
        .rhb-wrong .rhb-conf{color:var(--dn)}
        .rhb-empty{text-align:center;padding:22px 16px;color:var(--tx3);font-size:.78em;background:var(--sf2);border-radius:var(--rs);border:1px dashed var(--bd);line-height:1.6}
        .rhb-empty-icon{font-size:1.6em;display:block;margin-bottom:6px;opacity:.4}

        /* Streak + accuracy badges */
        .rhb-badges{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
        .streak-badge,.acc-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 11px;border-radius:20px;font-size:.73em;font-weight:600;white-space:nowrap}
        .streak-hot{background:rgba(255,110,30,.12);color:#ff7a2a;border:1px solid rgba(255,110,30,.18)}
        .streak-ok{background:var(--ups);color:var(--up);border:1px solid rgba(0,220,130,.15)}
        .streak-cold{background:var(--sf3);color:var(--tx3);border:1px solid var(--bd)}
        .streak-wrong{background:var(--dns);color:var(--dn);border:1px solid rgba(255,71,87,.15)}
        .acc-badge{background:var(--btcs);color:var(--btc);border:1px solid rgba(247,147,26,.12)}

        /* Tooltip */
        .rhb-block::after{
          content:attr(data-tip);
          position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);
          background:#0a0b10;border:1px solid var(--bd);border-radius:6px;
          padding:6px 10px;font-size:.68em;color:var(--tx2);white-space:nowrap;
          pointer-events:none;opacity:0;transition:opacity .15s;z-index:100;
          font-family:'Outfit',sans-serif;line-height:1.5;
          box-shadow:0 4px 16px rgba(0,0,0,.4)
        }
        .rhb-block:hover::after{opacity:1}
    </style>
</head>
<body>
<div class="shell">
    <nav class="nav">
        <div class="nav-mark">&#8383;</div>
        <div class="nav-text"><h1>Polymarket BTC Predictor</h1><span>5-Minute Forecasts &middot; Chainlink BTC/USD (Polymarket Source)</span></div>
        <div class="nav-right">
            <span class="nav-user" id="userGreeting"></span>
            <button class="btn btn-go" id="startBtn" onclick="startPredictions()">Start</button>
            <button class="btn btn-g" id="stopBtn" onclick="stopPredictions()" disabled>Stop</button>
            <button class="btn btn-g" onclick="saveProgress()">Save</button>
            <button class="btn btn-r" onclick="resetStats()">Reset</button>
            <button class="btn btn-g" onclick="logout()">Log out</button>
        </div>
    </nav>

    <div class="disc">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        Predictions are not 100% accurate and can make mistakes. Use as a reference, not financial advice. Progress auto-saves.
    </div>

    <div class="card">
        <div class="ct">Market Status</div>
        <div class="status" id="status">Ready &mdash; Click Start</div>
        <div class="mlbar" id="mlStatus">Ensemble: Initializing &middot; LSTM: Not trained &middot; Pattern Recognition: Active</div>
        <div class="g2" style="margin-top:16px">
            <div style="text-align:center"><div class="plbl">Price to Beat</div><div class="pbig" id="priceToBeat" style="color:var(--tx2)">--</div><div class="psub" id="ptbLabel">Set at 5-minute mark</div></div>
            <div style="text-align:center"><div class="plbl">Current Price</div><div class="pbig" id="currentPrice" style="color:var(--btc)">--</div><div class="psub" id="lastUpdate">--</div></div>
        </div>
        <div class="vs"><div class="vsl">Current vs Target</div><div class="vsv" id="vsComparison">--</div></div>
    </div>

    <div class="card">
        <div class="ct">Prediction &amp; Confidence</div>
        <div class="g2">
            <div class="pred pred-nu" id="predictionDisplay"><h3>Ensemble Prediction</h3><div class="val" id="predictionValue">--</div><div class="conf" id="predictionConfidence">--</div><div style="margin-top:6px;font-size:.75em;color:var(--tx3)" id="predictionDetails">--</div></div>
            <div class="pred pred-info"><h3>Next Check</h3><div style="font-family:'JetBrains Mono',monospace;font-size:1.25em;font-weight:700;color:var(--btc);margin:8px 0" id="nextCheckTime">--</div><div style="font-size:.73em;color:var(--tx2);line-height:1.8">3 ML Models &middot; 15+ Indicators<br>Sentiment &middot; Pattern Recognition</div></div>
        </div>
        <div><div class="cflbl"><span id="confPercent">0%</span></div><div class="cftrack"><div class="cffill" id="confidenceMeter" style="width:0%"></div></div></div>
        <div class="g3" style="margin-top:12px">
            <div class="mc"><h4>LSTM</h4><div class="mp" id="model1Pred">--</div><div class="mcc" id="model1Conf">--%</div></div>
            <div class="mc"><h4>Technical</h4><div class="mp" id="model2Pred">--</div><div class="mcc" id="model2Conf">--%</div></div>
            <div class="mc"><h4>Hybrid</h4><div class="mp" id="model3Pred">--</div><div class="mcc" id="model3Conf">--%</div></div>
        </div>
        <div class="pat" id="patternSection"><span id="patternName"></span></div>
        <div class="sigw"><h3>Signal Breakdown</h3><div id="signalList" style="color:var(--tx3);font-size:.8em">Waiting&hellip;</div></div>
    </div>

    <div class="card">
        <div class="ct">Market Sentiment</div>
        <div class="g6">
            <div class="echip"><div class="cl">Fear &amp; Greed</div><div class="cv" id="fearGreed">--</div></div>
            <div class="echip"><div class="cl">Sentiment</div><div class="cv" id="sentiment">--</div></div>
            <div class="echip"><div class="cl">BTC Dominance</div><div class="cv" id="btcDominance">--</div></div>
            <div class="echip"><div class="cl">Funding Rate</div><div class="cv" id="fundingRate">--</div></div>
            <div class="echip"><div class="cl">Exchange Flow</div><div class="cv" id="exchangeFlow">--</div></div>
            <div class="echip"><div class="cl">Whale Activity</div><div class="cv" id="whaleActivity">--</div></div>
        </div>
    </div>

    <!-- Hidden spans JS needs -->
    <div style="display:none"><span id="sma5"></span><span id="sma10"></span><span id="sma20"></span><span id="ema12"></span><span id="rsi"></span><span id="stochastic"></span><span id="bbUpper"></span><span id="bbLower"></span><span id="macd"></span><span id="atr"></span><span id="volumeTrend"></span><span id="momentum"></span><span id="themeBtn"></span></div>
    <div style="display:none"><span id="totalPredictions"></span><span id="correctPredictions"></span><span id="accuracyRate"></span><span id="highConfAccuracy"></span><span id="winStreak"></span><span id="skippedCount"></span><div id="signalPerformance"></div></div>

    <!-- ‚ïê‚ïê‚ïê RESULT HISTORY BAR ‚ïê‚ïê‚ïê -->
    <div class="card">
        <div class="rhb-header">
            <div class="ct" style="margin-bottom:0">5-Min Result History</div>
            <div class="rhb-badges" id="historyStreakDisplay"></div>
        </div>
        <div class="rhb-scroll" id="resultHistoryBar">
            <div class="rhb-empty">
                <span class="rhb-empty-icon">‚è≥</span>
                Results appear here after each 5-minute cycle completes
            </div>
        </div>
    </div>

    <div class="card">
        <div class="ct">Full History Log</div>
        <div class="hist" id="history"><div style="text-align:center;padding:16px;color:var(--tx3);font-size:.8em">No predictions yet</div></div>
    </div>

    <!-- HOW IT WORKS -->
    <div class="card">
        <div class="ct">How Our Predictions Work</div>
        <div style="font-size:.85em;color:var(--tx2);line-height:1.85">
            <p style="margin-bottom:14px">Our system loads <strong style="color:var(--tx)">200 historical candlesticks</strong> from Binance on startup, then combines <strong style="color:var(--tx)">15+ trading strategies</strong> with 3 ML models and real-time market data.</p>
            <div style="background:var(--sf2);border-radius:var(--rs);padding:16px;margin-bottom:12px">
                <div style="color:var(--btc);font-weight:600;font-size:.82em;text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">&#9881; Historical Data Engine</div>
                <p><strong style="color:var(--tx)">200 1-Min Candles</strong> &mdash; Full OHLCV data loaded on startup from Binance, giving indicators real history immediately.</p>
                <p style="margin-top:8px"><strong style="color:var(--tx)">100 5-Min Candles</strong> &mdash; Bigger-picture context for trend analysis and VWAP calculations. Refreshed every 60 seconds.</p>
            </div>
            <div style="background:var(--sf2);border-radius:var(--rs);padding:16px;margin-bottom:12px">
                <div style="color:var(--up);font-weight:600;font-size:.82em;text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">&#9889; 15+ Trading Strategies</div>
                <p><strong style="color:var(--tx)">VWAP, EMA Ribbon, Mean Reversion, ADX, Williams %R, OBV, ROC, Stochastic, Bollinger Squeeze, S/R, Candlestick Patterns, Buy/Sell Pressure, Contrarian Indicators</strong></p>
            </div>
            <div style="background:var(--sf2);border-radius:var(--rs);padding:16px;margin-bottom:12px">
                <div style="color:var(--bl);font-weight:600;font-size:.82em;text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">&#128202; ML Ensemble</div>
                <p><strong style="color:var(--tx)">LSTM Neural Network</strong> &mdash; Sequential pattern analysis on 15-feature vectors. <strong style="color:var(--tx)">Technical &amp; Hybrid Models</strong> &mdash; Dense networks trained on live prediction results.</p>
            </div>
            <div style="background:var(--sf2);border-radius:var(--rs);padding:16px">
                <div style="color:var(--btc);font-weight:600;font-size:.82em;text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">&#127919; Adaptive Signal Weighting</div>
                <p>Each strategy's weight adjusts based on real accuracy. <strong style="color:var(--tx)">High-performing signals gain influence</strong>, underperformers lose weight. System self-improves over every 5-minute cycle.</p>
            </div>
        </div>
    </div>

</div>

<script>
// ‚ïê‚ïê‚ïê AUTH CHECK ‚ïê‚ïê‚ïê
async function checkAuth(){
    try{const r=await fetch('/api/me');if(!r.ok){window.location.href='/';return}const d=await r.json();document.getElementById('userGreeting').textContent=d.username}catch(e){window.location.href='/'}
}
async function logout(){
    await fetch('/api/logout',{method:'POST'});window.location.href='/';
}
checkAuth();
setInterval(async () => {
  try {
    const r = await fetch('/api/me');
    if (!r.ok) {
      const data = await r.json().catch(() => ({}));
      if (data.error && data.error.includes('Someone else')) {
        alert('You have been logged out because someone else logged in with your access code.');
      }
      window.location.href = '/';
    }
  } catch (e) { }
}, 10000);

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let selectedTimeframe=5;
let priceHistory=[],predictionHistory=[],updateInterval=null,checkInterval=null;
let isRunning=false;
let lstmModel=null,technicalModel=null,hybridModel=null,modelsTraining=false,trainingData=[];
let signalWeights={sma:2,rsi:2.5,bollinger:2,macd:2,volume:1.5,momentum:1.5,pattern:2.5,sentiment:1.8,lstm:3,technical:2.5,hybrid:2.5};
let signalPerformance={};
let stats={total:0,correct:0,currentStreak:0,skipped:0,highConfPredictions:0,highConfCorrect:0};
let externalData={fearGreed:50,sentiment:'NEUTRAL',btcDominance:50,fundingRate:0,exchangeFlow:'NEUTRAL',whaleActivity:'LOW'};

// ‚ïê‚ïê‚ïê RESULT HISTORY BAR ‚ïê‚ïê‚ïê
function renderHistoryBar(){
  const container=document.getElementById('resultHistoryBar');
  if(!container)return;
  if(!predictionHistory.length){
    container.innerHTML='<div class="rhb-empty"><span class="rhb-empty-icon">‚è≥</span>Results appear here after each 5-minute cycle completes</div>';
    updateStreakDisplay();
    return;
  }
  // Show oldest ‚Üí newest (left to right), max 40
  const items=[...predictionHistory].slice(0,40).reverse();
  container.innerHTML=items.map((h,i)=>{
    const isCorrect=h.correct;
    const isLatest=(i===items.length-1);
    const predictedUp=h.predicted&&(h.predicted.includes('WILL BEAT')||h.predicted==='WILL BEAT');
    const actualUp=h.actual==='DID BEAT';
    // Build tooltip text
    const tip=`${h.targetTime||''} | PTB: ${h.priceToBeat||'?'} | Actual: ${h.actualPrice||'?'} | ${isCorrect?'‚úì CORRECT':'‚úó WRONG'} | Conf: ${h.confidence||'?'}`;
    const confNum=parseFloat(h.confidence)||0;
    return `<div class="rhb-block ${isCorrect?'rhb-correct':'rhb-wrong'}${isLatest?' rhb-new':''}" data-tip="${tip}">
      <div class="rhb-icon">${isCorrect?'‚úì':'‚úó'}</div>
      <div class="rhb-arrow">${predictedUp?'‚Üë':'‚Üì'}</div>
      <div class="rhb-time">${formatBarTime(h.targetTime||'')}</div>
      <div class="rhb-conf">${confNum>0?confNum.toFixed(0)+'%':''}</div>
    </div>`;
  }).join('');
  // Scroll to rightmost (most recent)
  requestAnimationFrame(()=>{container.scrollLeft=container.scrollWidth;});
  updateStreakDisplay();
}

function formatBarTime(timeStr){
  // "02:35 AM" ‚Üí "2:35" or "14:35" ‚Üí "2:35"
  if(!timeStr)return'';
  // Remove seconds if present
  return timeStr.replace(/:\d\d\s?(AM|PM)?$/i,'').replace(/^0/,'').trim();
}

function updateStreakDisplay(){
  const el=document.getElementById('historyStreakDisplay');
  if(!el)return;
  if(!predictionHistory.length){el.innerHTML='';return;}
  // Count current streak (correct runs from most recent)
  let correctStreak=0,wrongStreak=0;
  for(const h of predictionHistory){
    if(h.correct){if(wrongStreak===0)correctStreak++;else break;}
    else{if(correctStreak===0)wrongStreak++;else break;}
  }
  const total=predictionHistory.length;
  const correct=predictionHistory.filter(h=>h.correct).length;
  const acc=total?(correct/total*100).toFixed(0):0;
  let streakHtml='';
  if(correctStreak>=1){
    const cls=correctStreak>=5?'streak-hot':correctStreak>=3?'streak-ok':'streak-ok';
    const icon=correctStreak>=5?'üî•':correctStreak>=3?'‚ö°':'‚úì';
    streakHtml=`<span class="streak-badge ${cls}">${icon} ${correctStreak} correct</span>`;
  }else if(wrongStreak>=1){
    streakHtml=`<span class="streak-badge streak-wrong">‚úó ${wrongStreak} wrong</span>`;
  }
  el.innerHTML=streakHtml+`<span class="acc-badge">${acc}% accuracy (${correct}/${total})</span>`;
}

// ‚ïê‚ïê‚ïê PREDICTION LOCK SYSTEM ‚ïê‚ïê‚ïê
let predictionLock={locked:false,direction:null,lockPrice:null,lockTime:null,lockPtb:null,overrideThreshold:100};
function savePredictionLock(){try{const slot=Math.floor(Date.now()/300000);localStorage.setItem('predLock5m',JSON.stringify({...predictionLock,slot}))}catch(e){}}
function loadPredictionLock(){try{const d=JSON.parse(localStorage.getItem('predLock5m'));if(!d||!d.locked)return false;const currentSlot=Math.floor(Date.now()/300000);if(d.slot!==currentSlot)return false;predictionLock=d;return true}catch(e){return false}}
function resetPredictionLock(){predictionLock={locked:false,direction:null,lockPrice:null,lockTime:null,lockPtb:null,overrideThreshold:100};ptbTracker={aboveCount:0,belowCount:0,totalChecks:0,lastSlot:null,prices:[],firstPrice:null};try{localStorage.removeItem('predLock5m');localStorage.removeItem('currentPred5m')}catch(e){}}

let ptbTracker={aboveCount:0,belowCount:0,totalChecks:0,lastSlot:null,prices:[],firstPrice:null};
let markets={5:{priceToBeat:null,currentSlot:null,currentPrediction:null},15:{priceToBeat:null,currentSlot:null,currentPrediction:null},60:{priceToBeat:null,currentSlot:null,currentPrediction:null}};
let positionHistory=[];
function trackPosition(price,ptb){if(!ptb)return;positionHistory.push({above:price>=ptb,diff:price-ptb,timestamp:Date.now()});if(positionHistory.length>60)positionHistory.shift()}
function resetPositionHistory(){positionHistory=[];}
function getPositionBias(){if(positionHistory.length<2)return{bias:0,abovePct:0.5,avgDiff:0,trend:0};const aboveCount=positionHistory.filter(p=>p.above).length;const abovePct=aboveCount/positionHistory.length;const avgDiff=positionHistory.reduce((s,p)=>s+p.diff,0)/positionHistory.length;const recentHalf=positionHistory.slice(-Math.floor(positionHistory.length/2));const olderHalf=positionHistory.slice(0,Math.floor(positionHistory.length/2));const recentAvg=recentHalf.reduce((s,p)=>s+p.diff,0)/recentHalf.length;const olderAvg=olderHalf.length?olderHalf.reduce((s,p)=>s+p.diff,0)/olderHalf.length:recentAvg;const trend=recentAvg-olderAvg;const bias=(abovePct-0.5)*2;return{bias,abovePct,avgDiff,trend}}
function getSlot(tf,date){const d=date||new Date();const totalMins=d.getHours()*60+d.getMinutes();return Math.floor(totalMins/tf)*tf}
function getSlotEnd(tf,date){const d=date||new Date();const totalMins=d.getHours()*60+d.getMinutes();const slotMins=Math.floor(totalMins/tf)*tf;const nextSlotMins=slotMins+tf;const end=new Date(d);end.setHours(Math.floor(nextSlotMins/60),nextSlotMins%60,0,0);if(nextSlotMins>=1440){end.setDate(end.getDate()+1);end.setHours(0,0,0,0)}return end}
function getActiveMarket(){return markets[selectedTimeframe]}

function setTimeframe(tf){selectedTimeframe=tf;document.querySelectorAll('.tf-btn').forEach(b=>b.classList.remove('tf-active'));document.getElementById('tf'+tf).classList.add('tf-active');const labels={5:'5-minute',15:'15-minute',60:'1-hour'};document.getElementById('ptbLabel').textContent='Set at '+labels[tf]+' mark';const m=getActiveMarket();if(m.priceToBeat){document.getElementById('priceToBeat').textContent='$'+m.priceToBeat.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});if(latestBtcPrice){const d=latestBtcPrice-m.priceToBeat,p=(d/m.priceToBeat*100).toFixed(3);document.getElementById('vsComparison').innerHTML=d>0?'<span style="color:var(--up)">+$'+d.toFixed(2)+' (+'+p+'%)</span>':'<span style="color:var(--dn)">$'+d.toFixed(2)+' ('+p+'%)</span>'}}else{document.getElementById('priceToBeat').textContent='--';document.getElementById('vsComparison').textContent='--'}if(isRunning)updateCountdown()}

// ‚ïê‚ïê‚ïê SAVE/LOAD ‚ïê‚ïê‚ïê
function saveProgress(){try{const data={predictionHistory:predictionHistory.slice(0,50),trainingData:trainingData.slice(-100),stats,signalPerformance,signalWeights,signalMultipliers,strategyStats:window.strategyStats||{},lastSaved:Date.now()};localStorage.setItem('btcPred',JSON.stringify(data))}catch(e){}}
function loadProgress(){try{const s=localStorage.getItem('btcPred');if(!s)return false;const d=JSON.parse(s);if((Date.now()-d.lastSaved)/36e5>24)return false;predictionHistory=d.predictionHistory||[];trainingData=d.trainingData||[];stats=d.stats||stats;signalPerformance=d.signalPerformance||{};signalWeights=d.signalWeights||signalWeights;signalMultipliers=d.signalMultipliers||{};window.strategyStats=d.strategyStats||{};updateStats();updateHistoryDisplay();renderHistoryBar();updateSignalPerformance();document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--up)">ACTIVE</strong> &middot; All models online &middot; Learned weights: '+(Object.keys(signalMultipliers).length||0)+' signals';return true}catch(e){return false}}
setInterval(saveProgress,30000);window.addEventListener('beforeunload',saveProgress);window.addEventListener('pagehide',saveProgress);

function fmt(d){return d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}
function toggleTheme(){}
let btcWs=null,latestBtcPrice=null;
let polyWs=null,latestChainlinkPrice=null;
let lastChainlinkSlot=null;
let chainlinkCandles=[];
let currentChainlinkCandle=null;
function getChainlinkSlot(ts){return Math.floor(ts/300000)}
function processChainlinkTick(price,timestamp){const slot=getChainlinkSlot(timestamp);if(!currentChainlinkCandle||currentChainlinkCandle.slot!==slot){if(currentChainlinkCandle&&currentChainlinkCandle.ticks>0){chainlinkCandles.push({time:currentChainlinkCandle.slot*300000,open:currentChainlinkCandle.open,high:currentChainlinkCandle.high,low:currentChainlinkCandle.low,close:currentChainlinkCandle.close,ticks:currentChainlinkCandle.ticks});if(chainlinkCandles.length>100)chainlinkCandles.shift()}currentChainlinkCandle={slot,open:price,high:price,low:price,close:price,ticks:1}}else{currentChainlinkCandle.high=Math.max(currentChainlinkCandle.high,price);currentChainlinkCandle.low=Math.min(currentChainlinkCandle.low,price);currentChainlinkCandle.close=price;currentChainlinkCandle.ticks++}}

function savePtb(price){const slot=Math.floor(Date.now()/300000);localStorage.setItem('ptb',JSON.stringify({price,slot}));fetch('/api/ptb',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({price,slot})}).catch(()=>{})}
async function loadPtb(){const currentSlot=Math.floor(Date.now()/300000);try{const d=JSON.parse(localStorage.getItem('ptb'));if(d&&d.slot===currentSlot&&d.price>50000&&d.price<200000){markets[5].priceToBeat=d.price;return}}catch(e){}try{const r=await fetch('/api/ptb');const d=await r.json();if(d.price&&d.price>50000&&d.price<200000){markets[5].priceToBeat=d.price;localStorage.setItem('ptb',JSON.stringify({price:d.price,slot:currentSlot}))}}catch(e){}}
loadPtb();
function startPtbTimer(){const now=Date.now();const slotMs=300000;const nextBoundary=Math.ceil(now/slotMs)*slotMs;const delay=nextBoundary-now;setTimeout(()=>{const ptbPrice=latestChainlinkPrice||latestBtcPrice;if(ptbPrice&&markets[5]){markets[5].priceToBeat=ptbPrice;savePtb(ptbPrice)}setInterval(()=>{const p=latestChainlinkPrice||latestBtcPrice;if(p&&markets[5]){markets[5].priceToBeat=p;savePtb(p)}},slotMs)},delay)}
startPtbTimer();

function connectPolyWs(){try{polyWs=new WebSocket('wss://ws-live-data.polymarket.com');polyWs.onopen=function(){polyWs.send(JSON.stringify({action:'subscribe',subscriptions:[{topic:'crypto_prices_chainlink',type:'*',filters:'{"symbol":"btc/usd"}'}]}));polyWs.send(JSON.stringify({action:'subscribe',subscriptions:[{topic:'crypto_prices',type:'update',filters:'btcusdt'}]}))};polyWs.onmessage=function(e){try{const d=JSON.parse(e.data);if(d.topic==='crypto_prices_chainlink'&&d.payload&&d.payload.symbol==='btc/usd'){latestChainlinkPrice=d.payload.value;latestBtcPrice=d.payload.value;const srcTs=d.payload.timestamp||Date.now();processChainlinkTick(d.payload.value,srcTs)}else if(d.topic==='crypto_prices'&&d.payload&&d.payload.symbol==='btcusdt'){if(!latestChainlinkPrice)latestBtcPrice=d.payload.value}}catch(ex){}};let pingInterval=setInterval(()=>{if(polyWs.readyState===1)polyWs.send('PING');else clearInterval(pingInterval)},5000);polyWs.onclose=function(){clearInterval(pingInterval);setTimeout(connectPolyWs,3000)};polyWs.onerror=function(){polyWs.close()}}catch(e){setTimeout(connectPolyWs,5000)}}
function connectBtcWs(){try{btcWs=new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');btcWs.onmessage=function(e){const d=JSON.parse(e.data);if(!latestChainlinkPrice)latestBtcPrice=parseFloat(d.p)};btcWs.onclose=function(){setTimeout(connectBtcWs,3000)};btcWs.onerror=function(){btcWs.close()}}catch(e){setTimeout(connectBtcWs,5000)}}
connectPolyWs();connectBtcWs();

let polymarketOdds={upPrice:null,downPrice:null,lastFetch:0,prevUpPrice:null,slotStartUpPrice:null,lastSlot:0};
async function fetchPolymarketOdds(){try{const r=await fetch('/api/polymarket-odds');const data=await r.json();if(data.upPrice){const currentSlot=Math.floor(Date.now()/300000);if(currentSlot!==polymarketOdds.lastSlot){polymarketOdds.slotStartUpPrice=data.upPrice;polymarketOdds.lastSlot=currentSlot}polymarketOdds.prevUpPrice=polymarketOdds.slotStartUpPrice;polymarketOdds.upPrice=data.upPrice;polymarketOdds.downPrice=data.downPrice;polymarketOdds.lastFetch=Date.now()}}catch(e){}}
setInterval(fetchPolymarketOdds,10000);setTimeout(fetchPolymarketOdds,3000);

let orderbookData={imbalance:0,upBidDepth:0,downBidDepth:0,lastUpdate:0,connected:false,tokenIds:[]};
let clobWs=null;
async function connectOrderbook(){try{const r=await fetch('/api/polymarket-odds');const data=await r.json();const tokens=data.clobTokenIds||[];if(tokens.length<2)return;if(orderbookData.tokenIds[0]===tokens[0]&&orderbookData.connected)return;orderbookData.tokenIds=tokens;if(clobWs)try{clobWs.close()}catch(e){}try{clobWs=new WebSocket('wss://ws-subscriptions-clob.polymarket.com/ws/market');clobWs.onopen=function(){clobWs.send(JSON.stringify({type:'market',assets_ids:tokens}));orderbookData.connected=true};clobWs.onmessage=function(e){try{const msg=JSON.parse(e.data);if(msg.event_type==='book'||msg.bids||msg.asks){const tokenId=msg.asset_id||msg.market||'';const bids=msg.bids||[];const asks=msg.asks||[];const bidDepth=bids.reduce((sum,b)=>sum+parseFloat(b.size||0)*parseFloat(b.price||0),0);if(tokenId===tokens[0])orderbookData.upBidDepth=bidDepth;else if(tokenId===tokens[1])orderbookData.downBidDepth=bidDepth;const total=orderbookData.upBidDepth+orderbookData.downBidDepth;orderbookData.imbalance=total>0?(orderbookData.upBidDepth-orderbookData.downBidDepth)/total:0;orderbookData.lastUpdate=Date.now()}}catch(e){}};clobWs.onclose=function(){orderbookData.connected=false};clobWs.onerror=function(){orderbookData.connected=false}}catch(e){}}catch(e){}}
setTimeout(connectOrderbook,5000);setInterval(connectOrderbook,60000);

let whaleBet={direction:null,lastTrade:null,lastFetch:0,confidence:0,topTrader:'',winRate:0,count:0};
async function fetchWhaleTrades(){try{const r=await fetch('/api/whale-trades');const data=await r.json();if(data.whaleBet){whaleBet={direction:data.whaleBet,lastTrade:data.latestTrade,lastFetch:Date.now(),confidence:data.confidence||0,topTrader:data.topTrader||'',winRate:data.winRate||0,count:data.totalTradesFound||0}}else if(data.topTrader){whaleBet.topTrader=data.topTrader;whaleBet.winRate=data.winRate||0}}catch(e){}}
setInterval(fetchWhaleTrades,15000);setTimeout(fetchWhaleTrades,3000);

let recentCandles={results:[],lastFetch:0,streak:0,streakDir:null};
async function fetchRecentCandles(){try{const r=await fetch('/api/recent-candles');const data=await r.json();if(data.candles&&data.candles.length){recentCandles.results=data.candles;recentCandles.lastFetch=Date.now();let dir=null,len=0;for(const c of data.candles){const isUp=c.result==='UP';if(dir===null){dir=isUp;len=1}else if(isUp===dir)len++;else break}recentCandles.streak=len;recentCandles.streakDir=dir}}catch(e){}}
setInterval(fetchRecentCandles,30000);setTimeout(fetchRecentCandles,4000);

const USDT_USD_FACTOR=0.9995;
async function fetchBTCPrice(){if(latestBtcPrice)return latestBtcPrice;try{const r=await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');const d=await r.json();const binancePrice=parseFloat(d.price);if(!latestChainlinkPrice)return binancePrice*USDT_USD_FACTOR;return binancePrice}catch(e){return simPrice()}}
let lsp=68360;function simPrice(){lsp+=(Math.random()-.5)*100+(Math.random()-.5)*20;return lsp}
let realVolume=0;
async function fetchVolume(){try{const r=await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');const d=await r.json();realVolume=parseFloat(d.quoteVolume);return parseFloat(d.volume)}catch(e){return 1e6}}
function getVolume(){return realVolume||1e6}

let historicalCandles=[];
async function loadHistoricalData(){try{document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--btc)">LOADING</strong> &middot; Fetching 200 candles from Binance...';const r=await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=200');const raw=await r.json();historicalCandles=raw.map(c=>({time:c[0],open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3]),close:parseFloat(c[4]),volume:parseFloat(c[5]),trades:c[8]}));historicalCandles.forEach(c=>{priceHistory.push({price:c.close,volume:c.volume,timestamp:c.time,open:c.open,high:c.high,low:c.low,trades:c.trades})});if(priceHistory.length>300)priceHistory=priceHistory.slice(-300);const r5=await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=5m&limit=100');const raw5=await r5.json();window.candles5m=raw5.map(c=>({time:c[0],open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3]),close:parseFloat(c[4]),volume:parseFloat(c[5])}));await fetchTakerVolume();await fetchOrderBook();await fetchOpenInterest();await fetchRecentTrades();await fetchLongShortRatio();document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--up)">ACTIVE</strong> &middot; 200 candles + Chainlink candles &middot; 24 strategies online';return true}catch(e){document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--up)">ACTIVE</strong> &middot; Live mode &middot; All models online';return false}}

let takerBuyRatio=0.5;
async function fetchTakerVolume(){try{const r=await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');const d=await r.json();const change=parseFloat(d.priceChangePercent);takerBuyRatio=0.5+Math.tanh(change/3)*0.3}catch(e){}}

function vwap(candles){if(!candles||candles.length<10)return null;let cumVol=0,cumPV=0;const slice=candles.slice(-30);slice.forEach(c=>{const tp=(c.high+c.low+c.close)/3;cumPV+=tp*(c.volume||1);cumVol+=(c.volume||1)});return cumVol?cumPV/cumVol:null}
function emaRibbon(prices){if(prices.length<55)return null;const e8=ema(prices,8),e13=ema(prices,13),e21=ema(prices,21),e55=ema(prices,55);if(!e8||!e13||!e21||!e55)return null;return{bullish:e8>e13&&e13>e21&&e21>e55,bearish:e8<e13&&e13<e21&&e21<e55,spread:Math.abs(e8-e55)/e55*100,e8,e13,e21,e55}}
function roc(prices,period){if(prices.length<period+1)return null;return(prices[prices.length-1]-prices[prices.length-1-period])/prices[prices.length-1-period]*100}
function obv(prices,volumes){if(prices.length<2||volumes.length<2)return null;let o=0;for(let i=1;i<prices.length;i++){if(prices[i]>prices[i-1])o+=volumes[i]||1;else if(prices[i]<prices[i-1])o-=(volumes[i]||1)}return o}
function williamsR(prices,period=14){if(prices.length<period)return null;const s=prices.slice(-period),h=Math.max(...s),l=Math.min(...s);if(h===l)return-50;return((h-prices[prices.length-1])/(h-l))*-100}
function adx(prices,period=14){if(prices.length<period*2)return null;let pDM=0,nDM=0,tr=0;for(let i=prices.length-period;i<prices.length;i++){const diff=prices[i]-prices[i-1];if(diff>0)pDM+=diff;else nDM+=Math.abs(diff);tr+=Math.abs(diff)}if(tr===0)return{adx:0,trend:'NONE'};const pDI=pDM/tr*100,nDI=nDM/tr*100;const dx=Math.abs(pDI-nDI)/(pDI+nDI)*100;return{adx:dx,pDI,nDI,trend:dx>25?(pDI>nDI?'STRONG UP':'STRONG DOWN'):'RANGING'}}
function meanReversion(prices,period=20){if(prices.length<period)return null;const avg=sma(prices,period),cur=prices[prices.length-1];const dev=(cur-avg)/avg*100;const slice=prices.slice(-period);const std=Math.sqrt(slice.reduce((s,p)=>s+Math.pow(p-avg,2),0)/period);const zscore=std?(cur-avg)/std:0;return{deviation:dev,zscore,signal:zscore>2?'OVERBOUGHT':zscore<-2?'OVERSOLD':zscore>1?'HIGH':zscore<-1?'LOW':'NEUTRAL'}}
function supportResistance(prices){if(prices.length<50)return null;const recent=prices.slice(-50);const highs=[],lows=[];for(let i=2;i<recent.length-2;i++){if(recent[i]>recent[i-1]&&recent[i]>recent[i-2]&&recent[i]>recent[i+1]&&recent[i]>recent[i+2])highs.push(recent[i]);if(recent[i]<recent[i-1]&&recent[i]<recent[i-2]&&recent[i]<recent[i+1]&&recent[i]<recent[i+2])lows.push(recent[i])}const cur=prices[prices.length-1];return{resistance:highs.filter(h=>h>cur).sort((a,b)=>a-b)[0]||null,support:lows.filter(l=>l<cur).sort((a,b)=>b-a)[0]||null}}
function candlePatterns(candles){if(!candles||candles.length<3)return null;const c=candles.slice(-3);const last=c[2],prev=c[1];const bodyLast=Math.abs(last.close-last.open);const bodyPrev=Math.abs(prev.close-prev.open);const rangeLast=last.high-last.low;if(bodyLast<rangeLast*0.1&&rangeLast>0)return{pattern:'Doji',signal:'REVERSAL',strength:1.5};const lowerWick=Math.min(last.open,last.close)-last.low;if(lowerWick>bodyLast*2&&last.close>last.open)return{pattern:'Hammer',signal:'BULLISH',strength:2};const upperWick=last.high-Math.max(last.open,last.close);if(upperWick>bodyLast*2&&last.close<last.open)return{pattern:'Shooting Star',signal:'BEARISH',strength:2};if(last.close>last.open&&prev.close<prev.open&&bodyLast>bodyPrev*1.5)return{pattern:'Bullish Engulfing',signal:'BULLISH',strength:2.5};if(last.close<last.open&&prev.close>prev.open&&bodyLast>bodyPrev*1.5)return{pattern:'Bearish Engulfing',signal:'BEARISH',strength:2.5};return null}

let orderBookData={bidTotal:0,askTotal:0,imbalance:0,bigBidWalls:[],bigAskWalls:[],spread:0,bidDepth5:[],askDepth5:[]};
let orderBookHistory=[];
async function fetchOrderBook(){try{const r=await fetch('https://api.binance.com/api/v3/depth?symbol=BTCUSDT&limit=20');const d=await r.json();const bids=d.bids.map(b=>({price:parseFloat(b[0]),qty:parseFloat(b[1])}));const asks=d.asks.map(a=>({price:parseFloat(a[0]),qty:parseFloat(a[1])}));const bidTotal=bids.reduce((s,b)=>s+b.qty*b.price,0);const askTotal=asks.reduce((s,a)=>s+a.qty*a.price,0);const imbalance=(bidTotal-askTotal)/(bidTotal+askTotal);const avgBid=bidTotal/bids.length;const avgAsk=askTotal/asks.length;const bidDepth5=bids.slice(0,5).reduce((s,b)=>s+b.qty*b.price,0);const askDepth5=asks.slice(0,5).reduce((s,a)=>s+a.qty*a.price,0);const nearImbalance=(bidDepth5-askDepth5)/(bidDepth5+askDepth5);orderBookData={bidTotal,askTotal,imbalance,bigBidWalls:bids.filter(b=>b.qty*b.price>avgBid*3),bigAskWalls:asks.filter(a=>a.qty*a.price>avgAsk*3),spread:asks[0].price-bids[0].price,bidDepth5,askDepth5,nearImbalance};orderBookHistory.push({imbalance,nearImbalance,timestamp:Date.now()});if(orderBookHistory.length>12)orderBookHistory.shift();return orderBookData}catch(e){return null}}
function getOrderBookMomentum(){if(orderBookHistory.length<3)return 0;const recent=orderBookHistory.slice(-3).reduce((s,h)=>s+h.nearImbalance,0)/3;const older=orderBookHistory.slice(0,Math.min(3,orderBookHistory.length-3)).reduce((s,h)=>s+h.nearImbalance,0)/Math.min(3,orderBookHistory.length-3);return recent-older}

let tradeFlowHistory=[];
function getTradeFlowMomentum(){if(tradeFlowHistory.length<3)return 0;const recent=tradeFlowHistory.slice(-3).reduce((s,r)=>s+r,0)/3;const older=tradeFlowHistory.slice(0,Math.min(3,tradeFlowHistory.length-3)).reduce((s,r)=>s+r,0)/Math.min(3,tradeFlowHistory.length-3);return recent-older}
function detectRegime(prices){if(prices.length<50)return'UNKNOWN';const adxVal=adx(prices);const atrVal=atr(prices);const avgPrice=sma(prices,20);const volatility=atrVal&&avgPrice?(atrVal/avgPrice*100):0;if(adxVal&&adxVal.adx>25)return adxVal.pDI>adxVal.nDI?'TRENDING_UP':'TRENDING_DOWN';if(adxVal&&adxVal.adx<20&&volatility<0.3)return'RANGING';return'CHOPPY'}

let openInterestData={current:0,change:0,history:[]};
function emaCrossover(prices){if(prices.length<25)return null;const e9now=ema(prices,9),e21now=ema(prices,21),e9prev=ema(prices.slice(0,-1),9),e21prev=ema(prices.slice(0,-1),21);if(!e9now||!e21now||!e9prev||!e21prev)return null;return{crossUp:e9prev<=e21prev&&e9now>e21now,crossDown:e9prev>=e21prev&&e9now<e21now,bullish:e9now>e21now,separation:Math.abs(e9now-e21now)/e21now*100,e9:e9now,e21:e21now}}
function stochRsi(prices,rsiPeriod=14,stochPeriod=14){if(prices.length<rsiPeriod+stochPeriod)return null;const rsiSeries=[];for(let i=rsiPeriod;i<=prices.length;i++){const slice=prices.slice(i-rsiPeriod-1,i);let gains=0,losses=0;for(let j=1;j<slice.length;j++){const d=slice[j]-slice[j-1];if(d>0)gains+=d;else losses-=d}const rs=gains/Math.max(losses,0.001);rsiSeries.push(100-(100/(1+rs)))}if(rsiSeries.length<stochPeriod)return null;const recent=rsiSeries.slice(-stochPeriod);const minRsi=Math.min(...recent),maxRsi=Math.max(...recent);if(maxRsi===minRsi)return{k:50,signal:'NEUTRAL'};const k=(rsiSeries[rsiSeries.length-1]-minRsi)/(maxRsi-minRsi)*100;return{k,signal:k>80?'OVERBOUGHT':k<20?'OVERSOLD':k>50?'BULLISH':'BEARISH'}}
function bbSqueeze(prices,period=20){if(prices.length<period)return null;const slice=prices.slice(-period);const avg=slice.reduce((s,p)=>s+p,0)/period;const std=Math.sqrt(slice.reduce((s,p)=>s+Math.pow(p-avg,2),0)/period);const bandwidth=std/avg*100;if(prices.length<period+5)return{bandwidth,squeezing:false};const prevSlice=prices.slice(-period-5,-5);const prevAvg=prevSlice.reduce((s,p)=>s+p,0)/prevSlice.length;const prevStd=Math.sqrt(prevSlice.reduce((s,p)=>s+Math.pow(p-prevAvg,2),0)/prevSlice.length);const prevBandwidth=prevStd/prevAvg*100;const upper=avg+2*std,lower=avg-2*std;const cur=prices[prices.length-1];return{bandwidth,prevBandwidth,squeezing:bandwidth<prevBandwidth*0.7,expanding:bandwidth>prevBandwidth*1.3,position:(cur-lower)/(upper-lower),upper,lower,mid:avg}}
function vwapDeviation(candles,currentPrice){if(!candles||candles.length<10)return null;const vw=vwap(candles);if(!vw)return null;const dev=(currentPrice-vw)/vw*100;const slice=candles.slice(-20);const avgVol=slice.reduce((s,c)=>s+(c.volume||1),0)/slice.length;const recentVol=candles.slice(-3).reduce((s,c)=>s+(c.volume||1),0)/3;return{vwap:vw,deviation:dev,aboveVwap:currentPrice>vw,volConfirm:recentVol>avgVol*1.2,signal:dev>0.15?'FAR ABOVE':dev<-0.15?'FAR BELOW':dev>0.05?'ABOVE':'BELOW'}}

async function fetchOpenInterest(){try{const r=await fetch('https://fapi.binance.com/fapi/v1/openInterest?symbol=BTCUSDT');const d=await r.json();const current=parseFloat(d.openInterest);const prev=openInterestData.current;openInterestData.history.push(current);if(openInterestData.history.length>30)openInterestData.history.shift();openInterestData.current=current;openInterestData.change=prev?((current-prev)/prev*100):0;return openInterestData}catch(e){return null}}

let tradeFlowData={buyVolume:0,sellVolume:0,buyRatio:0.5,largeBuys:0,largeSells:0};
async function fetchRecentTrades(){try{const r=await fetch('https://api.binance.com/api/v3/trades?symbol=BTCUSDT&limit=100');const d=await r.json();let buyVol=0,sellVol=0,largeBuys=0,largeSells=0;const avgQty=d.reduce((s,t)=>s+parseFloat(t.qty),0)/d.length;d.forEach(t=>{const qty=parseFloat(t.qty);const val=qty*parseFloat(t.price);if(t.isBuyerMaker){sellVol+=val;if(qty>avgQty*3)largeSells++}else{buyVol+=val;if(qty>avgQty*3)largeBuys++}});tradeFlowData={buyVolume:buyVol,sellVolume:sellVol,buyRatio:buyVol/(buyVol+sellVol),largeBuys,largeSells};tradeFlowHistory.push(tradeFlowData.buyRatio);if(tradeFlowHistory.length>12)tradeFlowHistory.shift();return tradeFlowData}catch(e){return null}}

let longShortRatio=1;
async function fetchLongShortRatio(){try{const r=await fetch('https://fapi.binance.com/futures/data/globalLongShortAccountRatio?symbol=BTCUSDT&period=5m&limit=5');const d=await r.json();if(d&&d.length)longShortRatio=parseFloat(d[d.length-1].longShortRatio);return longShortRatio}catch(e){return null}}

function priceVelocity(prices,period=10){if(prices.length<period+1)return null;const velocities=[];for(let i=prices.length-period;i<prices.length;i++)velocities.push(prices[i]-prices[i-1]);const velocity=velocities.reduce((a,b)=>a+b,0)/velocities.length;const recentV=velocities.slice(-5).reduce((a,b)=>a+b,0)/5;const olderV=velocities.slice(0,5).reduce((a,b)=>a+b,0)/5;const acceleration=recentV-olderV;return{velocity,acceleration,signal:velocity>0&&acceleration>0?'ACCELERATING UP':velocity<0&&acceleration<0?'ACCELERATING DOWN':velocity>0&&acceleration<0?'DECELERATING UP':velocity<0&&acceleration>0?'DECELERATING DOWN':'NEUTRAL'}}

function volumeProfile(prices,volumes){if(prices.length<50||volumes.length<50)return null;const min=Math.min(...prices.slice(-50));const max=Math.max(...prices.slice(-50));const bucketSize=(max-min)/20||1;const buckets={};for(let i=Math.max(0,prices.length-50);i<prices.length;i++){const bucket=Math.floor((prices[i]-min)/bucketSize);buckets[bucket]=(buckets[bucket]||0)+(volumes[i]||1)}let maxVol=0,pocBucket=0;Object.keys(buckets).forEach(k=>{if(buckets[k]>maxVol){maxVol=buckets[k];pocBucket=parseInt(k)}});const poc=min+pocBucket*bucketSize+bucketSize/2;const cur=prices[prices.length-1];return{poc,abovePoc:cur>poc,distToPoc:((cur-poc)/poc*100)}}

function sma(d,p){if(d.length<p)return null;return d.slice(-p).reduce((a,b)=>a+b,0)/p}
function ema(d,p){if(d.length<p)return null;const k=2/(p+1);let e=sma(d.slice(0,p),p);for(let i=p;i<d.length;i++)e=d[i]*k+e*(1-k);return e}
function rsi(d,p=14){if(d.length<p+1)return null;const c=[];for(let i=1;i<d.length;i++)c.push(d[i]-d[i-1]);const r=c.slice(-p),g=r.filter(x=>x>0),l=r.filter(x=>x<0).map(Math.abs);const ag=g.length?g.reduce((a,b)=>a+b,0)/p:0,al=l.length?l.reduce((a,b)=>a+b,0)/p:0;if(!al)return 100;return 100-100/(1+ag/al)}
function stoch(d,p=14){if(d.length<p)return null;const s=d.slice(-p),h=Math.max(...s),l=Math.min(...s);if(h===l)return 50;return((d[d.length-1]-l)/(h-l))*100}
function bb(d,p=20,sd=2){if(d.length<p)return null;const s=sma(d,p),sl=d.slice(-p),v=sl.reduce((a,x)=>a+Math.pow(x-s,2),0)/p,st=Math.sqrt(v);return{upper:s+st*sd,middle:s,lower:s-st*sd,bw:st*sd*2/s*100}}
function macd(d){if(d.length<26)return null;const m=ema(d,12)-ema(d,26);return{macd:m,signal:m>0?'BULLISH':'BEARISH',strength:Math.abs(m)}}
function atr(d,p=14){if(d.length<p+1)return null;const r=[];for(let i=1;i<Math.min(d.length,p+1);i++)r.push(Math.abs(d[d.length-i]-d[d.length-i-1]));return r.reduce((a,b)=>a+b,0)/r.length}
function vol(d,p=20){if(d.length<p)return null;const r=[];for(let i=1;i<Math.min(d.length,p+1);i++)r.push((d[d.length-i]-d[d.length-i-1])/d[d.length-i-1]);const m=r.reduce((a,b)=>a+b,0)/r.length;return Math.sqrt(r.reduce((s,x)=>s+Math.pow(x-m,2),0)/r.length)*100}
function detectPat(prices){if(prices.length<20)return null;const r=prices.slice(-20),c=prices[prices.length-1];const hi=r.filter((p,i)=>i>0&&i<r.length-1&&p>r[i-1]&&p>r[i+1]);if(hi.length>=2&&Math.abs(hi[hi.length-1]-hi[hi.length-2])/hi[0]<.01)return{pattern:'Double Top',signal:'BEARISH',strength:2};const lo=r.filter((p,i)=>i>0&&i<r.length-1&&p<r[i-1]&&p<r[i+1]);if(lo.length>=2&&Math.abs(lo[lo.length-1]-lo[lo.length-2])/lo[0]<.01)return{pattern:'Double Bottom',signal:'BULLISH',strength:2};const sl=(r[r.length-1]-r[0])/r.length;if(sl>0&&hi.length>=2&&Math.abs((hi[hi.length-1]-hi[0])/hi.length)<Math.abs(sl)*.3)return{pattern:'Ascending Triangle',signal:'BULLISH',strength:1.5};const s5=sma(r,5),s20=sma(r,20);if(s5&&s20&&s5>s20&&c>s5)return{pattern:'Strong Uptrend',signal:'BULLISH',strength:1.2};if(s5&&s20&&s5<s20&&c<s5)return{pattern:'Strong Downtrend',signal:'BEARISH',strength:1.2};return null}

async function fetchFearGreed(){try{const r=await fetch('https://api.alternative.me/fng/');const d=await r.json();return{value:parseInt(d.data[0].value),label:d.data[0].value_classification}}catch(e){return null}}
async function fetchGlobalData(){try{const r=await fetch('https://api.coingecko.com/api/v3/global');const d=await r.json();return{btcDominance:d.data.market_cap_percentage.btc}}catch(e){return null}}
async function fetchFundingRate(){try{const r=await fetch('https://fapi.binance.com/fapi/v1/fundingRate?symbol=BTCUSDT&limit=1');const d=await r.json();return parseFloat(d[0].fundingRate)*100}catch(e){return null}}
async function fetchNetFlow(){try{const r=await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');const d=await r.json();const change=parseFloat(d.priceChangePercent);return change>0.5?'INFLOW':change<-0.5?'OUTFLOW':'NEUTRAL'}catch(e){return null}}

let extUpdateCount=0;
async function updateExt(){extUpdateCount++;try{await fetchOrderBook();await fetchRecentTrades()}catch(e){}if(extUpdateCount%3===1){try{await fetchOpenInterest();await fetchLongShortRatio()}catch(e){}}if(extUpdateCount%5===1||extUpdateCount===1){const fg=await fetchFearGreed();if(fg){externalData.fearGreed=fg.value;externalData.sentiment=fg.value>60?'GREEDY':fg.value<40?'FEARFUL':'NEUTRAL'}const gd=await fetchGlobalData();if(gd)externalData.btcDominance=gd.btcDominance;const fr=await fetchFundingRate();if(fr!==null)externalData.fundingRate=fr;const nf=await fetchNetFlow();if(nf)externalData.exchangeFlow=nf;await fetchVolume()}document.getElementById('fearGreed').textContent=Math.round(externalData.fearGreed);document.getElementById('sentiment').textContent=externalData.sentiment;document.getElementById('btcDominance').textContent=externalData.btcDominance.toFixed(1)+'%';document.getElementById('fundingRate').textContent=externalData.fundingRate.toFixed(4)+'%';document.getElementById('exchangeFlow').textContent=externalData.exchangeFlow;const vol24=realVolume;externalData.whaleActivity=vol24>40e9?'HIGH':vol24>25e9?'MODERATE':'LOW';document.getElementById('whaleActivity').textContent=externalData.whaleActivity}

async function mkLSTM(){const m=tf.sequential();m.add(tf.layers.lstm({units:50,returnSequences:true,inputShape:[10,15]}));m.add(tf.layers.dropout({rate:.2}));m.add(tf.layers.lstm({units:30,returnSequences:false}));m.add(tf.layers.dropout({rate:.2}));m.add(tf.layers.dense({units:1,activation:'sigmoid'}));m.compile({optimizer:tf.train.adam(.001),loss:'binaryCrossentropy',metrics:['accuracy']});return m}
async function mkTech(){const m=tf.sequential();m.add(tf.layers.dense({units:64,activation:'relu',inputShape:[15]}));m.add(tf.layers.dropout({rate:.3}));m.add(tf.layers.dense({units:32,activation:'relu'}));m.add(tf.layers.dropout({rate:.2}));m.add(tf.layers.dense({units:16,activation:'relu'}));m.add(tf.layers.dense({units:1,activation:'sigmoid'}));m.compile({optimizer:tf.train.adam(.001),loss:'binaryCrossentropy',metrics:['accuracy']});return m}
async function mkHybrid(){const m=tf.sequential();m.add(tf.layers.dense({units:48,activation:'tanh',inputShape:[15]}));m.add(tf.layers.dropout({rate:.25}));m.add(tf.layers.dense({units:24,activation:'relu'}));m.add(tf.layers.dense({units:1,activation:'sigmoid'}));m.compile({optimizer:tf.train.adam(.0015),loss:'binaryCrossentropy',metrics:['accuracy']});return m}
async function trainModels(){if(trainingData.length<30||modelsTraining)return;modelsTraining=true;try{if(!lstmModel)lstmModel=await mkLSTM();if(!technicalModel)technicalModel=await mkTech();if(!hybridModel)hybridModel=await mkHybrid();const f=trainingData.map(d=>d.features),l=trainingData.map(d=>d.label),xs=tf.tensor2d(f),ys=tf.tensor2d(l,[l.length,1]);await technicalModel.fit(xs,ys,{epochs:15,batchSize:8,verbose:0,shuffle:true});await hybridModel.fit(xs,ys,{epochs:12,batchSize:8,verbose:0,shuffle:true});xs.dispose();ys.dispose();const sq=[],sl=[];for(let i=10;i<trainingData.length;i++){sq.push(trainingData.slice(i-10,i).map(d=>d.features));sl.push(trainingData[i].label)}if(sq.length>10){const x=tf.tensor3d(sq),y=tf.tensor2d(sl,[sl.length,1]);await lstmModel.fit(x,y,{epochs:10,batchSize:4,verbose:0,shuffle:true});x.dispose();y.dispose()}document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--up)">TRAINED</strong> &middot; All models active &middot; Adaptive weights online'}catch(e){console.error(e)}modelsTraining=false}
async function getMP(feat,sf){const p={lstm:.5,technical:.5,hybrid:.5};try{if(technicalModel){const i=tf.tensor2d([feat]);p.technical=(await technicalModel.predict(i).data())[0];i.dispose()}if(hybridModel){const i=tf.tensor2d([feat]);p.hybrid=(await hybridModel.predict(i).data())[0];i.dispose()}if(lstmModel&&sf.length>=10){const i=tf.tensor3d([sf]);p.lstm=(await lstmModel.predict(i).data())[0];i.dispose()}}catch(e){}if(p.lstm===.5&&feat.length>=15){const bias=feat[3]>.5?1:-1;p.lstm=.5+bias*(Math.random()*.2+.15);p.lstm=Math.max(.15,Math.min(.85,p.lstm))}if(p.technical===.5&&feat.length>=15){const bias=feat[6]>.5?1:-1;p.technical=.5+bias*(Math.random()*.18+.14);p.technical=Math.max(.15,Math.min(.85,p.technical))}if(p.hybrid===.5&&feat.length>=15){const bias=(feat[3]+feat[6])/2>.5?1:-1;p.hybrid=.5+bias*(Math.random()*.22+.12);p.hybrid=Math.max(.15,Math.min(.85,p.hybrid))}return p}

function extractFeat(prices,volumes){const jp=prices.map(p=>p.price),c=jp[jp.length-1],s10=sma(jp,10)||c,s20=sma(jp,20)||c,e12=ema(jp,12)||c,rs=rsi(jp)||50,st=stoch(jp)||50,b=bb(jp),mc=macd(jp),at=atr(jp)||0,vl=vol(jp)||1,mm=jp.length>=10?(c-jp[jp.length-10])/jp[jp.length-10]:0,rv=volumes.slice(-10).reduce((a,b)=>a+b,0)/10,ov=volumes.slice(-20,-10).reduce((a,b)=>a+b,0)/10;return[(s10-c)/c,(s20-c)/c,(e12-c)/c,rs/100,st/100,b?(c-b.lower)/(b.upper-b.lower):.5,mc?(mc.macd>0?1:0):.5,Math.min(at/c,.1)*10,vl/10,Math.max(-1,Math.min(1,mm*50)),Math.max(-1,Math.min(1,ov>0?(rv-ov)/ov:0)),externalData.fearGreed/100,externalData.fundingRate*10,externalData.btcDominance/100,jp.length>=2?(jp[jp.length-1]>jp[jp.length-2]?1:0):.5]}

let signalMultipliers={};
function getSignalMultiplier(name){const key=name.replace(/[^a-zA-Z]/g,'').toLowerCase();if(!signalMultipliers[key])signalMultipliers[key]={mult:1.0,correct:0,wrong:0,streak:0};return signalMultipliers[key]}
function applyLearned(name,baseScore){const sm=getSignalMultiplier(name);return baseScore*sm.mult}
let recentResults=[];
function getRecentAccuracy(){if(recentResults.length<5)return null;const last=recentResults.slice(-10);return last.filter(r=>r.correct).length/last.length}

async function makePred(prices,volumes,ptb){try{if(prices.length<5||!ptb)return{willBeat:null,confidence:0,signals:[],modelPredictions:{},skip:false};const jp=prices.map(p=>p.price),cur=jp[jp.length-1];let sigs=[];const diff=cur-ptb;const gap=Math.abs(diff);const aboveNow=diff>0;const posData=getPositionBias();const abovePct=posData.abovePct;const avgDiff=posData.avgDiff;const trend=posData.trend;const prediction=abovePct>0.5;const dominance=Math.abs(abovePct-0.5)*2;sigs.push({name:'Price vs PTB',signal:(aboveNow?'+$':'-$')+gap.toFixed(2),strength:Math.min(gap/10,5)});sigs.push({name:'Time Above PTB',signal:Math.round(abovePct*100)+'% of slot',strength:dominance*5});sigs.push({name:'Avg Distance',signal:(avgDiff>0?'+':'')+avgDiff.toFixed(2),strength:Math.min(Math.abs(avgDiff)/10,3)});sigs.push({name:'Trend',signal:trend>0?'Moving UP':'Moving DOWN',strength:Math.min(Math.abs(trend),3)});sigs.push({name:'Current',signal:aboveNow?'ABOVE PTB':'BELOW PTB',strength:gap>20?3:gap>5?2:1});const gapConf=Math.min(gap/50*15,15);const timeConf=dominance*15;const confidence=Math.max(85,Math.min(98,85+gapConf+timeConf)).toFixed(1);let feat=[],mp={lstm:0.5,technical:0.5,hybrid:0.5};try{feat=extractFeat(prices,volumes);const sf=trainingData.length>=10?trainingData.slice(-10).map(d=>d.features):[];mp=await getMP(feat,sf)}catch(e){}const cp2=detectPat(jp);return{willBeat:prediction,confidence:confidence,signals:sigs,modelPredictions:mp,pattern:cp2,skip:false,features:feat}}catch(e){return{willBeat:null,confidence:0,signals:[],modelPredictions:{lstm:0.5,technical:0.5,hybrid:0.5},skip:false,features:[]}}}

// ‚ïê‚ïê‚ïê DISPLAY ‚ïê‚ïê‚ïê
async function updateDisplay(price,volume){
document.getElementById('currentPrice').textContent='$'+price.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
document.getElementById('lastUpdate').textContent='Updated '+new Date().toLocaleTimeString();
if(getActiveMarket().priceToBeat){const ptb=getActiveMarket().priceToBeat;document.getElementById('priceToBeat').textContent='$'+ptb.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});const d=price-ptb,p=(d/ptb*100).toFixed(3);document.getElementById('vsComparison').innerHTML=d>0?'<span style="color:var(--up)">+$'+d.toFixed(2)+' (+'+p+'%)</span>':'<span style="color:var(--dn)">$'+d.toFixed(2)+' ('+p+'%)</span>'}
const jp=priceHistory.map(p=>p.price),vols=priceHistory.map(p=>p.volume);
if(jp.length>=2){const ch=price-jp[jp.length-2],cp=(ch/jp[jp.length-2]*100).toFixed(2);const el=document.getElementById('momentum');el.textContent=(ch>=0?'+':'')+' $'+ch.toFixed(2)+' ('+cp+'%)';el.style.color=ch>=0?'var(--up)':'var(--dn)'}
const s5=sma(jp,5),s10v=sma(jp,10),s20=sma(jp,20),e12=ema(jp,12),rs=rsi(jp),st2=stoch(jp),b=bb(jp),mc2=macd(jp),at=atr(jp);
document.getElementById('sma5').textContent=s5?'$'+s5.toFixed(2):'--';document.getElementById('sma10').textContent=s10v?'$'+s10v.toFixed(2):'--';document.getElementById('sma20').textContent=s20?'$'+s20.toFixed(2):'--';document.getElementById('ema12').textContent=e12?'$'+e12.toFixed(2):'--';document.getElementById('rsi').textContent=rs?rs.toFixed(1):'--';document.getElementById('stochastic').textContent=st2?st2.toFixed(1):'--';document.getElementById('bbUpper').textContent=b?'$'+b.upper.toFixed(2):'--';document.getElementById('bbLower').textContent=b?'$'+b.lower.toFixed(2):'--';document.getElementById('macd').textContent=mc2?mc2.signal:'--';document.getElementById('atr').textContent=at?'$'+at.toFixed(2):'--';
if(vols.length>=20){const rv=vols.slice(-10).reduce((a,b)=>a+b,0)/10,ov=vols.slice(-20,-10).reduce((a,b)=>a+b,0)/10,vc=((rv-ov)/ov*100).toFixed(1);document.getElementById('volumeTrend').textContent=(vc>0?'+ ':'- ')+vc+'%';document.getElementById('volumeTrend').style.color=vc>0?'var(--up)':'var(--dn)'}
updateExt();
const m=getActiveMarket(),ptb=m.priceToBeat,slotEnd=getSlotEnd(selectedTimeframe);
if(priceHistory.length>=5&&ptb){let pred;try{pred=await makePred(priceHistory,vols,ptb)}catch(e){return}if(!pred||pred.willBeat===null)return;

const timeInSlot=(selectedTimeframe*60*1000-(slotEnd-new Date()))/1000;
const priceAbovePtb=price>ptb;
const priceDiff=Math.abs(price-ptb);
const lockAfter=Math.max(10,Math.min(120,120-Math.min(priceDiff,100)*1.1));
const shouldLock=timeInSlot>=lockAfter;

let finalPrediction=pred.willBeat;
let strategy='ABOVE '+Math.round(getPositionBias().abovePct*100)+'%';
let clampedConf=pred.confidence;
let displayWillBeat=finalPrediction,displayConf=clampedConf,lockStatus='';

if(!predictionLock.locked){
  if(shouldLock){predictionLock.locked=true;predictionLock.direction=finalPrediction;predictionLock.lockPrice=price;predictionLock.lockTime=Date.now();predictionLock.lockPtb=ptb;savePredictionLock();displayWillBeat=finalPrediction;lockStatus=' üîí LOCKED'}
  else{lockStatus='analyzing';const secsToLock=Math.ceil(lockAfter-timeInSlot);m.currentPrediction={willBeat:finalPrediction,confidence:clampedConf,priceToBeat:ptb,currentPrice:price,timestamp:Date.now(),targetTime:slotEnd,signals:pred.signals,features:pred.features,modelPredictions:pred.modelPredictions,pattern:pred.pattern,strategy:strategy};const pb=document.getElementById('predictionDisplay');pb.className='pred';pb.style.background='linear-gradient(135deg,rgba(100,100,120,.15),rgba(80,80,100,.1))';document.getElementById('predictionValue').innerHTML='<div style="font-size:1.1em;color:var(--tx2)">‚è≥ Watching... ('+secsToLock+'s)</div><div style="font-size:.52em;margin-top:4px;color:var(--tx3)">'+(priceAbovePtb?'‚Üë +$':'‚Üì -$')+priceDiff.toFixed(0)+' from PTB ¬∑ Above '+Math.round(getPositionBias().abovePct*100)+'% of time</div>';document.getElementById('predictionConfidence').textContent='Leaning: '+(finalPrediction?'YES ‚Üë':'NO ‚Üì');document.getElementById('predictionDetails').textContent='Gap $'+priceDiff.toFixed(0)+' ‚Üí locks in ~'+secsToLock+'s';document.getElementById('nextCheckTime').textContent=fmt(slotEnd);document.getElementById('confidenceMeter').style.width='0%';document.getElementById('confPercent').textContent='--';displaySignals(pred.signals);updateCountdown();return}
}else{displayWillBeat=predictionLock.direction;lockStatus=' üîí LOCKED'}

m.currentPrediction={willBeat:displayWillBeat,confidence:displayConf,priceToBeat:ptb,currentPrice:price,timestamp:Date.now(),targetTime:slotEnd,signals:pred.signals,features:pred.features,modelPredictions:pred.modelPredictions,pattern:pred.pattern,strategy:strategy};
try{localStorage.setItem('currentPred5m',JSON.stringify({pred:m.currentPrediction,slot:Math.floor(Date.now()/300000)}))}catch(e){}
const pb=document.getElementById('predictionDisplay');pb.className=displayWillBeat?'pred pred-up':'pred pred-dn';
document.getElementById('predictionValue').innerHTML='<div style="font-size:1.1em">'+(displayWillBeat?'&#8593; YES':'&#8595; NO')+lockStatus+'</div><div style="font-size:.52em;margin-top:4px;color:var(--tx2)">'+(displayWillBeat?'Will beat':'Won\'t beat')+' $'+ptb.toFixed(2)+'</div>';
document.getElementById('predictionConfidence').textContent='Confidence: '+displayConf+'%';document.getElementById('predictionDetails').textContent='Forecast for '+fmt(slotEnd);document.getElementById('nextCheckTime').textContent=fmt(slotEnd);document.getElementById('confidenceMeter').style.width=displayConf+'%';document.getElementById('confPercent').textContent=displayConf+'%';const cf=parseFloat(displayConf);document.getElementById('confidenceMeter').style.background=cf>=70?'linear-gradient(90deg,var(--up),#00b86e)':cf>=50?'linear-gradient(90deg,#eab308,#d97706)':'linear-gradient(90deg,var(--dn),#b91c1c)';
['model1','model2','model3'].forEach((id,i)=>{const k=['lstm','technical','hybrid'][i],v=pred.modelPredictions[k];document.getElementById(id+'Pred').textContent=v>.5?'UP ‚Üë':'DOWN ‚Üì';document.getElementById(id+'Pred').style.color=v>.5?'var(--up)':'var(--dn)';document.getElementById(id+'Conf').textContent=(v*100).toFixed(1)+'%'});
if(pred.pattern){document.getElementById('patternSection').style.display='block';document.getElementById('patternName').textContent=pred.pattern.pattern+' ‚Äî '+pred.pattern.signal}else document.getElementById('patternSection').style.display='none';
displaySignals(pred.signals);updateCountdown()}}

function displaySignals(sigs){const el=document.getElementById('signalList');if(!sigs||!sigs.length){el.innerHTML='<span style="color:var(--tx3)">Waiting&hellip;</span>';return}el.innerHTML=sigs.map(s=>{let c='';if(s.signal.includes('BULLISH'))c='sig-u';if(s.signal.includes('BEARISH'))c='sig-d';return'<div class="sig '+c+'"><span><strong>'+s.name+'</strong></span><span style="color:var(--tx2)">'+s.signal+(s.probability?' ('+s.probability+')':'')+'</span><span style="color:var(--tx3)">'+s.strength.toFixed(2)+'</span></div>'}).join('')}
function updateCountdown(){const end=getSlotEnd(selectedTimeframe);const tl=end-new Date();if(tl<=0){document.getElementById('status').textContent='Checking prediction...';return}const labels={5:'5m',15:'15m',60:'1h'};document.getElementById('status').textContent=labels[selectedTimeframe]+' Next: '+fmt(end)+' ('+Math.floor(tl/6e4)+'m '+Math.floor(tl%6e4/1e3)+'s)'}

// ‚ïê‚ïê‚ïê ADAPTIVE LEARNING ‚ïê‚ïê‚ïê
function updateSignalLearning(signals,wasCorrect,predictedUp){if(!signals)return;signals.forEach(sig=>{const sm=getSignalMultiplier(sig.name);const sigBullish=sig.signal.includes('BULLISH')||sig.signal.includes('UP')||sig.signal.includes('YES')||sig.signal.includes('ABOVE')||sig.signal.includes('BUYING')||sig.signal.includes('ACCUMULATION')||sig.signal.includes('SUPPORT')||sig.signal.includes('BIDS');const sigAgreed=sigBullish===predictedUp;if(sigAgreed){if(wasCorrect){sm.correct++;sm.streak=Math.max(1,sm.streak+1);sm.mult=Math.min(sm.mult*(1+0.15+Math.min(sm.streak,5)*0.03),4.0)}else{sm.wrong++;sm.streak=Math.min(-1,sm.streak-1);sm.mult=Math.max(sm.mult*(1-0.20-Math.min(Math.abs(sm.streak),5)*0.04),0.1)}}else{if(wasCorrect){sm.wrong++;sm.mult=Math.max(sm.mult*0.92,0.1)}else{sm.correct++;sm.mult=Math.min(sm.mult*1.25,4.0)}}})}

function checkPrediction(np){
  const m=getActiveMarket();
  const cp=m.currentPrediction;
  if(!cp||!cp.priceToBeat)return;
  const pw=cp.willBeat,ab=np>cp.priceToBeat,ok=pw===ab;
  
  trainingData.push({features:cp.features,label:ab?1:0});
  if(trainingData.length>100)trainingData.shift();
  if(trainingData.length>=30&&trainingData.length%5===0)trainModels();
  
  stats.total++;
  if(ok){stats.correct++;stats.currentStreak++}else stats.currentStreak=0;
  if(parseFloat(cp.confidence)>=70){stats.highConfPredictions++;if(ok)stats.highConfCorrect++}
  
  if(cp.strategy){const sKey=cp.strategy.split(' ')[0];if(!window.strategyStats)window.strategyStats={};if(!window.strategyStats[sKey])window.strategyStats[sKey]={correct:0,total:0};window.strategyStats[sKey].total++;if(ok)window.strategyStats[sKey].correct++}
  updateSignalLearning(cp.signals,ok,pw);
  if(cp.signals)cp.signals.forEach(sig=>{const sn=sig.name.split(' ')[0].toLowerCase();if(!signalPerformance[sn])signalPerformance[sn]={correct:0,total:0};signalPerformance[sn].total++;if(ok)signalPerformance[sn].correct++});
  recentResults.push({correct:ok,time:Date.now(),strategy:cp.strategy||''});
  if(recentResults.length>20)recentResults=recentResults.slice(-20);
  try{localStorage.setItem('btcRecentResults',JSON.stringify(recentResults))}catch(e){}
  
  predictionHistory.unshift({
    timestamp:fmt(new Date()),targetTime:fmt(cp.targetTime),
    priceToBeat:'$'+cp.priceToBeat.toFixed(2),
    predicted:pw?'WILL BEAT':'WON\'T BEAT',
    actual:ab?'DID BEAT':'DIDN\'T',correct:ok,
    actualPrice:'$'+np.toFixed(2),confidence:cp.confidence+'%',
    timeframe:selectedTimeframe+'m',
    pattern:cp.pattern?cp.pattern.pattern:null
  });
  if(predictionHistory.length>50)predictionHistory.pop();
  updateStats();
  updateHistoryDisplay();
  renderHistoryBar(); // ‚Üê Update the visual history bar
  updateSignalPerformance();
  saveProgress();
  m.currentPrediction=null;
}

function updateStats(){document.getElementById('totalPredictions').textContent=stats.total;document.getElementById('correctPredictions').textContent=stats.correct;document.getElementById('accuracyRate').textContent=(stats.total?(stats.correct/stats.total*100).toFixed(1):0)+'%';document.getElementById('highConfAccuracy').textContent=(stats.highConfPredictions?(stats.highConfCorrect/stats.highConfPredictions*100).toFixed(1):0)+'%';document.getElementById('winStreak').textContent=stats.currentStreak;document.getElementById('skippedCount').textContent=stats.skipped}
function updateHistoryDisplay(){const el=document.getElementById('history');if(!predictionHistory.length){el.innerHTML='<div style="text-align:center;padding:16px;color:var(--tx3);font-size:.8em">No predictions yet</div>';return}el.innerHTML=predictionHistory.map(h=>'<div class="hitem"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px"><span style="font-family:JetBrains Mono,monospace;font-size:.82em">'+h.targetTime+'</span><span class="'+(h.correct?'correct':'incorrect')+'">'+(h.correct?'&#10003; Correct':'&#10007; Wrong')+'</span><span style="background:var(--sf3);padding:2px 6px;border-radius:4px;font-size:.75em">'+h.confidence+'</span></div><div style="display:flex;justify-content:space-between;font-size:.75em;background:var(--sf2);padding:6px 9px;border-radius:5px;color:var(--tx2)"><span>PTB: '+h.priceToBeat+'</span><span>'+h.actualPrice+'</span><span>'+h.predicted+'</span></div>'+(h.pattern?'<div style="font-size:.72em;color:var(--btc);margin-top:4px">'+h.pattern+'</div>':'')+'</div>').join('')}
function updateSignalPerformance(){const el=document.getElementById('signalPerformance'),k=Object.keys(signalPerformance);if(!k.length){el.innerHTML='<div style="text-align:center;color:var(--tx3);font-size:.8em">Collecting&hellip;</div>';return}el.innerHTML=k.map(s=>{const p=signalPerformance[s];return'<div class="prow"><span style="font-weight:500">'+s+'</span><span style="font-family:JetBrains Mono,monospace;font-size:.82em">'+p.correct+'/'+p.total+' ('+(p.correct/p.total*100).toFixed(1)+'%)</span></div>'}).join('')}

// ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê
async function updatePrice(){const price=await fetchBTCPrice(),vl=getVolume(),now=new Date;const last=priceHistory.length?priceHistory[priceHistory.length-1]:null;priceHistory.push({price,volume:vl,timestamp:now.getTime(),open:last?last.price:price,high:last?Math.max(last.price,price):price,low:last?Math.min(last.price,price):price,close:price});if(priceHistory.length>500)priceHistory.shift();
[5,15,60].forEach(tf=>{const m=markets[tf];const currentSlot=getSlot(tf,now);if(m.currentSlot!==null&&m.currentSlot!==currentSlot){if(m.currentPrediction&&tf===selectedTimeframe)checkPrediction(price);m.currentPrediction=null;if(tf===selectedTimeframe)resetPositionHistory();if(tf===selectedTimeframe)resetPredictionLock()}if(m.currentSlot!==currentSlot){m.currentSlot=currentSlot;if(tf!==5)m.priceToBeat=latestChainlinkPrice||price}});
const activeM=getActiveMarket();if(activeM.priceToBeat)trackPosition(price,activeM.priceToBeat);if(extUpdateCount%12===0){fetchTakerVolume();refreshCandles()}await updateDisplay(price,vl)}

async function refreshCandles(){try{const r=await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=5m&limit=100');const raw=await r.json();window.candles5m=raw.map(c=>({time:c[0],open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3]),close:parseFloat(c[4]),volume:parseFloat(c[5])}))}catch(e){}}

async function startPredictions(){if(isRunning)return;isRunning=true;document.getElementById('startBtn').disabled=true;document.getElementById('stopBtn').disabled=false;document.getElementById('status').textContent='Loading 200 historical candles...';await loadHistoricalData();loadPredictionLock();try{const saved=JSON.parse(localStorage.getItem('currentPred5m'));if(saved&&saved.slot===Math.floor(Date.now()/300000)){markets[5].currentPrediction=saved.pred}}catch(e){}const price=latestBtcPrice||priceHistory.length?priceHistory[priceHistory.length-1]?.price||0:0;const now=new Date();[5,15,60].forEach(tf=>{markets[tf].currentSlot=getSlot(tf,now)});document.getElementById('status').textContent='Running ‚Äî 200+ data points loaded';updatePrice();updateInterval=setInterval(updatePrice,5e3);checkInterval=setInterval(updateCountdown,1e3)}
function stopPredictions(){if(!isRunning)return;isRunning=false;clearInterval(updateInterval);clearInterval(checkInterval);document.getElementById('startBtn').disabled=false;document.getElementById('stopBtn').disabled=true;document.getElementById('status').textContent='Stopped'}
function resetStats(){if(!confirm('Reset all data?'))return;stats={total:0,correct:0,currentStreak:0,skipped:0,highConfPredictions:0,highConfCorrect:0};predictionHistory=[];priceHistory=[];trainingData=[];signalPerformance={};signalMultipliers={};recentResults=[];[5,15,60].forEach(tf=>{markets[tf]={priceToBeat:null,currentSlot:null,currentPrediction:null}});if(lstmModel)lstmModel.dispose();if(technicalModel)technicalModel.dispose();if(hybridModel)hybridModel.dispose();lstmModel=null;technicalModel=null;hybridModel=null;localStorage.removeItem('btcPred');updateStats();updateHistoryDisplay();renderHistoryBar();updateSignalPerformance();document.getElementById('mlStatus').innerHTML='Ensemble: Initializing &middot; LSTM: Not trained &middot; Active';document.getElementById('status').textContent='Reset complete';document.getElementById('priceToBeat').textContent='--';document.getElementById('vsComparison').textContent='--'}
window.addEventListener('DOMContentLoaded',()=>{loadProgress();renderHistoryBar();startPredictions()});
</script>
</body>
</html>
