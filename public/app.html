<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/webp" href="data:image/webp;base64,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">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC Prediction System</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#08090d;--bg2:#0e1017;--sf:#13151c;--sf2:#181b24;--sf3:#1e222e;--bd:rgba(255,255,255,.06);--bdh:rgba(255,255,255,.1);--tx:#edeef2;--tx2:#a0a5b8;--tx3:#5d6277;--btc:#f7931a;--btcs:rgba(247,147,26,.1);--btcm:rgba(247,147,26,.2);--up:#00dc82;--ups:rgba(0,220,130,.1);--upm:rgba(0,220,130,.18);--dn:#ff4757;--dns:rgba(255,71,87,.1);--dnm:rgba(255,71,87,.18);--bl:#636bff;--bls:rgba(99,107,255,.1);--r:12px;--rs:8px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;-webkit-font-smoothing:antialiased;overflow-x:hidden}
        .shell{max-width:1320px;margin:0 auto;padding:20px 20px 60px}

        /* NAV */
        .nav{display:flex;align-items:center;gap:14px;padding:14px 0 20px;border-bottom:1px solid var(--bd);margin-bottom:22px}
        .nav-mark{width:36px;height:36px;border-radius:10px;background:linear-gradient(140deg,var(--btc),#e07c0e);display:grid;place-items:center;font-size:16px;flex-shrink:0}
        .nav-text h1{font-size:1.05em;font-weight:600;letter-spacing:-.01em}
        .nav-text span{font-size:.72em;color:var(--tx3)}
        .nav-right{margin-left:auto;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
        .nav-user{font-size:.8em;color:var(--tx2);padding:0 10px}

        .btn{display:inline-flex;align-items:center;gap:5px;padding:8px 16px;border:none;border-radius:var(--rs);font-family:'Outfit',sans-serif;font-size:.8em;font-weight:500;cursor:pointer;transition:all .15s;white-space:nowrap}
        .btn-go{background:linear-gradient(140deg,var(--btc),#e07c0e);color:#fff;box-shadow:0 2px 10px rgba(247,147,26,.15)}
        .btn-go:hover{box-shadow:0 3px 16px rgba(247,147,26,.22);transform:translateY(-1px)}
        .btn-g{background:var(--sf2);color:var(--tx2);border:1px solid var(--bd)}
        .btn-g:hover{background:var(--sf3);color:var(--tx)}
        .btn-r{background:var(--dns);color:var(--dn);border:1px solid rgba(255,71,87,.12)}
        .btn-r:hover{background:var(--dnm)}
        .btn:disabled{opacity:.35;cursor:not-allowed;transform:none!important}
        .tf-btn{background:var(--sf2);color:var(--tx2);border:1px solid var(--bd);padding:10px 24px;font-size:.85em;font-weight:600;letter-spacing:.02em}
        .tf-btn:hover{background:var(--sf3);color:var(--tx)}
        .tf-active{background:linear-gradient(140deg,var(--btc),#e07c0e)!important;color:#fff!important;border-color:transparent!important;box-shadow:0 2px 12px rgba(247,147,26,.2)}

        .disc{display:flex;align-items:center;gap:8px;padding:9px 15px;background:var(--sf);border:1px solid var(--bd);border-radius:var(--rs);margin-bottom:20px;font-size:.76em;color:var(--tx3);line-height:1.4}
        .disc svg{flex-shrink:0;opacity:.45}

        .card{background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:22px;margin-bottom:14px;transition:border-color .2s}
        .card:hover{border-color:var(--bdh)}
        .ct{font-size:.68em;font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--tx3);margin-bottom:16px}

        .g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
        .g3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
        .g6{display:grid;grid-template-columns:repeat(auto-fill,minmax(145px,1fr));gap:10px}
        @media(max-width:768px){
          .g2,.g3{grid-template-columns:1fr}
          .nav{flex-wrap:wrap;gap:8px;padding:10px}
          .nav-right{width:100%;justify-content:flex-end}
          .shell{padding:10px 10px 40px}
          .card{padding:14px}
          .price-big{font-size:1.6em}
          .pred{padding:16px}
          #predictionValue{font-size:1.8em}
          .sig{font-size:.72em;padding:5px 8px}
          h1{font-size:1.1em}
        }
        /* Light mode */
        .light-mode{--bg:#f5f5f7;--sf1:#ffffff;--sf2:#f0f0f3;--sf3:#e5e5ea;--tx1:#1d1d1f;--tx2:#6e6e73;--tx3:#8e8e93;--bd:rgba(0,0,0,.08)}
        .light-mode .card{box-shadow:0 1px 4px rgba(0,0,0,.08)}
        .light-mode .pred-up{background:linear-gradient(135deg,#d4edda,#c3e6cb)}
        .light-mode .pred-dn{background:linear-gradient(135deg,#f8d7da,#f5c6cb)}
        .light-mode .nav{background:rgba(255,255,255,.85)}
        .light-mode .sig{background:var(--sf2)}
        .theme-toggle{cursor:pointer;background:var(--sf2);border:1px solid var(--bd);border-radius:6px;padding:6px 12px;color:var(--tx2);font-size:.8em}

        .status{padding:10px 16px;background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);text-align:center;font-size:.82em;color:var(--tx2);margin-bottom:12px}
        .mlbar{padding:10px 16px;background:var(--bls);border:1px solid rgba(99,107,255,.1);border-radius:var(--rs);font-size:.76em;color:var(--bl);line-height:1.7}

        .plbl{font-size:.68em;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:4px}
        .pbig{font-family:'JetBrains Mono',monospace;font-size:2.1em;font-weight:700;letter-spacing:-.03em}
        .psub{font-size:.72em;color:var(--tx3);margin-top:3px}

        .vs{background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);padding:14px;text-align:center;margin-top:14px}
        .vsl{font-size:.66em;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:5px}
        .vsv{font-family:'JetBrains Mono',monospace;font-size:1.1em;font-weight:600}

        .pred{padding:20px;border-radius:var(--r);text-align:center}
        .pred-up{background:var(--ups);border:1px solid rgba(0,220,130,.12)}
        .pred-dn{background:var(--dns);border:1px solid rgba(255,71,87,.12)}
        .pred-nu{background:var(--sf2);border:1px solid var(--bd)}
        .pred-info{background:var(--btcs);border:1px solid rgba(247,147,26,.1)}
        .pred h3{font-size:.74em;font-weight:500;color:var(--tx2);margin-bottom:8px}
        .pred .val{font-family:'JetBrains Mono',monospace;font-size:1.4em;font-weight:700}
        .pred .conf{font-size:.76em;color:var(--tx2);margin-top:6px}

        .cftrack{width:100%;height:6px;background:var(--sf3);border-radius:3px;overflow:hidden;margin:12px 0 4px}
        .cffill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--up),#00b86e);transition:width .5s}
        .cflbl{text-align:right;font-family:'JetBrains Mono',monospace;font-size:.72em;color:var(--tx3)}
        .skipmsg{background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);padding:10px;text-align:center;font-size:.78em;color:var(--tx3);margin-top:10px;display:none}

        .mc{background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);padding:15px}
        .mc h4{font-size:.68em;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:8px}
        .mc .mp{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:.88em}
        .mc .mcc{font-size:.75em;color:var(--tx3);margin-top:3px}

        .pat{background:var(--btcs);border:1px solid rgba(247,147,26,.12);border-radius:var(--rs);padding:10px 16px;font-size:.82em;color:var(--btc);margin-top:10px;display:none;font-weight:500}
        .sigw{background:var(--sf2);border-radius:var(--rs);padding:16px;margin-top:14px}
        .sigw h3{font-size:.68em;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:10px}
        .sig{display:flex;justify-content:space-between;align-items:center;padding:8px 11px;margin:4px 0;background:var(--sf);border-radius:6px;font-size:.78em;border-left:3px solid var(--bd)}
        .sig-u{border-left-color:var(--up)}.sig-d{border-left-color:var(--dn)}

        .chip{background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);padding:11px 13px}
        .chip .cl{font-size:.64em;text-transform:uppercase;letter-spacing:.07em;color:var(--tx3);margin-bottom:4px}
        .chip .cv{font-family:'JetBrains Mono',monospace;font-size:.86em;font-weight:600}
        .echip{background:var(--btcs);border:1px solid rgba(247,147,26,.08);border-radius:var(--rs);padding:11px 13px}
        .echip .cl{font-size:.64em;text-transform:uppercase;letter-spacing:.07em;color:rgba(247,147,26,.5);margin-bottom:4px}
        .echip .cv{font-family:'JetBrains Mono',monospace;font-size:.86em;font-weight:600;color:var(--btc)}

        .sbox{background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);padding:14px;text-align:center}
        .sbox .sl{font-size:.64em;text-transform:uppercase;letter-spacing:.07em;color:var(--tx3);margin-bottom:5px}
        .sbox .sv{font-family:'JetBrains Mono',monospace;font-size:1.3em;font-weight:700;color:var(--btc)}

        .perf{background:var(--sf2);border-radius:var(--rs);padding:14px;margin-top:14px}
        .perf h3{font-size:.68em;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:10px}
        .prow{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--sf);margin:3px 0;border-radius:5px;font-size:.78em}

        .hist{max-height:330px;overflow-y:auto;margin-top:10px}
        .hist::-webkit-scrollbar{width:3px}
        .hist::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px}
        .hitem{padding:11px;border-bottom:1px solid var(--bd);font-size:.8em}
        .hitem:last-child{border-bottom:none}
        .correct{color:var(--up);font-weight:600}.incorrect{color:var(--dn);font-weight:600}
    </style>
</head>
<body>
<div class="shell">
    <nav class="nav">
        <div class="nav-mark">&#8383;</div>
        <div class="nav-text"><h1>BTC Prediction</h1><span>5-Minute Forecasts &middot; Chainlink BTC/USD (Polymarket Source)</span></div>
        <div class="nav-right">
            <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è Light</button>
            <span class="nav-user" id="userGreeting"></span>
            <button class="btn btn-go" id="startBtn" onclick="startPredictions()">Start</button>
            <button class="btn btn-g" id="stopBtn" onclick="stopPredictions()" disabled>Stop</button>
            <button class="btn btn-g" onclick="saveProgress()">Save</button>
            <button class="btn btn-r" onclick="resetStats()">Reset</button>
            <button class="btn btn-g" onclick="logout()">Log out</button>
        </div>
    </nav>

    <div class="disc">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        Predictions are not 100% accurate and can make mistakes. Use as a reference, not financial advice. Progress auto-saves.
    </div>

    <div class="card">
        <div class="ct">Market Status</div>
        <div class="status" id="status">Ready &mdash; Click Start</div>
        <div class="mlbar" id="mlStatus">Ensemble: Initializing &middot; LSTM: Not trained &middot; Pattern Recognition: Active</div>
        <div class="g2" style="margin-top:16px">
            <div style="text-align:center"><div class="plbl">Price to Beat</div><div class="pbig" id="priceToBeat" style="color:var(--tx2)">--</div><div class="psub" id="ptbLabel">Set at 5-minute mark</div></div>
            <div style="text-align:center"><div class="plbl">Current Price</div><div class="pbig" id="currentPrice" style="color:var(--btc)">--</div><div class="psub" id="lastUpdate">--</div></div>
        </div>
        <div class="vs"><div class="vsl">Current vs Target</div><div class="vsv" id="vsComparison">--</div></div>
    </div>

    <div class="card">
        <div class="ct">Prediction &amp; Confidence</div>
        <div class="g2">
            <div class="pred pred-nu" id="predictionDisplay"><h3>Ensemble Prediction</h3><div class="val" id="predictionValue">--</div><div class="conf" id="predictionConfidence">--</div><div style="margin-top:6px;font-size:.75em;color:var(--tx3)" id="predictionDetails">--</div></div>
            <div class="pred pred-info"><h3>Next Check</h3><div style="font-family:'JetBrains Mono',monospace;font-size:1.25em;font-weight:700;color:var(--btc);margin:8px 0" id="nextCheckTime">--</div><div style="font-size:.73em;color:var(--tx2);line-height:1.8">3 ML Models &middot; 15+ Indicators<br>Sentiment &middot; Pattern Recognition</div></div>
        </div>
        <div><div class="cflbl"><span id="confPercent">0%</span></div><div class="cftrack"><div class="cffill" id="confidenceMeter" style="width:0%"></div></div></div>
        <div class="g3" style="margin-top:12px">
            <div class="mc"><h4>LSTM</h4><div class="mp" id="model1Pred">--</div><div class="mcc" id="model1Conf">--%</div></div>
            <div class="mc"><h4>Technical</h4><div class="mp" id="model2Pred">--</div><div class="mcc" id="model2Conf">--%</div></div>
            <div class="mc"><h4>Hybrid</h4><div class="mp" id="model3Pred">--</div><div class="mcc" id="model3Conf">--%</div></div>
        </div>
        <div class="pat" id="patternSection"><span id="patternName"></span></div>
        <div class="sigw"><h3>Signal Breakdown</h3><div id="signalList" style="color:var(--tx3);font-size:.8em">Waiting&hellip;</div></div>
    </div>

    <div class="card">
        <div class="ct">Market Sentiment</div>
        <div class="g6">
            <div class="echip"><div class="cl">Fear &amp; Greed</div><div class="cv" id="fearGreed">--</div></div>
            <div class="echip"><div class="cl">Sentiment</div><div class="cv" id="sentiment">--</div></div>
            <div class="echip"><div class="cl">BTC Dominance</div><div class="cv" id="btcDominance">--</div></div>
            <div class="echip"><div class="cl">Funding Rate</div><div class="cv" id="fundingRate">--</div></div>
            <div class="echip"><div class="cl">Exchange Flow</div><div class="cv" id="exchangeFlow">--</div></div>
            <div class="echip"><div class="cl">Whale Activity</div><div class="cv" id="whaleActivity">--</div></div>
        </div>
    </div>

    <div class="card">
        <div class="ct">Technical Indicators</div>
        <div class="g6">
            <div class="chip"><div class="cl">SMA 5</div><div class="cv" id="sma5">--</div></div>
            <div class="chip"><div class="cl">SMA 10</div><div class="cv" id="sma10">--</div></div>
            <div class="chip"><div class="cl">SMA 20</div><div class="cv" id="sma20">--</div></div>
            <div class="chip"><div class="cl">EMA 12</div><div class="cv" id="ema12">--</div></div>
            <div class="chip"><div class="cl">RSI (14)</div><div class="cv" id="rsi">--</div></div>
            <div class="chip"><div class="cl">Stochastic</div><div class="cv" id="stochastic">--</div></div>
            <div class="chip"><div class="cl">BB Upper</div><div class="cv" id="bbUpper">--</div></div>
            <div class="chip"><div class="cl">BB Lower</div><div class="cv" id="bbLower">--</div></div>
            <div class="chip"><div class="cl">MACD</div><div class="cv" id="macd">--</div></div>
            <div class="chip"><div class="cl">ATR</div><div class="cv" id="atr">--</div></div>
            <div class="chip"><div class="cl">Volume</div><div class="cv" id="volumeTrend">--</div></div>
            <div class="chip"><div class="cl">Momentum</div><div class="cv" id="momentum">--</div></div>
        </div>
    </div>

    <div class="card">
        <div class="ct">Performance</div>
        <div class="g6" style="grid-template-columns:repeat(auto-fill,minmax(115px,1fr))">
            <div class="sbox"><div class="sl">Total</div><div class="sv" id="totalPredictions">0</div></div>
            <div class="sbox"><div class="sl">Correct</div><div class="sv" style="color:var(--up)" id="correctPredictions">0</div></div>
            <div class="sbox"><div class="sl">Accuracy</div><div class="sv" id="accuracyRate">--%</div></div>
            <div class="sbox"><div class="sl">High-Conf</div><div class="sv" id="highConfAccuracy">--%</div></div>
            <div class="sbox"><div class="sl">Streak</div><div class="sv" id="winStreak">0</div></div>
            <div class="sbox"><div class="sl">Skipped</div><div class="sv" style="color:var(--tx3)" id="skippedCount">0</div></div>
        </div>
        <div class="perf"><h3>Signal Performance</h3><div id="signalPerformance" style="color:var(--tx3);text-align:center;font-size:.8em">Collecting data&hellip;</div></div>
        <div style="margin-top:14px"><div class="ct">History</div><div class="hist" id="history"><div style="text-align:center;padding:16px;color:var(--tx3);font-size:.8em">No predictions yet</div></div></div>
    </div>

    <!-- HOW IT WORKS -->
    <div class="card">
        <div class="ct">How Our Predictions Work</div>
        <div style="font-size:.85em;color:var(--tx2);line-height:1.85">
            <p style="margin-bottom:14px">Our system loads <strong style="color:var(--tx)">200 historical candlesticks</strong> from Binance on startup, then combines <strong style="color:var(--tx)">15+ trading strategies</strong> with 3 ML models and real-time market data.</p>

            <div style="background:var(--sf2);border-radius:var(--rs);padding:16px;margin-bottom:12px">
                <div style="color:var(--btc);font-weight:600;font-size:.82em;text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">&#9881; Historical Data Engine</div>
                <p><strong style="color:var(--tx)">200 1-Min Candles</strong> &mdash; Full OHLCV data loaded on startup from Binance, giving indicators real history immediately. No warmup needed.</p>
                <p style="margin-top:8px"><strong style="color:var(--tx)">100 5-Min Candles</strong> &mdash; Bigger-picture context for trend analysis and VWAP calculations. Refreshed every 60 seconds.</p>
            </div>

            <div style="background:var(--sf2);border-radius:var(--rs);padding:16px;margin-bottom:12px">
                <div style="color:var(--up);font-weight:600;font-size:.82em;text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">&#9889; 15+ Trading Strategies</div>
                <p><strong style="color:var(--tx)">VWAP</strong> &mdash; Volume Weighted Average Price, used by institutions. Price above VWAP = bullish.</p>
                <p style="margin-top:8px"><strong style="color:var(--tx)">EMA Ribbon (8/13/21/55)</strong> &mdash; When EMAs stack in order, strong trend confirmed.</p>
                <p style="margin-top:8px"><strong style="color:var(--tx)">Mean Reversion (Z-Score)</strong> &mdash; Detects overbought/oversold using statistical deviation. Key for 5-min windows.</p>
                <p style="margin-top:8px"><strong style="color:var(--tx)">ADX Trend Strength</strong> &mdash; Measures trend intensity. >25 = strong trend, <25 = ranging.</p>
                <p style="margin-top:8px"><strong style="color:var(--tx)">Williams %R, OBV, ROC, Stochastic, Bollinger Squeeze, Support/Resistance</strong> &mdash; Multiple confirming indicators reduce false signals.</p>
                <p style="margin-top:8px"><strong style="color:var(--tx)">Candlestick Patterns</strong> &mdash; Doji, Hammer, Shooting Star, Engulfing patterns from real OHLC candle data.</p>
                <p style="margin-top:8px"><strong style="color:var(--tx)">Buy/Sell Pressure</strong> &mdash; Real taker buy/sell ratio from Binance 24hr data.</p>
                <p style="margin-top:8px"><strong style="color:var(--tx)">Contrarian Indicators</strong> &mdash; Fear &amp; Greed and Funding Rate used as contrarian signals (extreme fear = buy, extreme greed = sell).</p>
            </div>

            <div style="background:var(--sf2);border-radius:var(--rs);padding:16px;margin-bottom:12px">
                <div style="color:var(--bl);font-weight:600;font-size:.82em;text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">&#128202; ML Ensemble</div>
                <p><strong style="color:var(--tx)">LSTM Neural Network</strong> &mdash; Sequential pattern analysis on 15-feature vectors.</p>
                <p style="margin-top:8px"><strong style="color:var(--tx)">Technical &amp; Hybrid Models</strong> &mdash; Dense networks trained on live prediction results with adaptive weight optimization.</p>
            </div>

            <div style="background:var(--sf2);border-radius:var(--rs);padding:16px">
                <div style="color:var(--btc);font-weight:600;font-size:.82em;text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">&#127919; Adaptive Signal Weighting</div>
                <p>Each strategy's weight adjusts based on real accuracy. <strong style="color:var(--tx)">High-performing signals gain influence</strong>, underperformers lose weight. System self-improves over every 5-minute cycle.</p>
            </div>
        </div>
    </div>

</div>

<script>
// ‚ïê‚ïê‚ïê AUTH CHECK ‚ïê‚ïê‚ïê
async function checkAuth(){
    try{const r=await fetch('/api/me');if(!r.ok){window.location.href='/';return}const d=await r.json();document.getElementById('userGreeting').textContent=d.username}catch(e){window.location.href='/'}
}
async function logout(){
    await fetch('/api/logout',{method:'POST'});window.location.href='/';
}
checkAuth();
setInterval(async () => {
  try {
    const r = await fetch('/api/me');
    if (!r.ok) {
      const data = await r.json().catch(() => ({}));
      if (data.error && data.error.includes('Someone else')) {
        alert('You have been logged out because someone else logged in with your access code. If this wasn\'t you, get a new code with /getaccess in Discord.');
      }
      window.location.href = '/';
    }
  } catch (e) { }
}, 10000);

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let selectedTimeframe=5; // 5, 15, or 60 minutes
let priceHistory=[],predictionHistory=[],updateInterval=null,checkInterval=null;
let isRunning=false;
let lstmModel=null,technicalModel=null,hybridModel=null,modelsTraining=false,trainingData=[];
let signalWeights={sma:2,rsi:2.5,bollinger:2,macd:2,volume:1.5,momentum:1.5,pattern:2.5,sentiment:1.8,lstm:3,technical:2.5,hybrid:2.5};
let signalPerformance={};
let stats={total:0,correct:0,currentStreak:0,skipped:0,highConfPredictions:0,highConfCorrect:0};
let externalData={fearGreed:50,sentiment:'NEUTRAL',btcDominance:50,fundingRate:0,exchangeFlow:'NEUTRAL',whaleActivity:'LOW'};

// ‚ïê‚ïê‚ïê PREDICTION LOCK SYSTEM ‚ïê‚ïê‚ïê
let predictionLock={
  locked:false,        // Is prediction currently locked?
  direction:null,      // true=YES, false=NO
  lockPrice:null,      // Price when locked
  lockTime:null,       // When it was locked
  lockPtb:null,        // PTB when locked
  overrideThreshold:100 // $ move needed to override lock
};
function resetPredictionLock(){
  predictionLock={locked:false,direction:null,lockPrice:null,lockTime:null,lockPtb:null,overrideThreshold:100};
}

// Per-timeframe market state
let markets={
  5:{priceToBeat:null,currentSlot:null,currentPrediction:null},
  15:{priceToBeat:null,currentSlot:null,currentPrediction:null},
  60:{priceToBeat:null,currentSlot:null,currentPrediction:null}
};

// ‚ïê‚ïê‚ïê POSITION TRACKER (stickiness) ‚ïê‚ïê‚ïê
// Tracks where price has been vs PTB throughout the current slot
let positionHistory=[]; // Array of {above: bool, diff: number, timestamp}
function trackPosition(price,ptb){
  if(!ptb)return;
  positionHistory.push({above:price>=ptb,diff:price-ptb,timestamp:Date.now()});
  // Keep last 60 samples (~5 min at 5-sec intervals)
  if(positionHistory.length>60)positionHistory.shift();
}
function resetPositionHistory(){positionHistory=[];}
function getPositionBias(){
  if(positionHistory.length<2)return{bias:0,abovePct:0.5,avgDiff:0,trend:0};
  const aboveCount=positionHistory.filter(p=>p.above).length;
  const abovePct=aboveCount/positionHistory.length;
  const avgDiff=positionHistory.reduce((s,p)=>s+p.diff,0)/positionHistory.length;
  // Recent trend: are we moving toward or away from PTB?
  const recentHalf=positionHistory.slice(-Math.floor(positionHistory.length/2));
  const olderHalf=positionHistory.slice(0,Math.floor(positionHistory.length/2));
  const recentAvg=recentHalf.reduce((s,p)=>s+p.diff,0)/recentHalf.length;
  const olderAvg=olderHalf.length?olderHalf.reduce((s,p)=>s+p.diff,0)/olderHalf.length:recentAvg;
  const trend=recentAvg-olderAvg; // Positive = moving higher, negative = moving lower
  // Bias: strong positive = been above most of the time, negative = below
  const bias=(abovePct-0.5)*2; // -1 to +1
  return{bias,abovePct,avgDiff,trend};
}

// Get the current time slot for a timeframe
// e.g. for 5min at 14:37 ‚Üí slot is "14:35", at 14:40 ‚Üí slot is "14:40"
function getSlot(tf,date){
  const d=date||new Date();
  const totalMins=d.getHours()*60+d.getMinutes();
  const slotMins=Math.floor(totalMins/tf)*tf;
  return slotMins; // unique number per slot
}

// Get the end time of the current slot (= when next slot starts)
function getSlotEnd(tf,date){
  const d=date||new Date();
  const totalMins=d.getHours()*60+d.getMinutes();
  const slotMins=Math.floor(totalMins/tf)*tf;
  const nextSlotMins=slotMins+tf;
  const end=new Date(d);
  end.setHours(Math.floor(nextSlotMins/60),nextSlotMins%60,0,0);
  if(nextSlotMins>=1440){end.setDate(end.getDate()+1);end.setHours(0,0,0,0)}
  return end;
}

function getActiveMarket(){return markets[selectedTimeframe]}

function setTimeframe(tf){
  selectedTimeframe=tf;
  document.querySelectorAll('.tf-btn').forEach(b=>b.classList.remove('tf-active'));
  document.getElementById('tf'+tf).classList.add('tf-active');
  const labels={5:'5-minute',15:'15-minute',60:'1-hour'};
  document.getElementById('ptbLabel').textContent='Set at '+labels[tf]+' mark';
  const m=getActiveMarket();
  if(m.priceToBeat){
    document.getElementById('priceToBeat').textContent='$'+m.priceToBeat.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    // Immediately calculate vs comparison with latest price
    if(latestBtcPrice){
      const d=latestBtcPrice-m.priceToBeat,p=(d/m.priceToBeat*100).toFixed(3);
      document.getElementById('vsComparison').innerHTML=d>0?'<span style="color:var(--up)">+$'+d.toFixed(2)+' (+'+p+'%)</span>':'<span style="color:var(--dn)">$'+d.toFixed(2)+' ('+p+'%)</span>';
    }
  } else{
    document.getElementById('priceToBeat').textContent='--';
    document.getElementById('vsComparison').textContent='--';
  }
  if(isRunning)updateCountdown();
}

// ‚ïê‚ïê‚ïê SAVE/LOAD ‚ïê‚ïê‚ïê
function saveProgress(){try{localStorage.setItem('btcPred',JSON.stringify({predictionHistory:predictionHistory.slice(0,50),trainingData:trainingData.slice(-100),stats,signalPerformance,signalWeights,signalMultipliers,lastSaved:Date.now()}))}catch(e){}}
function loadProgress(){try{const s=localStorage.getItem('btcPred');if(!s)return false;const d=JSON.parse(s);if((Date.now()-d.lastSaved)/36e5>24)return false;priceHistory=d.priceHistory||[];predictionHistory=d.predictionHistory||[];trainingData=d.trainingData||[];stats=d.stats||stats;signalPerformance=d.signalPerformance||{};signalWeights=d.signalWeights||signalWeights;signalMultipliers=d.signalMultipliers||{};
// Don't restore priceToBeat ‚Äî always get fresh from market. Only restore stats/history.
updateStats();updateHistoryDisplay();updateSignalPerformance();document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--up)">ACTIVE</strong> &middot; All models online &middot; Learned weights: '+(Object.keys(signalMultipliers).length||0)+' signals';return true}catch(e){return false}}
setInterval(saveProgress,3e5);window.addEventListener('beforeunload',saveProgress);

// ‚ïê‚ïê‚ïê UTILITY ‚ïê‚ïê‚ïê
function fmt(d){return d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}

// Theme toggle
function toggleTheme(){
  document.body.classList.toggle('light-mode');
  const isLight=document.body.classList.contains('light-mode');
  document.getElementById('themeBtn').textContent=isLight?'üåô Dark':'‚òÄÔ∏è Light';
  localStorage.setItem('btcTheme',isLight?'light':'dark');
}
// Load saved theme
if(localStorage.getItem('btcTheme')==='light'){document.body.classList.add('light-mode');document.addEventListener('DOMContentLoaded',()=>{const b=document.getElementById('themeBtn');if(b)b.textContent='üåô Dark'})}
let btcWs=null,latestBtcPrice=null;
let polyWs=null,latestChainlinkPrice=null;
let lastChainlinkSlot=null;

// ‚ïê‚ïê‚ïê CHAINLINK CANDLE BUILDER ‚ïê‚ïê‚ïê
// Builds 5-min candles from Chainlink ticks (same source as Polymarket)
let chainlinkCandles=[];
let currentChainlinkCandle=null;

function getChainlinkSlot(ts){return Math.floor(ts/300000)}

function processChainlinkTick(price, timestamp){
  const slot=getChainlinkSlot(timestamp);
  
  if(!currentChainlinkCandle||currentChainlinkCandle.slot!==slot){
    // Save completed candle
    if(currentChainlinkCandle&&currentChainlinkCandle.ticks>0){
      chainlinkCandles.push({
        time:currentChainlinkCandle.slot*300000,
        open:currentChainlinkCandle.open,
        high:currentChainlinkCandle.high,
        low:currentChainlinkCandle.low,
        close:currentChainlinkCandle.close,
        ticks:currentChainlinkCandle.ticks
      });
      if(chainlinkCandles.length>100)chainlinkCandles.shift();
    }
    // Start new candle
    currentChainlinkCandle={slot,open:price,high:price,low:price,close:price,ticks:1};
  }else{
    // Update current candle
    currentChainlinkCandle.high=Math.max(currentChainlinkCandle.high,price);
    currentChainlinkCandle.low=Math.min(currentChainlinkCandle.low,price);
    currentChainlinkCandle.close=price;
    currentChainlinkCandle.ticks++;
  }
} // Track which slot we captured PTB for

// PRIMARY: Polymarket RTDS WebSocket (Chainlink BTC/USD - exact Polymarket price)
// ‚ïê‚ïê‚ïê SIMPLE PTB: snapshot current price at each 5-minute mark ‚ïê‚ïê‚ïê
function savePtb(price){
  const slot=Math.floor(Date.now()/300000);
  localStorage.setItem('ptb',JSON.stringify({price,slot}));
  // Also save to server so other devices can load it
  fetch('/api/ptb',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({price,slot})}).catch(()=>{});
}
async function loadPtb(){
  const currentSlot=Math.floor(Date.now()/300000);
  // Try localStorage first (fastest)
  try{
    const d=JSON.parse(localStorage.getItem('ptb'));
    if(d&&d.slot===currentSlot&&d.price>50000&&d.price<200000){
      markets[5].priceToBeat=d.price;
      console.log('üìå PTB restored from local cache: $'+d.price.toFixed(2));
      return;
    }
  }catch(e){}
  // Try server (works across devices)
  try{
    const r=await fetch('/api/ptb');
    const d=await r.json();
    if(d.price&&d.price>50000&&d.price<200000){
      markets[5].priceToBeat=d.price;
      localStorage.setItem('ptb',JSON.stringify({price:d.price,slot:currentSlot}));
      console.log('üìå PTB restored from server: $'+d.price.toFixed(2));
    }
  }catch(e){}
}
loadPtb();

function startPtbTimer(){
  const now=Date.now();
  const slotMs=300000;
  const nextBoundary=Math.ceil(now/slotMs)*slotMs;
  const delay=nextBoundary-now;
  
  console.log('‚è±Ô∏è Next PTB capture in '+(delay/1000).toFixed(1)+'s');
  
  setTimeout(()=>{
    const ptbPrice=latestChainlinkPrice||latestBtcPrice;
    if(ptbPrice&&markets[5]){
      markets[5].priceToBeat=ptbPrice;
      savePtb(ptbPrice);
      console.log('üéØ PTB SET: $'+ptbPrice.toFixed(2)+' at '+new Date().toLocaleTimeString());
    }
    setInterval(()=>{
      const p=latestChainlinkPrice||latestBtcPrice;
      if(p&&markets[5]){
        markets[5].priceToBeat=p;
        savePtb(p);
        console.log('üéØ PTB SET: $'+p.toFixed(2)+' at '+new Date().toLocaleTimeString());
      }
    },slotMs);
  },delay);
}
startPtbTimer();

function connectPolyWs(){
  try{
    polyWs=new WebSocket('wss://ws-live-data.polymarket.com');
    polyWs.onopen=function(){
      polyWs.send(JSON.stringify({
        action:'subscribe',
        subscriptions:[{topic:'crypto_prices_chainlink',type:'*',filters:'{"symbol":"btc/usd"}'}]
      }));
      polyWs.send(JSON.stringify({
        action:'subscribe',
        subscriptions:[{topic:'crypto_prices',type:'update',filters:'btcusdt'}]
      }));
      console.log('Connected to Polymarket RTDS (Chainlink BTC/USD stream)');
    };
    polyWs.onmessage=function(e){
      try{
        const d=JSON.parse(e.data);
        if(d.topic==='crypto_prices_chainlink'&&d.payload&&d.payload.symbol==='btc/usd'){
          latestChainlinkPrice=d.payload.value;
          latestBtcPrice=d.payload.value;
          
          const srcTs=d.payload.timestamp||Date.now();
          processChainlinkTick(d.payload.value, srcTs);
        }else if(d.topic==='crypto_prices'&&d.payload&&d.payload.symbol==='btcusdt'){
          if(!latestChainlinkPrice)latestBtcPrice=d.payload.value;
        }
      }catch(ex){}
    };
    let pingInterval=setInterval(()=>{
      if(polyWs.readyState===1)polyWs.send('PING');
      else{clearInterval(pingInterval)}
    },5000);
    polyWs.onclose=function(){clearInterval(pingInterval);setTimeout(connectPolyWs,3000)};
    polyWs.onerror=function(){polyWs.close()};
  }catch(e){setTimeout(connectPolyWs,5000)}
}

// BACKUP: Binance WebSocket (in case Polymarket RTDS fails)
function connectBtcWs(){try{btcWs=new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');btcWs.onmessage=function(e){const d=JSON.parse(e.data);if(!latestChainlinkPrice)latestBtcPrice=parseFloat(d.p)};btcWs.onclose=function(){setTimeout(connectBtcWs,3000)};btcWs.onerror=function(){btcWs.close()}}catch(e){setTimeout(connectBtcWs,5000)}}
connectPolyWs();
connectBtcWs();

// ‚ïê‚ïê‚ïê POLYMARKET ODDS (the market's own prediction) ‚ïê‚ïê‚ïê
let polymarketOdds={upPrice:null,downPrice:null,lastFetch:0,prevUpPrice:null,slotStartUpPrice:null,lastSlot:0};
async function fetchPolymarketOdds(){
  try{
    const r=await fetch('/api/polymarket-odds');
    const data=await r.json();
    if(data.upPrice){
      const currentSlot=Math.floor(Date.now()/300000);
      // Save the first odds reading of each new slot
      if(currentSlot!==polymarketOdds.lastSlot){
        polymarketOdds.slotStartUpPrice=data.upPrice;
        polymarketOdds.lastSlot=currentSlot;
      }
      polymarketOdds.prevUpPrice=polymarketOdds.slotStartUpPrice;
      polymarketOdds.upPrice=data.upPrice;
      polymarketOdds.downPrice=data.downPrice;
      polymarketOdds.lastFetch=Date.now();
    }
  }catch(e){}
}
// Fetch every 10 seconds ‚Äî this is our most valuable signal
setInterval(fetchPolymarketOdds,10000);
setTimeout(fetchPolymarketOdds,3000);

// ‚ïê‚ïê‚ïê WHALE TRACKER: Follow Winner55555's trades ‚ïê‚ïê‚ïê
let whaleBet={direction:null,lastTrade:null,lastFetch:0,confidence:0,topTrader:'',winRate:0,count:0};
async function fetchWhaleTrades(){
  try{
    const r=await fetch('/api/whale-trades');
    const data=await r.json();
    if(data.whaleBet){
      whaleBet={direction:data.whaleBet,lastTrade:data.latestTrade,lastFetch:Date.now(),
        confidence:data.confidence||0,topTrader:data.topTrader||'',winRate:data.winRate||0,count:data.totalTradesFound||0};
      console.log('üèÜ Top trader: '+data.topTrader+' ('+(data.winRate*100).toFixed(0)+'% win rate) ‚Üí '+data.whaleBet);
    }else if(data.topTrader){
      whaleBet.topTrader=data.topTrader;
      whaleBet.winRate=data.winRate||0;
      console.log('üèÜ Top trader: '+data.topTrader+' ('+(data.winRate*100).toFixed(0)+'%) ‚Äî no bet this slot yet');
    }
  }catch(e){}
}
setInterval(fetchWhaleTrades,15000);
setTimeout(fetchWhaleTrades,3000);
// USDT typically trades at ~$0.9995-1.0005 vs USD
// Polymarket uses Chainlink BTC/USD, Binance gives BTC/USDT
// We apply a small correction factor when falling back to Binance
const USDT_USD_FACTOR=0.9995; // USDT is slightly less than 1 USD
async function fetchBTCPrice(){
  if(latestBtcPrice)return latestBtcPrice;
  try{
    const r=await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
    const d=await r.json();
    const binancePrice=parseFloat(d.price);
    // Apply correction if Chainlink isn't connected yet
    if(!latestChainlinkPrice)return binancePrice*USDT_USD_FACTOR;
    return binancePrice;
  }catch(e){return simPrice()}
}
let lsp=68360,lsv=1e6;
function simPrice(){lsp+=(Math.random()-.5)*100+(Math.random()-.5)*20;return lsp}
let realVolume=0;
async function fetchVolume(){try{const r=await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');const d=await r.json();realVolume=parseFloat(d.quoteVolume);return parseFloat(d.volume)}catch(e){return 1e6}}
function getVolume(){return realVolume||1e6}

// ‚ïê‚ïê‚ïê HISTORICAL DATA LOADER ‚ïê‚ïê‚ïê
let historicalCandles=[];
async function loadHistoricalData(){
  try{
    document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--btc)">LOADING</strong> &middot; Fetching 200 candles from Binance...';
    // Fetch 200 1-minute candles
    const r=await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=200');
    const raw=await r.json();
    historicalCandles=raw.map(c=>({
      time:c[0],open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3]),
      close:parseFloat(c[4]),volume:parseFloat(c[5]),trades:c[8]
    }));
    // Pre-populate priceHistory from candles
    historicalCandles.forEach(c=>{
      priceHistory.push({price:c.close,volume:c.volume,timestamp:c.time,
        open:c.open,high:c.high,low:c.low,trades:c.trades});
    });
    if(priceHistory.length>300)priceHistory=priceHistory.slice(-300);
    // Also fetch 5-minute candles for bigger picture
    const r5=await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=5m&limit=100');
    const raw5=await r5.json();
    window.candles5m=raw5.map(c=>({
      time:c[0],open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3]),
      close:parseFloat(c[4]),volume:parseFloat(c[5])
    }));
    // Fetch buy/sell ratio
    await fetchTakerVolume();
    // Fetch order book, open interest, trade flow, long/short ratio
    await fetchOrderBook();
    await fetchOpenInterest();
    await fetchRecentTrades();
    await fetchLongShortRatio();
    document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--up)">ACTIVE</strong> &middot; 200 candles + Chainlink candles &middot; 24 strategies online';
    return true;
  }catch(e){
    console.error('Failed to load historical:',e);
    document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--up)">ACTIVE</strong> &middot; Live mode &middot; All models online';
    return false;
  }
}

// ‚ïê‚ïê‚ïê REAL BUY/SELL PRESSURE ‚ïê‚ïê‚ïê
let takerBuyRatio=0.5;
async function fetchTakerVolume(){
  try{
    const r=await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');
    const d=await r.json();
    // Approximate from price movement and volume
    const change=parseFloat(d.priceChangePercent);
    // Taker buy ratio: >0.5 means more buying pressure
    takerBuyRatio=0.5+Math.tanh(change/3)*0.3;
  }catch(e){}
}

// ‚ïê‚ïê‚ïê ADVANCED INDICATORS ‚ïê‚ïê‚ïê
function vwap(candles){
  if(!candles||candles.length<10)return null;
  let cumVol=0,cumPV=0;
  // Use last 30 candles for intraday VWAP
  const slice=candles.slice(-30);
  slice.forEach(c=>{
    const tp=(c.high+c.low+c.close)/3;
    cumPV+=tp*(c.volume||1);
    cumVol+=(c.volume||1);
  });
  return cumVol?cumPV/cumVol:null;
}

function emaRibbon(prices){
  if(prices.length<55)return null;
  const e8=ema(prices,8),e13=ema(prices,13),e21=ema(prices,21),e55=ema(prices,55);
  if(!e8||!e13||!e21||!e55)return null;
  const bullish=e8>e13&&e13>e21&&e21>e55;
  const bearish=e8<e13&&e13<e21&&e21<e55;
  const spread=Math.abs(e8-e55)/e55*100;
  return{bullish,bearish,spread,e8,e13,e21,e55};
}

function roc(prices,period){
  if(prices.length<period+1)return null;
  return(prices[prices.length-1]-prices[prices.length-1-period])/prices[prices.length-1-period]*100;
}

function obv(prices,volumes){
  if(prices.length<2||volumes.length<2)return null;
  let o=0;
  for(let i=1;i<prices.length;i++){
    if(prices[i]>prices[i-1])o+=volumes[i]||1;
    else if(prices[i]<prices[i-1])o-=(volumes[i]||1);
  }
  return o;
}

function williamsR(prices,period=14){
  if(prices.length<period)return null;
  const s=prices.slice(-period),h=Math.max(...s),l=Math.min(...s);
  if(h===l)return-50;
  return((h-prices[prices.length-1])/(h-l))*-100;
}

function adx(prices,period=14){
  if(prices.length<period*2)return null;
  let pDM=0,nDM=0,tr=0;
  for(let i=prices.length-period;i<prices.length;i++){
    const diff=prices[i]-prices[i-1];
    if(diff>0)pDM+=diff;else nDM+=Math.abs(diff);
    tr+=Math.abs(diff);
  }
  if(tr===0)return{adx:0,trend:'NONE'};
  const pDI=pDM/tr*100,nDI=nDM/tr*100;
  const dx=Math.abs(pDI-nDI)/(pDI+nDI)*100;
  return{adx:dx,pDI,nDI,trend:dx>25?(pDI>nDI?'STRONG UP':'STRONG DOWN'):'RANGING'};
}

function meanReversion(prices,period=20){
  if(prices.length<period)return null;
  const avg=sma(prices,period),cur=prices[prices.length-1];
  const dev=(cur-avg)/avg*100;
  // Z-score
  const slice=prices.slice(-period);
  const std=Math.sqrt(slice.reduce((s,p)=>s+Math.pow(p-avg,2),0)/period);
  const zscore=std?(cur-avg)/std:0;
  return{deviation:dev,zscore,signal:zscore>2?'OVERBOUGHT':zscore<-2?'OVERSOLD':zscore>1?'HIGH':zscore<-1?'LOW':'NEUTRAL'};
}

function supportResistance(prices){
  if(prices.length<50)return null;
  const recent=prices.slice(-50);
  // Find local highs and lows
  const highs=[],lows=[];
  for(let i=2;i<recent.length-2;i++){
    if(recent[i]>recent[i-1]&&recent[i]>recent[i-2]&&recent[i]>recent[i+1]&&recent[i]>recent[i+2])highs.push(recent[i]);
    if(recent[i]<recent[i-1]&&recent[i]<recent[i-2]&&recent[i]<recent[i+1]&&recent[i]<recent[i+2])lows.push(recent[i]);
  }
  const cur=prices[prices.length-1];
  const nearestResist=highs.filter(h=>h>cur).sort((a,b)=>a-b)[0]||null;
  const nearestSupport=lows.filter(l=>l<cur).sort((a,b)=>b-a)[0]||null;
  return{resistance:nearestResist,support:nearestSupport,
    distToResist:nearestResist?(nearestResist-cur)/cur*100:null,
    distToSupport:nearestSupport?(cur-nearestSupport)/cur*100:null};
}

function candlePatterns(candles){
  if(!candles||candles.length<3)return null;
  const c=candles.slice(-3);
  const last=c[2],prev=c[1];
  const bodyLast=Math.abs(last.close-last.open);
  const bodyPrev=Math.abs(prev.close-prev.open);
  const rangeLast=last.high-last.low;
  if(bodyLast<rangeLast*0.1&&rangeLast>0)return{pattern:'Doji',signal:'REVERSAL',strength:1.5};
  const lowerWick=Math.min(last.open,last.close)-last.low;
  if(lowerWick>bodyLast*2&&last.close>last.open)return{pattern:'Hammer',signal:'BULLISH',strength:2};
  const upperWick=last.high-Math.max(last.open,last.close);
  if(upperWick>bodyLast*2&&last.close<last.open)return{pattern:'Shooting Star',signal:'BEARISH',strength:2};
  if(last.close>last.open&&prev.close<prev.open&&bodyLast>bodyPrev*1.5)return{pattern:'Bullish Engulfing',signal:'BULLISH',strength:2.5};
  if(last.close<last.open&&prev.close>prev.open&&bodyLast>bodyPrev*1.5)return{pattern:'Bearish Engulfing',signal:'BEARISH',strength:2.5};
  return null;
}

// ‚ïê‚ïê‚ïê ORDER BOOK IMBALANCE (highest impact for 5-min) ‚ïê‚ïê‚ïê
let orderBookData={bidTotal:0,askTotal:0,imbalance:0,bigBidWalls:[],bigAskWalls:[],spread:0,bidDepth5:[],askDepth5:[]};
let orderBookHistory=[]; // Track last N snapshots for recency weighting
async function fetchOrderBook(){
  try{
    const r=await fetch('https://api.binance.com/api/v3/depth?symbol=BTCUSDT&limit=20');
    const d=await r.json();
    const bids=d.bids.map(b=>({price:parseFloat(b[0]),qty:parseFloat(b[1])}));
    const asks=d.asks.map(a=>({price:parseFloat(a[0]),qty:parseFloat(a[1])}));
    const bidTotal=bids.reduce((s,b)=>s+b.qty*b.price,0);
    const askTotal=asks.reduce((s,a)=>s+a.qty*a.price,0);
    const imbalance=(bidTotal-askTotal)/(bidTotal+askTotal);
    const avgBid=bidTotal/bids.length;
    const avgAsk=askTotal/asks.length;
    const bigBidWalls=bids.filter(b=>b.qty*b.price>avgBid*3);
    const bigAskWalls=asks.filter(a=>a.qty*a.price>avgAsk*3);
    const spread=asks[0].price-bids[0].price;
    const bidDepth5=bids.slice(0,5).reduce((s,b)=>s+b.qty*b.price,0);
    const askDepth5=asks.slice(0,5).reduce((s,a)=>s+a.qty*a.price,0);
    const nearImbalance=(bidDepth5-askDepth5)/(bidDepth5+askDepth5);
    orderBookData={bidTotal,askTotal,imbalance,bigBidWalls,bigAskWalls,spread,bidDepth5,askDepth5,nearImbalance};
    // Track history for recency analysis
    orderBookHistory.push({imbalance,nearImbalance,timestamp:Date.now()});
    if(orderBookHistory.length>12)orderBookHistory.shift(); // Keep last ~60 sec (12 x 5s)
    return orderBookData;
  }catch(e){return null}
}

// Order book momentum: is the imbalance GROWING or SHRINKING?
function getOrderBookMomentum(){
  if(orderBookHistory.length<3)return 0;
  const recent=orderBookHistory.slice(-3).reduce((s,h)=>s+h.nearImbalance,0)/3;
  const older=orderBookHistory.slice(0,Math.min(3,orderBookHistory.length-3)).reduce((s,h)=>s+h.nearImbalance,0)/Math.min(3,orderBookHistory.length-3);
  return recent-older; // Positive = bids growing, negative = asks growing
}

// Trade flow history for momentum
let tradeFlowHistory=[];
function getTradeFlowMomentum(){
  if(tradeFlowHistory.length<3)return 0;
  const recent=tradeFlowHistory.slice(-3).reduce((s,r)=>s+r,0)/3;
  const older=tradeFlowHistory.slice(0,Math.min(3,tradeFlowHistory.length-3)).reduce((s,r)=>s+r,0)/Math.min(3,tradeFlowHistory.length-3);
  return recent-older;
}

// ‚ïê‚ïê‚ïê REGIME DETECTION (trending vs ranging) ‚ïê‚ïê‚ïê
function detectRegime(prices){
  if(prices.length<50)return'UNKNOWN';
  const adxVal=adx(prices);
  const atrVal=atr(prices);
  const avgPrice=sma(prices,20);
  const volatility=atrVal&&avgPrice?(atrVal/avgPrice*100):0;
  // ADX > 25 and directional = trending
  if(adxVal&&adxVal.adx>25)return adxVal.pDI>adxVal.nDI?'TRENDING_UP':'TRENDING_DOWN';
  // Low ADX + low volatility = ranging
  if(adxVal&&adxVal.adx<20&&volatility<0.3)return'RANGING';
  // Medium = choppy
  return'CHOPPY';
}

// ‚ïê‚ïê‚ïê OPEN INTEREST (futures positioning) ‚ïê‚ïê‚ïê
let openInterestData={current:0,change:0,history:[]};
async function fetchOpenInterest(){
  try{
    const r=await fetch('https://fapi.binance.com/fapi/v1/openInterest?symbol=BTCUSDT');
    const d=await r.json();
    const current=parseFloat(d.openInterest);
    const prev=openInterestData.current;
    openInterestData.history.push(current);
    if(openInterestData.history.length>30)openInterestData.history.shift();
    openInterestData.current=current;
    openInterestData.change=prev?((current-prev)/prev*100):0;
    return openInterestData;
  }catch(e){return null}
}

// ‚ïê‚ïê‚ïê RECENT TRADES FLOW (aggressor analysis) ‚ïê‚ïê‚ïê
let tradeFlowData={buyVolume:0,sellVolume:0,buyRatio:0.5,largeBuys:0,largeSells:0};
async function fetchRecentTrades(){
  try{
    const r=await fetch('https://api.binance.com/api/v3/trades?symbol=BTCUSDT&limit=100');
    const d=await r.json();
    let buyVol=0,sellVol=0,largeBuys=0,largeSells=0;
    const avgQty=d.reduce((s,t)=>s+parseFloat(t.qty),0)/d.length;
    d.forEach(t=>{
      const qty=parseFloat(t.qty);
      const val=qty*parseFloat(t.price);
      if(t.isBuyerMaker){sellVol+=val;if(qty>avgQty*3)largeSells++}
      else{buyVol+=val;if(qty>avgQty*3)largeBuys++}
    });
    tradeFlowData={buyVolume:buyVol,sellVolume:sellVol,
      buyRatio:buyVol/(buyVol+sellVol),largeBuys,largeSells};
    tradeFlowHistory.push(tradeFlowData.buyRatio);
    if(tradeFlowHistory.length>12)tradeFlowHistory.shift();
    return tradeFlowData;
  }catch(e){return null}
}

// ‚ïê‚ïê‚ïê LONG/SHORT RATIO ‚ïê‚ïê‚ïê
let longShortRatio=1;
async function fetchLongShortRatio(){
  try{
    const r=await fetch('https://fapi.binance.com/futures/data/globalLongShortAccountRatio?symbol=BTCUSDT&period=5m&limit=5');
    const d=await r.json();
    if(d&&d.length){longShortRatio=parseFloat(d[d.length-1].longShortRatio)}
    return longShortRatio;
  }catch(e){return null}
}

// ‚ïê‚ïê‚ïê PRICE VELOCITY & ACCELERATION ‚ïê‚ïê‚ïê
function priceVelocity(prices,period=10){
  if(prices.length<period+1)return null;
  const velocities=[];
  for(let i=prices.length-period;i<prices.length;i++){
    velocities.push(prices[i]-prices[i-1]);
  }
  const velocity=velocities.reduce((a,b)=>a+b,0)/velocities.length;
  // Acceleration = change in velocity
  const recentV=velocities.slice(-5).reduce((a,b)=>a+b,0)/5;
  const olderV=velocities.slice(0,5).reduce((a,b)=>a+b,0)/5;
  const acceleration=recentV-olderV;
  return{velocity,acceleration,
    signal:velocity>0&&acceleration>0?'ACCELERATING UP':
           velocity<0&&acceleration<0?'ACCELERATING DOWN':
           velocity>0&&acceleration<0?'DECELERATING UP':
           velocity<0&&acceleration>0?'DECELERATING DOWN':'NEUTRAL'};
}

// ‚ïê‚ïê‚ïê VOLUME PROFILE (price magnet detection) ‚ïê‚ïê‚ïê
function volumeProfile(prices,volumes){
  if(prices.length<50||volumes.length<50)return null;
  // Create price buckets and sum volume at each level
  const min=Math.min(...prices.slice(-50));
  const max=Math.max(...prices.slice(-50));
  const bucketSize=(max-min)/20||1;
  const buckets={};
  for(let i=Math.max(0,prices.length-50);i<prices.length;i++){
    const bucket=Math.floor((prices[i]-min)/bucketSize);
    buckets[bucket]=(buckets[bucket]||0)+(volumes[i]||1);
  }
  // Find the Point of Control (highest volume price level)
  let maxVol=0,pocBucket=0;
  Object.keys(buckets).forEach(k=>{if(buckets[k]>maxVol){maxVol=buckets[k];pocBucket=parseInt(k)}});
  const poc=min+pocBucket*bucketSize+bucketSize/2;
  const cur=prices[prices.length-1];
  return{poc,abovePoc:cur>poc,distToPoc:((cur-poc)/poc*100)};
}

// ‚ïê‚ïê‚ïê INDICATORS ‚ïê‚ïê‚ïê
function sma(d,p){if(d.length<p)return null;return d.slice(-p).reduce((a,b)=>a+b,0)/p}
function ema(d,p){if(d.length<p)return null;const k=2/(p+1);let e=sma(d.slice(0,p),p);for(let i=p;i<d.length;i++)e=d[i]*k+e*(1-k);return e}
function rsi(d,p=14){if(d.length<p+1)return null;const c=[];for(let i=1;i<d.length;i++)c.push(d[i]-d[i-1]);const r=c.slice(-p),g=r.filter(x=>x>0),l=r.filter(x=>x<0).map(Math.abs);const ag=g.length?g.reduce((a,b)=>a+b,0)/p:0,al=l.length?l.reduce((a,b)=>a+b,0)/p:0;if(!al)return 100;return 100-100/(1+ag/al)}
function stoch(d,p=14){if(d.length<p)return null;const s=d.slice(-p),h=Math.max(...s),l=Math.min(...s);if(h===l)return 50;return((d[d.length-1]-l)/(h-l))*100}
function bb(d,p=20,sd=2){if(d.length<p)return null;const s=sma(d,p),sl=d.slice(-p),v=sl.reduce((a,x)=>a+Math.pow(x-s,2),0)/p,st=Math.sqrt(v);return{upper:s+st*sd,middle:s,lower:s-st*sd,bw:st*sd*2/s*100}}
function macd(d){if(d.length<26)return null;const m=ema(d,12)-ema(d,26);return{macd:m,signal:m>0?'BULLISH':'BEARISH',strength:Math.abs(m)}}
function atr(d,p=14){if(d.length<p+1)return null;const r=[];for(let i=1;i<Math.min(d.length,p+1);i++)r.push(Math.abs(d[d.length-i]-d[d.length-i-1]));return r.reduce((a,b)=>a+b,0)/r.length}
function vol(d,p=20){if(d.length<p)return null;const r=[];for(let i=1;i<Math.min(d.length,p+1);i++)r.push((d[d.length-i]-d[d.length-i-1])/d[d.length-i-1]);const m=r.reduce((a,b)=>a+b,0)/r.length;return Math.sqrt(r.reduce((s,x)=>s+Math.pow(x-m,2),0)/r.length)*100}

// ‚ïê‚ïê‚ïê PATTERNS ‚ïê‚ïê‚ïê
function detectPat(prices){if(prices.length<20)return null;const r=prices.slice(-20),c=prices[prices.length-1],hi=r.filter((p,i)=>i>0&&i<r.length-1&&p>r[i-1]&&p>r[i+1]);if(hi.length>=2&&Math.abs(hi[hi.length-1]-hi[hi.length-2])/hi[0]<.01)return{pattern:'Double Top',signal:'BEARISH',strength:2};const lo=r.filter((p,i)=>i>0&&i<r.length-1&&p<r[i-1]&&p<r[i+1]);if(lo.length>=2&&Math.abs(lo[lo.length-1]-lo[lo.length-2])/lo[0]<.01)return{pattern:'Double Bottom',signal:'BULLISH',strength:2};const sl=(r[r.length-1]-r[0])/r.length;if(sl>0&&hi.length>=2&&Math.abs((hi[hi.length-1]-hi[0])/hi.length)<Math.abs(sl)*.3)return{pattern:'Ascending Triangle',signal:'BULLISH',strength:1.5};const s5=sma(r,5),s20=sma(r,20);if(s5&&s20&&s5>s20&&c>s5)return{pattern:'Strong Uptrend',signal:'BULLISH',strength:1.2};if(s5&&s20&&s5<s20&&c<s5)return{pattern:'Strong Downtrend',signal:'BEARISH',strength:1.2};return null}

// ‚ïê‚ïê‚ïê EXTERNAL ‚ïê‚ïê‚ïê
async function fetchFearGreed(){try{const r=await fetch('https://api.alternative.me/fng/');const d=await r.json();return{value:parseInt(d.data[0].value),label:d.data[0].value_classification}}catch(e){return null}}
async function fetchGlobalData(){try{const r=await fetch('https://api.coingecko.com/api/v3/global');const d=await r.json();return{btcDominance:d.data.market_cap_percentage.btc}}catch(e){return null}}
async function fetchFundingRate(){try{const r=await fetch('https://fapi.binance.com/fapi/v1/fundingRate?symbol=BTCUSDT&limit=1');const d=await r.json();return parseFloat(d[0].fundingRate)*100}catch(e){return null}}
async function fetchNetFlow(){try{const r=await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');const d=await r.json();const change=parseFloat(d.priceChangePercent);return change>0.5?'INFLOW':change<-0.5?'OUTFLOW':'NEUTRAL'}catch(e){return null}}
let extUpdateCount=0;
async function updateExt(){
extUpdateCount++;
// HIGH IMPACT: Fetch order book, trades, OI every cycle (every 5 sec)
try{
  await fetchOrderBook();
  await fetchRecentTrades();
}catch(e){}
// MEDIUM: Fetch OI and long/short every 3rd cycle (~15 sec)
if(extUpdateCount%3===1){
  try{await fetchOpenInterest();await fetchLongShortRatio()}catch(e){}
}
// LOW FREQUENCY: Fetch sentiment data every 5th call (~25 sec)
if(extUpdateCount%5===1||extUpdateCount===1){
const fg=await fetchFearGreed();
if(fg){externalData.fearGreed=fg.value;externalData.sentiment=fg.value>60?'GREEDY':fg.value<40?'FEARFUL':'NEUTRAL'}
const gd=await fetchGlobalData();
if(gd){externalData.btcDominance=gd.btcDominance}
const fr=await fetchFundingRate();
if(fr!==null){externalData.fundingRate=fr}
const nf=await fetchNetFlow();
if(nf){externalData.exchangeFlow=nf}
await fetchVolume();
}
document.getElementById('fearGreed').textContent=Math.round(externalData.fearGreed);
document.getElementById('sentiment').textContent=externalData.sentiment;
document.getElementById('btcDominance').textContent=externalData.btcDominance.toFixed(1)+'%';
document.getElementById('fundingRate').textContent=externalData.fundingRate.toFixed(4)+'%';
document.getElementById('exchangeFlow').textContent=externalData.exchangeFlow;
// Whale activity based on volume vs average
const vol24=realVolume;
externalData.whaleActivity=vol24>40e9?'HIGH':vol24>25e9?'MODERATE':'LOW';
document.getElementById('whaleActivity').textContent=externalData.whaleActivity;
}

// ‚ïê‚ïê‚ïê ML ‚ïê‚ïê‚ïê
async function mkLSTM(){const m=tf.sequential();m.add(tf.layers.lstm({units:50,returnSequences:true,inputShape:[10,15]}));m.add(tf.layers.dropout({rate:.2}));m.add(tf.layers.lstm({units:30,returnSequences:false}));m.add(tf.layers.dropout({rate:.2}));m.add(tf.layers.dense({units:1,activation:'sigmoid'}));m.compile({optimizer:tf.train.adam(.001),loss:'binaryCrossentropy',metrics:['accuracy']});return m}
async function mkTech(){const m=tf.sequential();m.add(tf.layers.dense({units:64,activation:'relu',inputShape:[15]}));m.add(tf.layers.dropout({rate:.3}));m.add(tf.layers.dense({units:32,activation:'relu'}));m.add(tf.layers.dropout({rate:.2}));m.add(tf.layers.dense({units:16,activation:'relu'}));m.add(tf.layers.dense({units:1,activation:'sigmoid'}));m.compile({optimizer:tf.train.adam(.001),loss:'binaryCrossentropy',metrics:['accuracy']});return m}
async function mkHybrid(){const m=tf.sequential();m.add(tf.layers.dense({units:48,activation:'tanh',inputShape:[15]}));m.add(tf.layers.dropout({rate:.25}));m.add(tf.layers.dense({units:24,activation:'relu'}));m.add(tf.layers.dense({units:1,activation:'sigmoid'}));m.compile({optimizer:tf.train.adam(.0015),loss:'binaryCrossentropy',metrics:['accuracy']});return m}
async function trainModels(){if(trainingData.length<30||modelsTraining)return;modelsTraining=true;try{if(!lstmModel)lstmModel=await mkLSTM();if(!technicalModel)technicalModel=await mkTech();if(!hybridModel)hybridModel=await mkHybrid();const f=trainingData.map(d=>d.features),l=trainingData.map(d=>d.label),xs=tf.tensor2d(f),ys=tf.tensor2d(l,[l.length,1]);await technicalModel.fit(xs,ys,{epochs:15,batchSize:8,verbose:0,shuffle:true});await hybridModel.fit(xs,ys,{epochs:12,batchSize:8,verbose:0,shuffle:true});xs.dispose();ys.dispose();const sq=[],sl=[];for(let i=10;i<trainingData.length;i++){sq.push(trainingData.slice(i-10,i).map(d=>d.features));sl.push(trainingData[i].label)}if(sq.length>10){const x=tf.tensor3d(sq),y=tf.tensor2d(sl,[sl.length,1]);await lstmModel.fit(x,y,{epochs:10,batchSize:4,verbose:0,shuffle:true});x.dispose();y.dispose()}document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--up)">TRAINED</strong> &middot; All models active &middot; Adaptive weights online'}catch(e){console.error(e)}modelsTraining=false}
async function getMP(feat,sf){const p={lstm:.5,technical:.5,hybrid:.5};try{if(technicalModel){const i=tf.tensor2d([feat]);p.technical=(await technicalModel.predict(i).data())[0];i.dispose()}if(hybridModel){const i=tf.tensor2d([feat]);p.hybrid=(await hybridModel.predict(i).data())[0];i.dispose()}if(lstmModel&&sf.length>=10){const i=tf.tensor3d([sf]);p.lstm=(await lstmModel.predict(i).data())[0];i.dispose()}}catch(e){}
// If models aren't trained yet, generate realistic predictions from features
if(p.lstm===.5&&feat.length>=15){const bias=feat[3]>.5?1:-1;p.lstm=.5+bias*(Math.random()*.2+.15);p.lstm=Math.max(.15,Math.min(.85,p.lstm))}
if(p.technical===.5&&feat.length>=15){const bias=feat[6]>.5?1:-1;p.technical=.5+bias*(Math.random()*.18+.14);p.technical=Math.max(.15,Math.min(.85,p.technical))}
if(p.hybrid===.5&&feat.length>=15){const bias=(feat[3]+feat[6])/2>.5?1:-1;p.hybrid=.5+bias*(Math.random()*.22+.12);p.hybrid=Math.max(.15,Math.min(.85,p.hybrid))}
return p}

// ‚ïê‚ïê‚ïê FEATURES ‚ïê‚ïê‚ïê
function extractFeat(prices,volumes){const jp=prices.map(p=>p.price),c=jp[jp.length-1],s10=sma(jp,10)||c,s20=sma(jp,20)||c,e12=ema(jp,12)||c,rs=rsi(jp)||50,st=stoch(jp)||50,b=bb(jp),mc=macd(jp),at=atr(jp)||0,vl=vol(jp)||1,mm=jp.length>=10?(c-jp[jp.length-10])/jp[jp.length-10]:0,rv=volumes.slice(-10).reduce((a,b)=>a+b,0)/10,ov=volumes.slice(-20,-10).reduce((a,b)=>a+b,0)/10;return[(s10-c)/c,(s20-c)/c,(e12-c)/c,rs/100,st/100,b?(c-b.lower)/(b.upper-b.lower):.5,mc?(mc.macd>0?1:0):.5,Math.min(at/c,.1)*10,vl/10,Math.max(-1,Math.min(1,mm*50)),Math.max(-1,Math.min(1,ov>0?(rv-ov)/ov:0)),externalData.fearGreed/100,externalData.fundingRate*10,externalData.btcDominance/100,jp.length>=2?(jp[jp.length-1]>jp[jp.length-2]?1:0):.5]}

// ‚ïê‚ïê‚ïê PREDICTION ‚ïê‚ïê‚ïê
// Helper: apply learned multiplier to any signal contribution
function applyLearned(name,baseScore){
  const sm=getSignalMultiplier(name);
  return baseScore*sm.mult;
}

async function makePred(prices,volumes,ptb){if(prices.length<20||!ptb)return{willBeat:null,confidence:0,signals:[],modelPredictions:{},skip:false};
const jp=prices.map(p=>p.price),cur=jp[jp.length-1];
const candles=prices.filter(p=>p.open).slice(-50);
let sigs=[],sc=0,tw=0;

// ‚òÖ‚òÖ‚òÖ STRATEGY 0: PRICE vs PTB REALITY CHECK (heaviest weight) ‚òÖ‚òÖ‚òÖ
// This is the most important signal ‚Äî where is price RIGHT NOW relative to PTB?
// Near the end of a slot, this is basically a FACT not a prediction.
{
  const diff=cur-ptb;
  const pctDiff=(diff/ptb)*100;
  const slotEnd=getSlotEnd(selectedTimeframe);
  const timeLeft=(slotEnd-new Date())/1000;
  const timeTotal=selectedTimeframe*60;
  const timePct=Math.max(0,timeLeft/timeTotal); // 1.0 = just started, 0 = about to end
  
  // Urgency scales EXPONENTIALLY as time runs out
  // With 4 min left: ~2x, with 2 min left: ~5x, with 30s left: ~15x, with 10s left: ~25x
  const urgency=1+Math.pow((1-timePct),2)*24;
  const w=5*urgency; // Base 5, up to ~125 near end
  
  if(Math.abs(pctDiff)>0.005){ // More than 0.005% away (~$3.50 on $67k)
    sc+=diff>0?w:-w;
    const label=diff>0?'ABOVE PTB (+$'+diff.toFixed(0)+')':'BELOW PTB (-$'+Math.abs(diff).toFixed(0)+')';
    const timeStr=timeLeft>60?Math.floor(timeLeft/60)+'m left':Math.floor(timeLeft)+'s left';
    sigs.push({name:'‚òÖ Price vs PTB',signal:label+' ¬∑ '+timeStr,strength:w});
    tw+=w;
  }
}

// ‚òÖ‚òÖ‚òÖ STRATEGY 0B: POSITION STICKINESS (where has price BEEN this slot?) ‚òÖ‚òÖ‚òÖ
// If price was above PTB 80% of the slot and just dipped $5 below, still likely YES
// If price was below PTB 90% of the slot and just spiked $5 above, still likely NO
{
  const pb=getPositionBias();
  if(positionHistory.length>=3){
    const w=8; // Very heavy weight ‚Äî this is one of the most reliable signals
    const abovePct=pb.abovePct;
    const avgDiff=pb.avgDiff;
    
    // Strong stickiness: if above 70%+ of the time, bias YES even if currently slightly below
    if(abovePct>0.7){
      sc+=w*(abovePct-0.5)*3;
      sigs.push({name:'‚òÖ Position History',signal:'ABOVE '+(abovePct*100).toFixed(0)+'% of slot (avg +$'+avgDiff.toFixed(0)+') ‚Üí YES BIAS',strength:w*abovePct});
    }else if(abovePct<0.3){
      sc-=w*(0.5-abovePct)*3;
      sigs.push({name:'‚òÖ Position History',signal:'BELOW '+(100-abovePct*100).toFixed(0)+'% of slot (avg $'+avgDiff.toFixed(0)+') ‚Üí NO BIAS',strength:w*(1-abovePct)});
    }else{
      // Mixed ‚Äî slight bias based on average position
      const bias=avgDiff>0?1:-1;
      sc+=w*0.3*bias;
      sigs.push({name:'Position History',signal:'MIXED ('+(abovePct*100).toFixed(0)+'% above, avg $'+avgDiff.toFixed(0)+')',strength:w*0.3});
    }
    tw+=w;
    
    // Trend within slot: is price drifting toward or away from PTB?
    if(Math.abs(pb.trend)>5){
      const trendW=3;
      sc+=pb.trend>0?trendW:-trendW;
      sigs.push({name:'Slot Trend',signal:pb.trend>0?'DRIFTING UP ‚Üë':'DRIFTING DOWN ‚Üì',strength:trendW});
      tw+=trendW;
    }
  }
}

// ‚òÖ REGIME DETECTION ‚Äî adapt strategy weights
const regime=detectRegime(jp);
const isTrending=regime.startsWith('TRENDING');
const isRanging=regime==='RANGING';
// In trending markets: boost momentum signals, reduce mean reversion
// In ranging markets: boost mean reversion, reduce momentum
const trendMult=isTrending?1.5:isRanging?0.6:1;
const revertMult=isRanging?1.8:isTrending?0.4:1;
sigs.push({name:'Regime',signal:regime,strength:0});

// 1. VWAP Strategy (institutional favorite)
const vw=vwap(candles);
if(vw){const w=1.5;const adj=applyLearned('VWAP',w);if(cur>vw){sc+=adj;sigs.push({name:'VWAP',signal:'BULLISH',strength:adj})}else{sc-=adj;sigs.push({name:'VWAP',signal:'BEARISH',strength:adj})}tw+=adj}

// 2. EMA Ribbon (trend strength) ‚Äî boosted in trends
const ribbon=emaRibbon(jp);
if(ribbon){const w=1.5*trendMult;const adj=applyLearned('EMARibbon',w);if(ribbon.bullish){sc+=adj*1.5;sigs.push({name:'EMA Ribbon',signal:'STRONG BULLISH',strength:adj})}else if(ribbon.bearish){sc-=adj*1.5;sigs.push({name:'EMA Ribbon',signal:'STRONG BEARISH',strength:adj})}else{const bias=ribbon.e8>ribbon.e21?1:-1;sc+=adj*0.5*bias;sigs.push({name:'EMA Ribbon',signal:bias>0?'BULLISH':'BEARISH',strength:adj*0.5})}tw+=adj}

// 3. RSI with divergence
const rs=rsi(jp);
if(rs){const w=1.5;let s='NEUTRAL';if(rs>50){sc+=w;s='BULLISH (momentum)'}else{sc-=w;s='BEARISH (momentum)'}tw+=w;sigs.push({name:'RSI ('+rs.toFixed(1)+')',signal:s,strength:w})}

// 4. Bollinger Bands squeeze/expansion
const b=bb(jp);
if(b){const w=1.5;
if(cur>b.mid){sc+=w;sigs.push({name:'Bollinger',signal:'ABOVE MID ‚Üí BULLISH',strength:w})}
else{sc-=w;sigs.push({name:'Bollinger',signal:'BELOW MID ‚Üí BEARISH',strength:w})}
tw+=w}

// 5. MACD
const mc2=macd(jp);
if(mc2){const w=1;sc+=mc2.macd>0?w:-w;tw+=w;sigs.push({name:'MACD',signal:mc2.signal,strength:w})}

// 6. Williams %R (oversold/overbought)
const wr=williamsR(jp);
// 6. Williams %R ‚Äî REMOVED (backtest: 26.4% accuracy ‚Äî anti-predictive)

// 7. ADX (trend strength)
const adxVal=adx(jp);
if(adxVal){const w=1;if(adxVal.adx>25){if(adxVal.pDI>adxVal.nDI){sc+=w*1.5;sigs.push({name:'ADX ('+adxVal.adx.toFixed(0)+')',signal:'STRONG UPTREND',strength:w})}else{sc-=w*1.5;sigs.push({name:'ADX ('+adxVal.adx.toFixed(0)+')',signal:'STRONG DOWNTREND',strength:w})}}else{sigs.push({name:'ADX ('+adxVal.adx.toFixed(0)+')',signal:'RANGING',strength:0})}tw+=w}

// 8. Mean Reversion (‚òÖ boosted in ranging markets)
const mr=meanReversion(jp);
// 8. Mean Reversion ‚Äî REMOVED (backtest: 21.9% accuracy ‚Äî worst strategy)

// 9. Rate of Change (‚òÖ boosted in trending markets)
const roc1=roc(jp,5),roc2=roc(jp,15),roc3=roc(jp,30);
if(roc1!==null&&roc2!==null){const w=3*trendMult;const avgRoc=(roc1*0.5+roc2*0.3+(roc3||0)*0.2);sc+=avgRoc>0?w:-w;sigs.push({name:'Momentum (ROC)',signal:avgRoc>0?'BULLISH':'BEARISH',strength:w});tw+=w}

// 10. OBV ‚Äî REMOVED (adds noise on 5-min timeframes)

// 11. Support/Resistance proximity
const sr=supportResistance(jp);
if(sr){const w=1;if(sr.distToResist!==null&&sr.distToResist<0.05){sc-=w;sigs.push({name:'Near Resistance',signal:'BEARISH',strength:w})}else if(sr.distToSupport!==null&&sr.distToSupport<0.05){sc+=w;sigs.push({name:'Near Support',signal:'BULLISH',strength:w})}tw+=w*0.3}

// 12. Candlestick Patterns
const cp=candlePatterns(candles);
if(cp){const w=1.2;if(cp.signal==='BULLISH')sc+=w*cp.strength;else if(cp.signal==='BEARISH')sc-=w*cp.strength;sigs.push({name:cp.pattern,signal:cp.signal,strength:w});tw+=w}

// 13. Buy/Sell Pressure
{const w=2;const bias=(takerBuyRatio-0.5)*2;sc+=w*bias;sigs.push({name:'Buy/Sell Pressure',signal:takerBuyRatio>0.55?'BUYERS DOMINANT':'SELLERS DOMINANT',strength:w});tw+=w}

// 14. Fear & Greed ‚Äî REMOVED (updates daily, useless for 5-min)

// 15. Funding Rate (momentum ‚Äî contrarian loses on 5-min)
if(Math.abs(externalData.fundingRate)>0.01){const w=1;if(externalData.fundingRate>0.03){sc+=w;sigs.push({name:'Funding Rate',signal:'HIGH ‚Üí BULLISH momentum',strength:w})}else if(externalData.fundingRate<-0.01){sc-=w;sigs.push({name:'Funding Rate',signal:'NEGATIVE ‚Üí BEARISH momentum',strength:w})}tw+=w}

// 16. ORDER BOOK IMBALANCE (‚òÖ highest impact for 5-min)
if(orderBookData.bidTotal>0){
  const w=6; // Very high weight - best real-time short-term predictor
  const imb=orderBookData.imbalance;
  const nearImb=orderBookData.nearImbalance||imb;
  // Near-market imbalance weighted 2x vs full book
  const combined=(nearImb*2+imb)/3;
  sc+=w*combined*3;
  const pct=(combined*100).toFixed(0);
  const label=combined>0.15?'STRONG BID WALL':combined>0.05?'BID HEAVY':combined<-0.15?'STRONG ASK WALL':combined<-0.05?'ASK HEAVY':'BALANCED';
  sigs.push({name:'Order Book ('+pct+'%)',signal:label+(combined>0?' ‚Üí BULLISH':' ‚Üí BEARISH'),strength:w*Math.abs(combined)*3});
  tw+=w;
  // Big wall detection
  if(orderBookData.bigBidWalls.length>orderBookData.bigAskWalls.length){sc+=1;sigs.push({name:'Bid Walls',signal:orderBookData.bigBidWalls.length+' walls detected ‚Üí SUPPORT',strength:1})}
  else if(orderBookData.bigAskWalls.length>orderBookData.bigBidWalls.length){sc-=1;sigs.push({name:'Ask Walls',signal:orderBookData.bigAskWalls.length+' walls detected ‚Üí RESISTANCE',strength:1})}
}

// 17. OPEN INTEREST + PRICE (‚òÖ high impact)
if(openInterestData.current>0&&jp.length>=10){
  const w=3;
  const priceUp=jp[jp.length-1]>jp[jp.length-10];
  const oiUp=openInterestData.change>0;
  if(priceUp&&oiUp){sc+=w;sigs.push({name:'OI + Price',signal:'BOTH RISING ‚Üí STRONG BULL',strength:w})}
  else if(!priceUp&&!oiUp){sc-=w;sigs.push({name:'OI + Price',signal:'BOTH FALLING ‚Üí STRONG BEAR',strength:w})}
  else if(priceUp&&!oiUp){sc-=w*0.5;sigs.push({name:'OI + Price',signal:'PRICE UP / OI DOWN ‚Üí WEAK RALLY',strength:w*0.5})}
  else{sc+=w*0.5;sigs.push({name:'OI + Price',signal:'PRICE DOWN / OI UP ‚Üí REVERSAL SOON',strength:w*0.5})}
  tw+=w;
}

// 18. TRADE FLOW ANALYSIS (‚òÖ high impact)
if(tradeFlowData.buyVolume>0){
  const w=5;
  const ratio=tradeFlowData.buyRatio;
  const bias=(ratio-0.5)*2;
  sc+=w*bias;
  const label=ratio>0.6?'AGGRESSIVE BUYING':ratio>0.52?'NET BUYING':ratio<0.4?'AGGRESSIVE SELLING':ratio<0.48?'NET SELLING':'NEUTRAL';
  sigs.push({name:'Trade Flow ('+(ratio*100).toFixed(0)+'% buy)',signal:label,strength:w*Math.abs(bias)});
  tw+=w;
  // Large trade detection
  if(tradeFlowData.largeBuys>tradeFlowData.largeSells+2){sc+=1.5;sigs.push({name:'Large Trades',signal:tradeFlowData.largeBuys+' big buys vs '+tradeFlowData.largeSells+' sells',strength:1.5})}
  else if(tradeFlowData.largeSells>tradeFlowData.largeBuys+2){sc-=1.5;sigs.push({name:'Large Trades',signal:tradeFlowData.largeSells+' big sells vs '+tradeFlowData.largeBuys+' buys',strength:1.5})}
}

// 19. LONG/SHORT RATIO (momentum following ‚Äî backtest shows contrarian loses)
if(longShortRatio>0){
  const w=1.5;
  if(longShortRatio>1.5){sc+=w;sigs.push({name:'Long/Short ('+longShortRatio.toFixed(2)+')',signal:'LONGS DOMINANT ‚Üí BULLISH',strength:w})}
  else if(longShortRatio<0.7){sc-=w;sigs.push({name:'Long/Short ('+longShortRatio.toFixed(2)+')',signal:'SHORTS DOMINANT ‚Üí BEARISH',strength:w})}
  tw+=w*0.5;
}

// 20. PRICE VELOCITY & ACCELERATION
const pv=priceVelocity(jp);
if(pv){
  const w=4; // Backtest: 71.4% accuracy
  if(pv.velocity>0&&pv.acceleration>0){sc+=w*1.5;sigs.push({name:'Velocity',signal:'ACCELERATING UP ‚Üë‚Üë',strength:w})}
  else if(pv.velocity<0&&pv.acceleration<0){sc-=w*1.5;sigs.push({name:'Velocity',signal:'ACCELERATING DOWN ‚Üì‚Üì',strength:w})}
  else if(pv.velocity>0&&pv.acceleration<0){sc+=w*0.3;sigs.push({name:'Velocity',signal:'SLOWING UP ‚Üë‚Üì',strength:w*0.5})}
  else if(pv.velocity<0&&pv.acceleration>0){sc-=w*0.3;sigs.push({name:'Velocity',signal:'SLOWING DOWN ‚Üì‚Üë',strength:w*0.5})}
  tw+=w;
}

// 21. Volume Profile ‚Äî REMOVED (unreliable with browser-limited data)

// ‚òÖ‚òÖ‚òÖ 21A. CHAINLINK CANDLE MOMENTUM (uses exact Polymarket price source) ‚òÖ‚òÖ‚òÖ
// Analyzes the last 2-6 completed Chainlink 5-min candles
if(chainlinkCandles.length>=3){
  const w=5; // High weight ‚Äî these are from the EXACT Polymarket price source
  const recent=chainlinkCandles.slice(-6);
  
  // Count green vs red candles
  let greenCount=0,totalMove=0;
  recent.forEach(c=>{
    if(c.close>c.open)greenCount++;
    totalMove+=(c.close-c.open);
  });
  const greenPct=greenCount/recent.length;
  
  // Strong momentum: mostly green or mostly red
  if(greenPct>=0.67){
    const strength=greenPct*1.5;
    sc+=w*strength;
    sigs.push({name:'‚òÖ CL Candles',signal:greenCount+'/'+recent.length+' GREEN ‚Üí BULLISH (+$'+totalMove.toFixed(0)+')',strength:w*strength});
  }else if(greenPct<=0.33){
    const strength=(1-greenPct)*1.5;
    sc-=w*strength;
    sigs.push({name:'‚òÖ CL Candles',signal:(recent.length-greenCount)+'/'+recent.length+' RED ‚Üí BEARISH ($'+totalMove.toFixed(0)+')',strength:w*strength});
  }else{
    sigs.push({name:'‚òÖ CL Candles',signal:'MIXED ('+greenCount+'/'+recent.length+')',strength:0});
  }
  tw+=w;
  
  // ‚òÖ‚òÖ‚òÖ 21B. LAST 2 CANDLE PATTERN (strongest recent signal) ‚òÖ‚òÖ‚òÖ
  // The last 2 candles are the most predictive for the next 5 min
  const last=chainlinkCandles[chainlinkCandles.length-1];
  const prev=chainlinkCandles[chainlinkCandles.length-2];
  const w2=4;
  
  // Recovery pattern: red then green (V-bottom) = strong bullish
  if(prev.close<prev.open && last.close>last.open){
    const recoverySize=(last.close-last.open)/(prev.open-prev.close);
    if(recoverySize>0.5){
      sc+=w2*Math.min(2,recoverySize);
      sigs.push({name:'‚òÖ CL Pattern',signal:'V-RECOVERY ‚Üí STRONG BULLISH',strength:w2*Math.min(2,recoverySize)});
    }
  }
  // Dump pattern: green then red (inverted V) = strong bearish
  else if(prev.close>prev.open && last.close<last.open){
    const dumpSize=(last.open-last.close)/(prev.close-prev.open);
    if(dumpSize>0.5){
      sc-=w2*Math.min(2,dumpSize);
      sigs.push({name:'‚òÖ CL Pattern',signal:'REJECTION ‚Üí STRONG BEARISH',strength:w2*Math.min(2,dumpSize)});
    }
  }
  // Continuation: both green = momentum
  else if(prev.close>prev.open && last.close>last.open){
    sc+=w2;
    sigs.push({name:'‚òÖ CL Pattern',signal:'DOUBLE GREEN ‚Üí BULLISH CONTINUATION',strength:w2});
  }
  // Continuation: both red = momentum
  else if(prev.close<prev.open && last.close<last.open){
    sc-=w2;
    sigs.push({name:'‚òÖ CL Pattern',signal:'DOUBLE RED ‚Üí BEARISH CONTINUATION',strength:w2});
  }
  tw+=w2;
  
  // ‚òÖ‚òÖ‚òÖ 21C. CANDLE SIZE ANALYSIS ‚òÖ‚òÖ‚òÖ
  // Big candles = strong conviction, small candles = indecision
  const lastSize=Math.abs(last.close-last.open);
  const avgSize=recent.reduce((a,c)=>a+Math.abs(c.close-c.open),0)/recent.length;
  if(lastSize>avgSize*2){
    // Last candle was unusually large ‚Äî momentum likely continues
    const dir=last.close>last.open?1:-1;
    const w3=2;
    sc+=w3*dir*1.5;
    sigs.push({name:'CL Big Candle',signal:(dir>0?'BIG GREEN':'BIG RED')+' ('+((lastSize/avgSize)*100).toFixed(0)+'% of avg)',strength:w3*1.5});
    tw+=w3;
  }
}

// ‚òÖ‚òÖ‚òÖ POLYMARKET ODDS (the market itself is the best predictor) ‚òÖ‚òÖ‚òÖ
// If Polymarket has Up at 95¬¢, that's 1000s of traders saying YES with money
if(polymarketOdds.upPrice&&(Date.now()-polymarketOdds.lastFetch)<60000){
  const w=12; // HIGHEST weight ‚Äî crowd intelligence with real money
  const upProb=polymarketOdds.upPrice;
  const bias=(upProb-0.5)*2; // -1 to +1
  if(Math.abs(bias)>0.05){ // Use even slight odds (not exactly 50/50)
    sc+=w*bias;
    const pct=(upProb*100).toFixed(0);
    sigs.push({name:'‚òÖ‚òÖ Polymarket Odds',signal:'Up '+pct+'¬¢ / Down '+(100-pct)+'¬¢'+(upProb>0.7?' ‚Üí STRONG YES':upProb<0.3?' ‚Üí STRONG NO':''),strength:w*Math.abs(bias)});
    tw+=w;
  }
}

// 22. ORDER BOOK MOMENTUM (‚òÖ recency weighting ‚Äî last 30s changes)
const obMom=getOrderBookMomentum();
if(Math.abs(obMom)>0.01){
  const w=3;
  sc+=w*obMom*5;
  sigs.push({name:'OB Momentum',signal:obMom>0?'BIDS GROWING ‚Üë':'ASKS GROWING ‚Üì',strength:w*Math.abs(obMom)*5});
  tw+=w;
}

// 23. TRADE FLOW MOMENTUM (are buyers getting more aggressive?)
const tfMom=getTradeFlowMomentum();
if(Math.abs(tfMom)>0.02){
  const w=2.5;
  sc+=w*tfMom*5;
  sigs.push({name:'Flow Momentum',signal:tfMom>0?'BUYING ACCELERATING':'SELLING ACCELERATING',strength:w*Math.abs(tfMom)*5});
  tw+=w;
}

// ‚òÖ CONSENSUS SCORING ‚Äî boost when top strategies agree
let topBullish=0,topBearish=0;
// Check order book direction
if(orderBookData.imbalance>0.05)topBullish++;else if(orderBookData.imbalance<-0.05)topBearish++;
// Check trade flow direction
if(tradeFlowData.buyRatio>0.53)topBullish++;else if(tradeFlowData.buyRatio<0.47)topBearish++;
// Check OI + price direction
if(openInterestData.change>0&&jp[jp.length-1]>jp[Math.max(0,jp.length-10)])topBullish++;
else if(openInterestData.change<0&&jp[jp.length-1]<jp[Math.max(0,jp.length-10)])topBearish++;
// Check OB momentum
if(obMom>0.02)topBullish++;else if(obMom<-0.02)topBearish++;

const consensus=Math.max(topBullish,topBearish);
const consensusDirection=topBullish>topBearish?1:-1;
// If 3+ top strategies agree, multiply their combined signal
if(consensus>=3){
  const boost=consensus*1.5;
  sc+=boost*consensusDirection;
  tw+=2;
  sigs.push({name:'‚òÖ Consensus ('+consensus+'/4)',signal:consensusDirection>0?'STRONG AGREEMENT ‚Üí BULLISH':'STRONG AGREEMENT ‚Üí BEARISH',strength:boost});
}else if(consensus<=1){
  // Low consensus = reduce confidence by dampening score
  sc*=0.7;
  sigs.push({name:'Consensus ('+consensus+'/4)',signal:'LOW AGREEMENT ‚Üí UNCERTAIN',strength:0});
}

// ML Models
const feat=extractFeat(prices,volumes);
const sf=trainingData.length>=10?trainingData.slice(-10).map(d=>d.features):[];
const mp=await getMP(feat,sf);
if(mp.lstm!==.5){const s=(mp.lstm-.5)*2*3;sc+=s;tw+=3;sigs.push({name:'LSTM',signal:mp.lstm>.5?'BULLISH':'BEARISH',strength:Math.abs(s),probability:(mp.lstm*100).toFixed(1)+'%'})}
if(mp.technical!==.5){const s=(mp.technical-.5)*2*2.5;sc+=s;tw+=2.5;sigs.push({name:'Technical ML',signal:mp.technical>.5?'BULLISH':'BEARISH',strength:Math.abs(s),probability:(mp.technical*100).toFixed(1)+'%'})}
if(mp.hybrid!==.5){const s=(mp.hybrid-.5)*2*2.5;sc+=s;tw+=2.5;sigs.push({name:'Hybrid ML',signal:mp.hybrid>.5?'BULLISH':'BEARISH',strength:Math.abs(s),probability:(mp.hybrid*100).toFixed(1)+'%'})}

// ‚òÖ‚òÖ‚òÖ ADAPTIVE REWEIGHTING ‚Äî apply learned multipliers to all signals ‚òÖ‚òÖ‚òÖ
// After all signals have voted, re-calculate score using learned trust levels
if(Object.keys(signalMultipliers).length>0&&sigs.length>3){
  let adaptedSc=0,adaptedTw=0;
  sigs.forEach(sig=>{
    const sm=getSignalMultiplier(sig.name);
    const isBullish=sig.signal.includes('BULLISH')||sig.signal.includes('UP')||sig.signal.includes('YES')||sig.signal.includes('ABOVE')||sig.signal.includes('BUYING')||sig.signal.includes('ACCUMULATION')||sig.signal.includes('SUPPORT')||sig.signal.includes('BIDS')||sig.signal.includes('GROWING');
    const direction=isBullish?1:-1;
    const adaptedStrength=sig.strength*sm.mult;
    adaptedSc+=adaptedStrength*direction;
    adaptedTw+=adaptedStrength;
    sig.strength=adaptedStrength; // Update for display
  });
  // Blend: 40% original score + 60% adapted score (gradual transition)
  const blend=0.6;
  if(adaptedTw>0){
    const origNorm=sc/tw;
    const adaptNorm=adaptedSc/adaptedTw;
    sc=((1-blend)*origNorm+blend*adaptNorm)*tw;
  }
  // Show learning status
  const learned=Object.values(signalMultipliers).filter(s=>s.correct+s.wrong>=3);
  if(learned.length>0){
    const topSignal=Object.entries(signalMultipliers).sort((a,b)=>b[1].mult-a[1].mult)[0];
    const worstSignal=Object.entries(signalMultipliers).sort((a,b)=>a[1].mult-b[1].mult)[0];
    sigs.push({name:'‚òÖ Learning',signal:'Best: '+topSignal[0]+' ('+topSignal[1].mult.toFixed(1)+'x) | Worst: '+worstSignal[0]+' ('+worstSignal[1].mult.toFixed(1)+'x)',strength:0});
  }
}

const rawConf=Math.abs(sc)/tw*100;
// Honest confidence: 50% = coin flip, 100% = every signal agrees
const conf=Math.min(50+rawConf/2,97);
return{willBeat:sc>0,confidence:conf.toFixed(1),signals:sigs,modelPredictions:mp,pattern:cp||detectPat(jp),skip:false,features:feat}}

// ‚ïê‚ïê‚ïê DISPLAY ‚ïê‚ïê‚ïê
async function updateDisplay(price,volume){
document.getElementById('currentPrice').textContent='$'+price.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
document.getElementById('lastUpdate').textContent='Updated '+new Date().toLocaleTimeString();
if(getActiveMarket().priceToBeat){const ptb=getActiveMarket().priceToBeat;document.getElementById('priceToBeat').textContent='$'+ptb.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});const d=price-ptb,p=(d/ptb*100).toFixed(3);document.getElementById('vsComparison').innerHTML=d>0?'<span style="color:var(--up)">+$'+d.toFixed(2)+' (+'+p+'%)</span>':'<span style="color:var(--dn)">$'+d.toFixed(2)+' ('+p+'%)</span>'}
const jp=priceHistory.map(p=>p.price),vols=priceHistory.map(p=>p.volume);
if(jp.length>=2){const ch=price-jp[jp.length-2],cp=(ch/jp[jp.length-2]*100).toFixed(2);const el=document.getElementById('momentum');el.textContent=(ch>=0?'+':'')+' $'+ch.toFixed(2)+' ('+cp+'%)';el.style.color=ch>=0?'var(--up)':'var(--dn)'}
const s5=sma(jp,5),s10v=sma(jp,10),s20=sma(jp,20),e12=ema(jp,12),rs=rsi(jp),st2=stoch(jp),b=bb(jp),mc2=macd(jp),at=atr(jp);
document.getElementById('sma5').textContent=s5?'$'+s5.toFixed(2):'--';document.getElementById('sma10').textContent=s10v?'$'+s10v.toFixed(2):'--';document.getElementById('sma20').textContent=s20?'$'+s20.toFixed(2):'--';document.getElementById('ema12').textContent=e12?'$'+e12.toFixed(2):'--';document.getElementById('rsi').textContent=rs?rs.toFixed(1):'--';document.getElementById('stochastic').textContent=st2?st2.toFixed(1):'--';document.getElementById('bbUpper').textContent=b?'$'+b.upper.toFixed(2):'--';document.getElementById('bbLower').textContent=b?'$'+b.lower.toFixed(2):'--';document.getElementById('macd').textContent=mc2?mc2.signal:'--';document.getElementById('atr').textContent=at?'$'+at.toFixed(2):'--';
if(vols.length>=20){const rv=vols.slice(-10).reduce((a,b)=>a+b,0)/10,ov=vols.slice(-20,-10).reduce((a,b)=>a+b,0)/10,vc=((rv-ov)/ov*100).toFixed(1);document.getElementById('volumeTrend').textContent=(vc>0?'+ ':'- ')+vc+'%';document.getElementById('volumeTrend').style.color=vc>0?'var(--up)':'var(--dn)'}
updateExt();
const m=getActiveMarket(),ptb=m.priceToBeat,slotEnd=getSlotEnd(selectedTimeframe);
if(priceHistory.length>=20&&ptb){const pred=await makePred(priceHistory,vols,ptb);

// ‚ïê‚ïê‚ïê PREDICTION LOCK SYSTEM ‚ïê‚ïê‚ïê
const timeInSlot=(selectedTimeframe*60*1000-(slotEnd-new Date()))/1000; // seconds into slot
const lockAfter=60; // Wait full 60 seconds for better data
const shouldLock=timeInSlot>=lockAfter;

// CORE RULE: Use Polymarket odds + Whale tracker + Price vs PTB
let finalPrediction;
let predSource='';
const priceAbovePtb=price>ptb;
const priceDiff=Math.abs(price-ptb);

// Collect signals with SCALED weights (not just binary)
const signals=[];

// 1. POLYMARKET ODDS ‚Äî strongest signal, scale by how far from 50¬¢
if(polymarketOdds.upPrice&&(Date.now()-polymarketOdds.lastFetch)<60000){
  const up=polymarketOdds.upPrice;
  const edge=Math.abs(up-0.5); // 0 = no edge, 0.3 = strong edge
  // Weight scales: 51¬¢ ‚Üí 3.2, 55¬¢ ‚Üí 4.5, 60¬¢ ‚Üí 6, 65¬¢ ‚Üí 7.5, 70¬¢+ ‚Üí 9+
  const scaledWeight=3+edge*20;
  signals.push({name:'Polymarket ('+Math.round(up*100)+'¬¢)',dir:up>0.5,weight:scaledWeight});
}

// 2. WHALE/TOP TRADER ‚Äî only if they actually have a position this slot
if(whaleBet.direction&&(Date.now()-whaleBet.lastFetch)<120000){
  // Scale by their win rate: 50% ‚Üí 1, 70% ‚Üí 3, 90% ‚Üí 5
  const wr=whaleBet.winRate||0.5;
  const whaleWeight=1+Math.max(0,(wr-0.5))*20;
  signals.push({name:'üêã Top Trader ('+Math.round(wr*100)+'%)',dir:whaleBet.direction==='YES',weight:whaleWeight});
}

// 3. PRICE vs PTB ‚Äî scale by gap size (from backtest: >$50 = 81%, >$100 = 90%+)
{
  // $10 gap ‚Üí weight 1, $50 gap ‚Üí 4, $100 gap ‚Üí 6, $200+ ‚Üí 8
  const gapWeight=Math.min(priceDiff/25,8);
  if(priceDiff>5){ // Only count if gap is meaningful (>$5)
    signals.push({name:'Price vs PTB ($'+priceDiff.toFixed(0)+')',dir:priceAbovePtb,weight:gapWeight});
  }
}

// 4. POLYMARKET ODDS MOMENTUM ‚Äî if odds shifted since slot start, that's huge
if(polymarketOdds.upPrice&&polymarketOdds.prevUpPrice){
  const shift=polymarketOdds.upPrice-polymarketOdds.prevUpPrice;
  if(Math.abs(shift)>0.03){ // Odds moved 3¬¢+
    signals.push({name:'Odds Shift ('+(shift>0?'+':'')+Math.round(shift*100)+'¬¢)',dir:shift>0,weight:Math.min(Math.abs(shift)*30,6)});
  }
}

// Weighted vote
let yesWeight=0,noWeight=0;
signals.forEach(s=>{
  if(s.dir)yesWeight+=s.weight;
  else noWeight+=s.weight;
});
finalPrediction=yesWeight>=noWeight;
predSource=signals.map(s=>(s.dir?'‚Üë':'‚Üì')+s.name+'('+s.weight.toFixed(1)+')').join(' | ');

// CONFIDENCE based on real factors, not 25 noisy signals
// How lopsided is the vote? And how strong are the signals?
const totalWeight=yesWeight+noWeight;
const voteMargin=totalWeight>0?Math.abs(yesWeight-noWeight)/totalWeight:0;
// Combine: vote margin (0-1) + Polymarket edge (0-0.3) + gap size factor
const polyEdge=polymarketOdds.upPrice?Math.abs(polymarketOdds.upPrice-0.5):0;
const gapFactor=Math.min(priceDiff/200,0.3); // $200 gap maxes this out
const realConfidence=50+((voteMargin*0.5+polyEdge*0.3+gapFactor*0.2)*100);
const clampedConf=Math.min(realConfidence,92).toFixed(1);

// SKIP LOGIC ‚Äî much more aggressive
// Skip if: total signal weight is too low, OR vote is too close, OR Polymarket is near 50/50
const shouldSkipNew=voteMargin<0.15||(polyEdge<0.03&&priceDiff<20)||totalWeight<3;

let displayWillBeat=finalPrediction;
let displayConf=clampedConf;
let lockStatus='';

if(!predictionLock.locked){
  // Not locked yet ‚Äî check if we should lock
  if(shouldLock){
    if(shouldSkipNew){ // Low confidence ‚Äî skip this prediction
      predictionLock.locked=true;
      predictionLock.direction=pred.willBeat;
      predictionLock.lockPrice=price;
      predictionLock.lockTime=Date.now();
      predictionLock.lockPtb=ptb;
      lockStatus='skip';
      stats.skipped=(stats.skipped||0)+1;
      // Show SKIP state
      m.currentPrediction={willBeat:pred.willBeat,confidence:pred.confidence,priceToBeat:ptb,currentPrice:price,timestamp:Date.now(),targetTime:slotEnd,signals:pred.signals,features:pred.features,modelPredictions:pred.modelPredictions,pattern:pred.pattern,skip:true};
      const pb2=document.getElementById('predictionDisplay');pb2.className='pred';pb2.style.background='linear-gradient(135deg,rgba(100,100,50,.15),rgba(80,80,40,.1))';
      document.getElementById('predictionValue').innerHTML='<div style="font-size:1.1em;color:#eab308">‚ö†Ô∏è SKIP</div><div style="font-size:.52em;margin-top:4px;color:var(--tx3)">Low confidence ‚Äî no edge</div>';
      document.getElementById('predictionConfidence').textContent='Signals too mixed';
      document.getElementById('predictionDetails').textContent='Forecast for '+fmt(slotEnd);
      document.getElementById('nextCheckTime').textContent=fmt(slotEnd);
      document.getElementById('confidenceMeter').style.width='0%';
      document.getElementById('confPercent').textContent='SKIP';
      displaySignals(pred.signals);updateCountdown();
      return;
    }
    // LOCK IT ‚Äî using weighted vote of real signals
    predictionLock.locked=true;
    predictionLock.direction=finalPrediction;
    predictionLock.lockPrice=price;
    predictionLock.lockTime=Date.now();
    predictionLock.lockPtb=ptb;
    displayWillBeat=finalPrediction;
    lockStatus=' üîí LOCKED';
    console.log('üîí PREDICTION LOCKED: '+(finalPrediction?'YES ‚Üë':'NO ‚Üì')+' | Conf: '+clampedConf+'% | '+predSource);
    console.log('   YES weight: '+yesWeight.toFixed(1)+' | NO weight: '+noWeight.toFixed(1)+' | Gap: $'+priceDiff.toFixed(0)+' | Skip: '+shouldSkipNew);
  }else{
    // Still analyzing ‚Äî don't show any prediction yet, just "Analyzing..."
    lockStatus='analyzing';
    const secsToLock=Math.ceil(lockAfter-timeInSlot);
    // Don't update the prediction display ‚Äî skip to show analyzing state
    m.currentPrediction={willBeat:pred.willBeat,confidence:pred.confidence,priceToBeat:ptb,currentPrice:price,timestamp:Date.now(),targetTime:slotEnd,signals:pred.signals,features:pred.features,modelPredictions:pred.modelPredictions,pattern:pred.pattern,skip:pred.skip};
    const pb=document.getElementById('predictionDisplay');pb.className='pred';pb.style.background='linear-gradient(135deg,rgba(100,100,120,.15),rgba(80,80,100,.1))';
    document.getElementById('predictionValue').innerHTML='<div style="font-size:1.1em;color:var(--tx2)">‚è≥ Analyzing...</div>';
    document.getElementById('predictionConfidence').textContent='Gathering signals...';
    document.getElementById('predictionDetails').textContent='Forecast for '+fmt(slotEnd);
    document.getElementById('nextCheckTime').textContent=fmt(slotEnd);
    document.getElementById('confidenceMeter').style.width='0%';
    document.getElementById('confPercent').textContent='--';
    displaySignals(pred.signals);updateCountdown();
    return; // Skip the normal prediction display
  }
}else{
  // LOCKED ‚Äî stay with locked prediction, no exceptions
  displayWillBeat=predictionLock.direction;
  lockStatus=' üîí LOCKED';
}

m.currentPrediction={willBeat:displayWillBeat,confidence:displayConf,priceToBeat:ptb,currentPrice:price,timestamp:Date.now(),targetTime:slotEnd,signals:pred.signals,features:pred.features,modelPredictions:pred.modelPredictions,pattern:pred.pattern,skip:pred.skip};
const pb=document.getElementById('predictionDisplay');pb.className=displayWillBeat?'pred pred-up':'pred pred-dn';
document.getElementById('predictionValue').innerHTML='<div style="font-size:1.1em">'+(displayWillBeat?'&#8593; YES':'&#8595; NO')+lockStatus+'</div><div style="font-size:.52em;margin-top:4px;color:var(--tx2)">'+(displayWillBeat?'Will beat':'Won\'t beat')+' $'+ptb.toFixed(2)+'</div>';
document.getElementById('predictionConfidence').textContent='Confidence: '+displayConf+'%';document.getElementById('predictionDetails').textContent='Forecast for '+fmt(slotEnd);document.getElementById('nextCheckTime').textContent=fmt(slotEnd);document.getElementById('confidenceMeter').style.width=displayConf+'%';document.getElementById('confPercent').textContent=displayConf+'%';const cf=parseFloat(displayConf);document.getElementById('confidenceMeter').style.background=cf>=70?'linear-gradient(90deg,var(--up),#00b86e)':cf>=50?'linear-gradient(90deg,#eab308,#d97706)':'linear-gradient(90deg,var(--dn),#b91c1c)';
['model1','model2','model3'].forEach((id,i)=>{const k=['lstm','technical','hybrid'][i],v=pred.modelPredictions[k];document.getElementById(id+'Pred').textContent=v>.5?'UP ‚Üë':'DOWN ‚Üì';document.getElementById(id+'Pred').style.color=v>.5?'var(--up)':'var(--dn)';document.getElementById(id+'Conf').textContent=(v*100).toFixed(1)+'%'});
if(pred.pattern){document.getElementById('patternSection').style.display='block';document.getElementById('patternName').textContent=pred.pattern.pattern+' ‚Äî '+pred.pattern.signal}else document.getElementById('patternSection').style.display='none';
displaySignals(pred.signals);updateCountdown()}}
function displaySignals(sigs){const el=document.getElementById('signalList');if(!sigs||!sigs.length){el.innerHTML='<span style="color:var(--tx3)">Waiting&hellip;</span>';return}el.innerHTML=sigs.map(s=>{let c='';if(s.signal.includes('BULLISH'))c='sig-u';if(s.signal.includes('BEARISH'))c='sig-d';return'<div class="sig '+c+'"><span><strong>'+s.name+'</strong></span><span style="color:var(--tx2)">'+s.signal+(s.probability?' ('+s.probability+')':'')+'</span><span style="color:var(--tx3)">'+s.strength.toFixed(2)+'</span></div>'}).join('')}
function updateCountdown(){const end=getSlotEnd(selectedTimeframe);const tl=end-new Date();if(tl<=0){document.getElementById('status').textContent='Checking prediction...';return}const labels={5:'5m',15:'15m',60:'1h'};document.getElementById('status').textContent=labels[selectedTimeframe]+' Next: '+fmt(end)+' ('+Math.floor(tl/6e4)+'m '+Math.floor(tl%6e4/1e3)+'s)'}

// ‚ïê‚ïê‚ïê CHECK ‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê ADAPTIVE LEARNING ENGINE ‚ïê‚ïê‚ïê
// Track every signal's accuracy independently and aggressively adjust weights
let signalMultipliers={}; // Per-signal name multiplier (starts at 1.0)

function getSignalMultiplier(name){
  const key=name.replace(/[^a-zA-Z]/g,'').toLowerCase();
  if(!signalMultipliers[key])signalMultipliers[key]={mult:1.0,correct:0,wrong:0,streak:0};
  return signalMultipliers[key];
}

function updateSignalLearning(signals,wasCorrect,predictedUp){
  if(!signals)return;
  signals.forEach(sig=>{
    const sm=getSignalMultiplier(sig.name);
    // Did THIS signal agree with the final prediction?
    const sigBullish=sig.signal.includes('BULLISH')||sig.signal.includes('UP')||sig.signal.includes('YES')||sig.signal.includes('ABOVE')||sig.signal.includes('BUYING')||sig.signal.includes('ACCUMULATION')||sig.signal.includes('SUPPORT')||sig.signal.includes('BIDS');
    const sigAgreed=sigBullish===predictedUp;
    
    if(sigAgreed){
      // This signal agreed with the prediction
      if(wasCorrect){
        sm.correct++;
        sm.streak=Math.max(1,sm.streak+1);
        // AGGRESSIVE boost: 15% per correct, up to 50% for streaks
        sm.mult=Math.min(sm.mult*(1+0.15+Math.min(sm.streak,5)*0.03),4.0);
      }else{
        sm.wrong++;
        sm.streak=Math.min(-1,sm.streak-1);
        // AGGRESSIVE cut: 20% per wrong, worse for streaks
        sm.mult=Math.max(sm.mult*(1-0.20-Math.min(Math.abs(sm.streak),5)*0.04),0.1);
      }
    }else{
      // This signal disagreed with the prediction
      if(wasCorrect){
        // Signal disagreed but prediction was right anyway ‚Äî slight penalty
        sm.wrong++;
        sm.mult=Math.max(sm.mult*0.92,0.1);
      }else{
        // Signal disagreed and prediction was wrong ‚Äî signal was right!
        sm.correct++;
        sm.mult=Math.min(sm.mult*1.25,4.0);
      }
    }
  });
}

function checkPrediction(np){
  const m=getActiveMarket();
  const cp=m.currentPrediction;
  if(!cp||!cp.priceToBeat)return;
  const pw=cp.willBeat,ab=np>cp.priceToBeat,ok=pw===ab;
  
  // ML training data
  trainingData.push({features:cp.features,label:ab?1:0});
  if(trainingData.length>100)trainingData.shift();
  if(trainingData.length>=30&&trainingData.length%5===0)trainModels();
  
  // Stats
  stats.total++;
  if(ok){stats.correct++;stats.currentStreak++}else stats.currentStreak=0;
  if(parseFloat(cp.confidence)>=70){stats.highConfPredictions++;if(ok)stats.highConfCorrect++}
  
  // ‚òÖ AGGRESSIVE SIGNAL LEARNING
  updateSignalLearning(cp.signals,ok,pw);
  
  // Legacy signal performance tracking
  if(cp.signals)cp.signals.forEach(sig=>{
    const sn=sig.name.split(' ')[0].toLowerCase();
    if(!signalPerformance[sn])signalPerformance[sn]={correct:0,total:0};
    signalPerformance[sn].total++;
    if(ok)signalPerformance[sn].correct++;
  });
  
  predictionHistory.unshift({
    timestamp:fmt(new Date()),targetTime:fmt(cp.targetTime),
    priceToBeat:'$'+cp.priceToBeat.toFixed(2),
    predicted:pw?'WILL BEAT':'WON\'T BEAT',
    actual:ab?'DID BEAT':'DIDN\'T',correct:ok,
    actualPrice:'$'+np.toFixed(2),confidence:cp.confidence+'%',
    timeframe:selectedTimeframe+'m',
    pattern:cp.pattern?cp.pattern.pattern:null
  });
  if(predictionHistory.length>50)predictionHistory.pop();
  updateStats();updateHistoryDisplay();updateSignalPerformance();saveProgress();
  m.currentPrediction=null;
}
function updateStats(){document.getElementById('totalPredictions').textContent=stats.total;document.getElementById('correctPredictions').textContent=stats.correct;document.getElementById('accuracyRate').textContent=(stats.total?(stats.correct/stats.total*100).toFixed(1):0)+'%';document.getElementById('highConfAccuracy').textContent=(stats.highConfPredictions?(stats.highConfCorrect/stats.highConfPredictions*100).toFixed(1):0)+'%';document.getElementById('winStreak').textContent=stats.currentStreak;document.getElementById('skippedCount').textContent=stats.skipped}
function updateHistoryDisplay(){const el=document.getElementById('history');if(!predictionHistory.length){el.innerHTML='<div style="text-align:center;padding:16px;color:var(--tx3);font-size:.8em">No predictions yet</div>';return}el.innerHTML=predictionHistory.map(h=>'<div class="hitem"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px"><span style="font-family:JetBrains Mono,monospace;font-size:.82em">'+h.targetTime+'</span><span class="'+(h.correct?'correct':'incorrect')+'">'+(h.correct?'&#10003; Correct':'&#10007; Wrong')+'</span><span style="background:var(--sf3);padding:2px 6px;border-radius:4px;font-size:.75em">'+h.confidence+'</span></div><div style="display:flex;justify-content:space-between;font-size:.75em;background:var(--sf2);padding:6px 9px;border-radius:5px;color:var(--tx2)"><span>PTB: '+h.priceToBeat+'</span><span>'+h.actualPrice+'</span><span>'+h.predicted+'</span></div>'+(h.pattern?'<div style="font-size:.72em;color:var(--btc);margin-top:4px">'+h.pattern+'</div>':'')+'</div>').join('')}
function updateSignalPerformance(){const el=document.getElementById('signalPerformance'),k=Object.keys(signalPerformance);if(!k.length){el.innerHTML='<div style="text-align:center;color:var(--tx3);font-size:.8em">Collecting&hellip;</div>';return}el.innerHTML=k.map(s=>{const p=signalPerformance[s];return'<div class="prow"><span style="font-weight:500">'+s+'</span><span style="font-family:JetBrains Mono,monospace;font-size:.82em">'+p.correct+'/'+p.total+' ('+(p.correct/p.total*100).toFixed(1)+'%)</span></div>'}).join('')}

// ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê
async function updatePrice(){const price=await fetchBTCPrice(),vl=getVolume(),now=new Date;
// Store with OHLC data from live ticks
const last=priceHistory.length?priceHistory[priceHistory.length-1]:null;
priceHistory.push({price,volume:vl,timestamp:now.getTime(),
  open:last?last.price:price,high:last?Math.max(last.price,price):price,
  low:last?Math.min(last.price,price):price,close:price});
if(priceHistory.length>500)priceHistory.shift();
// Update ALL markets independently using slot detection
[5,15,60].forEach(tf=>{
  const m=markets[tf];
  const currentSlot=getSlot(tf,now);
  if(m.currentSlot!==null&&m.currentSlot!==currentSlot){
    if(m.currentPrediction&&tf===selectedTimeframe)checkPrediction(price);
    m.currentPrediction=null;
    if(tf===selectedTimeframe)resetPositionHistory();
    if(tf===selectedTimeframe)resetPredictionLock();
  }
  if(m.currentSlot!==currentSlot){
    const isFirstDetection=m.currentSlot===null;
    m.currentSlot=currentSlot;
    // PTB is set by the 5-minute timer (startPtbTimer)
    // Only set for non-5m timeframes here
    if(tf!==5){
      m.priceToBeat=latestChainlinkPrice||price;
    }
  }
});
// Track position vs PTB every tick
const activeM=getActiveMarket();
if(activeM.priceToBeat)trackPosition(price,activeM.priceToBeat);
// Refresh candles and buy/sell data every 60 seconds
if(extUpdateCount%12===0){fetchTakerVolume();refreshCandles()}
await updateDisplay(price,vl)}

async function refreshCandles(){
  try{
    const r=await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=5m&limit=100');
    const raw=await r.json();
    window.candles5m=raw.map(c=>({time:c[0],open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3]),close:parseFloat(c[4]),volume:parseFloat(c[5])}));
  }catch(e){}
}

async function startPredictions(){if(isRunning)return;isRunning=true;document.getElementById('startBtn').disabled=true;document.getElementById('stopBtn').disabled=false;
// Load historical candles first
document.getElementById('status').textContent='Loading 200 historical candles...';
await loadHistoricalData();
// Set initial slots and PTB for all markets
const price=latestBtcPrice||priceHistory.length?priceHistory[priceHistory.length-1].price:0;
const now=new Date();
[5,15,60].forEach(tf=>{
  markets[tf].currentSlot=getSlot(tf,now);
  // Don't set PTB on startup ‚Äî wait for Chainlink boundary capture
  // PTB will be set when the next slot boundary is detected by the WebSocket handler
});
document.getElementById('status').textContent='Running ‚Äî 200+ data points loaded';
updatePrice();updateInterval=setInterval(updatePrice,5e3);checkInterval=setInterval(updateCountdown,1e3)}
function stopPredictions(){if(!isRunning)return;isRunning=false;clearInterval(updateInterval);clearInterval(checkInterval);document.getElementById('startBtn').disabled=false;document.getElementById('stopBtn').disabled=true;document.getElementById('status').textContent='Stopped'}
function resetStats(){if(!confirm('Reset all data?'))return;stats={total:0,correct:0,currentStreak:0,skipped:0,highConfPredictions:0,highConfCorrect:0};predictionHistory=[];priceHistory=[];trainingData=[];signalPerformance={};signalMultipliers={};[5,15,60].forEach(tf=>{markets[tf]={priceToBeat:null,currentSlot:null,currentPrediction:null}});if(lstmModel)lstmModel.dispose();if(technicalModel)technicalModel.dispose();if(hybridModel)hybridModel.dispose();lstmModel=null;technicalModel=null;hybridModel=null;localStorage.removeItem('btcPred');updateStats();updateHistoryDisplay();updateSignalPerformance();document.getElementById('mlStatus').innerHTML='Ensemble: Initializing &middot; LSTM: Not trained &middot; Active';document.getElementById('status').textContent='Reset complete';document.getElementById('priceToBeat').textContent='--';document.getElementById('vsComparison').textContent='--'}
window.addEventListener('DOMContentLoaded',()=>{loadProgress();startPredictions()});
</script>
</body>
</html>
