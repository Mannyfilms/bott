<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/webp" href="data:image/webp;base64,UklGRu4yAABXRUJQVlA4WAoAAAAoAAAArQEAXgEASUNDUKgBAAAAAAGobGNtcwIQAABtbnRyUkdCIFhZWiAH3AABABkAAwApADlhY3NwQVBQTAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWxjbXMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAAF9jcHJ0AAABTAAAAAxd...">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket Bitcoin Prediction Bot</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#08090d;--bg2:#0e1017;--sf:#13151c;--sf2:#181b24;--sf3:#1e222e;--bd:rgba(255,255,255,.06);--bdh:rgba(255,255,255,.1);--tx:#edeef2;--tx2:#a0a5b8;--tx3:#5d6277;--btc:#f7931a;--btcs:rgba(247,147,26,.1);--btcm:rgba(247,147,26,.2);--up:#00dc82;--ups:rgba(0,220,130,.1);--upm:rgba(0,220,130,.18);--dn:#ff4757;--dns:rgba(255,71,87,.1);--dnm:rgba(255,71,87,.18);--bl:#636bff;--bls:rgba(99,107,255,.1);--r:12px;--rs:8px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;-webkit-font-smoothing:antialiased;overflow-x:hidden}
        .shell{max-width:1320px;margin:0 auto;padding:20px 20px 60px}
        .nav{display:flex;align-items:center;gap:14px;padding:14px 0 20px;border-bottom:1px solid var(--bd);margin-bottom:22px}
        .nav-mark{width:36px;height:36px;border-radius:10px;background:linear-gradient(140deg,var(--btc),#e07c0e);display:grid;place-items:center;font-size:16px;flex-shrink:0}
        .nav-text h1{font-size:1.05em;font-weight:600;letter-spacing:-.01em}
        .nav-text span{font-size:.72em;color:var(--tx3)}
        .nav-right{margin-left:auto;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
        .nav-user{font-size:.8em;color:var(--tx2);padding:0 10px}
        .btn{display:inline-flex;align-items:center;gap:5px;padding:8px 16px;border:none;border-radius:var(--rs);font-family:'Outfit',sans-serif;font-size:.8em;font-weight:500;cursor:pointer;transition:all .15s;white-space:nowrap}
        .btn-g{background:var(--sf2);color:var(--tx2);border:1px solid var(--bd)}
        .btn-g:hover{background:var(--sf3);color:var(--tx)}
        .disc{display:flex;align-items:center;gap:8px;padding:9px 15px;background:var(--sf);border:1px solid var(--bd);border-radius:var(--rs);margin-bottom:20px;font-size:.76em;color:var(--tx3);line-height:1.4}
        .disc svg{flex-shrink:0;opacity:.45}
        .card{background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:22px;margin-bottom:14px;transition:border-color .2s}
        .card:hover{border-color:var(--bdh)}
        .ct{font-size:.68em;font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--tx3);margin-bottom:16px}
        .g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
        .g3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
        .g6{display:grid;grid-template-columns:repeat(auto-fill,minmax(145px,1fr));gap:10px}
        @media(max-width:768px){.g2,.g3{grid-template-columns:1fr}.nav{flex-wrap:wrap;gap:8px;padding:10px}.nav-right{width:100%;justify-content:flex-end}.shell{padding:10px 10px 40px}.card{padding:14px}.price-big{font-size:1.6em}.pred{padding:16px}#predictionValue{font-size:1.8em}.sig{font-size:.72em;padding:5px 8px}h1{font-size:1.1em}}
        .status{padding:10px 16px;background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);text-align:center;font-size:.82em;color:var(--tx2);margin-bottom:12px}
        .mlbar{padding:10px 16px;background:var(--bls);border:1px solid rgba(99,107,255,.1);border-radius:var(--rs);font-size:.76em;color:var(--bl);line-height:1.7}
        .plbl{font-size:.68em;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:4px}
        .pbig{font-family:'JetBrains Mono',monospace;font-size:2.1em;font-weight:700;letter-spacing:-.03em}
        .psub{font-size:.72em;color:var(--tx3);margin-top:3px}
        .vs{background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);padding:14px;text-align:center;margin-top:14px}
        .vsl{font-size:.66em;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:5px}
        .vsv{font-family:'JetBrains Mono',monospace;font-size:1.1em;font-weight:600}
        .pred{padding:20px;border-radius:var(--r);text-align:center}
        .pred-up{background:var(--ups);border:1px solid rgba(0,220,130,.12)}
        .pred-dn{background:var(--dns);border:1px solid rgba(255,71,87,.12)}
        .pred-nu{background:var(--sf2);border:1px solid var(--bd)}
        .pred-info{background:var(--btcs);border:1px solid rgba(247,147,26,.1)}
        .pred h3{font-size:.74em;font-weight:500;color:var(--tx2);margin-bottom:8px}
        .pred .val{font-family:'JetBrains Mono',monospace;font-size:1.4em;font-weight:700}
        .pred .conf{font-size:.76em;color:var(--tx2);margin-top:6px}
        .cftrack{width:100%;height:6px;background:var(--sf3);border-radius:3px;overflow:hidden;margin:12px 0 4px}
        .cffill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--up),#00b86e);transition:width .5s}
        .cflbl{text-align:right;font-family:'JetBrains Mono',monospace;font-size:.72em;color:var(--tx3)}
        .mc{background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);padding:15px}
        .mc h4{font-size:.68em;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:8px}
        .mc .mp{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:.88em}
        .mc .mcc{font-size:.75em;color:var(--tx3);margin-top:3px}
        .pat{background:var(--btcs);border:1px solid rgba(247,147,26,.12);border-radius:var(--rs);padding:10px 16px;font-size:.82em;color:var(--btc);margin-top:10px;display:none;font-weight:500}
        .sigw{background:var(--sf2);border-radius:var(--rs);padding:16px;margin-top:14px}
        .sigw h3{font-size:.68em;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:10px}
        .sig{display:flex;justify-content:space-between;align-items:center;padding:8px 11px;margin:4px 0;background:var(--sf);border-radius:6px;font-size:.78em;border-left:3px solid var(--bd)}
        .sig-u{border-left-color:var(--up)}.sig-d{border-left-color:var(--dn)}
        .chip{background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);padding:11px 13px}
        .chip .cl{font-size:.64em;text-transform:uppercase;letter-spacing:.07em;color:var(--tx3);margin-bottom:4px}
        .chip .cv{font-family:'JetBrains Mono',monospace;font-size:.86em;font-weight:600}
        .echip{background:var(--btcs);border:1px solid rgba(247,147,26,.08);border-radius:var(--rs);padding:11px 13px}
        .echip .cl{font-size:.64em;text-transform:uppercase;letter-spacing:.07em;color:rgba(247,147,26,.5);margin-bottom:4px}
        .echip .cv{font-family:'JetBrains Mono',monospace;font-size:.86em;font-weight:600;color:var(--btc)}
        .hist{max-height:330px;overflow-y:auto;margin-top:10px}
        .hist::-webkit-scrollbar{width:3px}
        .hist::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px}
        .hitem{padding:11px;border-bottom:1px solid var(--bd);font-size:.8em}
        .hitem:last-child{border-bottom:none}
        .correct{color:var(--up);font-weight:600}.incorrect{color:var(--dn);font-weight:600}
        /* PTB status indicator */
        .ptb-fresh{color:var(--up)!important}
        .ptb-stale{color:var(--tx3)!important}
    </style>
</head>
<body>
<div class="shell">
    <nav class="nav">
        <div class="nav-mark">&#8383;</div>
        <div class="nav-text"><h1>Polymarket BTC Predictor</h1><span>5-Minute Forecasts &middot; Chainlink BTC/USD (Polymarket Source)</span></div>
        <div class="nav-right">
            <span class="nav-user" id="userGreeting"></span>
            <button class="btn btn-g" onclick="logout()">Log out</button>
        </div>
    </nav>

    <div class="disc">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        Predictions are not 100% accurate and can make mistakes. Use as a reference, not financial advice. Progress auto-saves.
    </div>

    <div class="card">
        <div class="ct">Market Status</div>
        <div class="status" id="status">Ready &mdash; Click Start</div>
        <div class="mlbar" id="mlStatus">Ensemble: Initializing &middot; LSTM: Not trained &middot; Pattern Recognition: Active</div>
        <div class="g2" style="margin-top:16px">
            <div style="text-align:center">
                <div class="plbl">Price to Beat</div>
                <div class="pbig" id="priceToBeat" style="color:var(--tx2)">--</div>
                <div class="psub" id="ptbLabel">Set at 5-minute mark</div>
                <!-- FIX: PTB freshness indicator -->
                <div style="font-size:.65em;margin-top:4px" id="ptbStatus">&nbsp;</div>
            </div>
            <div style="text-align:center">
                <div class="plbl">Current Price</div>
                <div class="pbig" id="currentPrice" style="color:var(--btc)">--</div>
                <div class="psub" id="lastUpdate">--</div>
            </div>
        </div>
        <div class="vs"><div class="vsl">Current vs Target</div><div class="vsv" id="vsComparison">--</div></div>
    </div>

    <div class="card">
        <div class="ct">Prediction &amp; Confidence</div>
        <div class="g2">
            <div class="pred pred-nu" id="predictionDisplay"><h3>Ensemble Prediction</h3><div class="val" id="predictionValue">--</div><div class="conf" id="predictionConfidence">--</div><div style="margin-top:6px;font-size:.75em;color:var(--tx3)" id="predictionDetails">--</div></div>
            <div class="pred pred-info"><h3>Next Check</h3><div style="font-family:'JetBrains Mono',monospace;font-size:1.25em;font-weight:700;color:var(--btc);margin:8px 0" id="nextCheckTime">--</div><div style="font-size:.73em;color:var(--tx2);line-height:1.8">3 ML Models &middot; 15+ Indicators<br>Sentiment &middot; Pattern Recognition</div></div>
        </div>
        <div><div class="cflbl"><span id="confPercent">0%</span></div><div class="cftrack"><div class="cffill" id="confidenceMeter" style="width:0%"></div></div></div>
        <div class="g3" style="margin-top:12px">
            <div class="mc"><h4>LSTM</h4><div class="mp" id="model1Pred">--</div><div class="mcc" id="model1Conf">--%</div></div>
            <div class="mc"><h4>Technical</h4><div class="mp" id="model2Pred">--</div><div class="mcc" id="model2Conf">--%</div></div>
            <div class="mc"><h4>Hybrid</h4><div class="mp" id="model3Pred">--</div><div class="mcc" id="model3Conf">--%</div></div>
        </div>
        <div class="pat" id="patternSection"><span id="patternName"></span></div>
        <div class="sigw"><h3>Signal Breakdown</h3><div id="signalList" style="color:var(--tx3);font-size:.8em">Waiting&hellip;</div></div>
    </div>

    <div class="card">
        <div class="ct">Market Sentiment</div>
        <div class="g6">
            <div class="echip"><div class="cl">Fear &amp; Greed</div><div class="cv" id="fearGreed">--</div></div>
            <div class="echip"><div class="cl">Sentiment</div><div class="cv" id="sentiment">--</div></div>
            <div class="echip"><div class="cl">BTC Dominance</div><div class="cv" id="btcDominance">--</div></div>
            <div class="echip"><div class="cl">Funding Rate</div><div class="cv" id="fundingRate">--</div></div>
            <div class="echip"><div class="cl">Exchange Flow</div><div class="cv" id="exchangeFlow">--</div></div>
            <div class="echip"><div class="cl">Whale Activity</div><div class="cv" id="whaleActivity">--</div></div>
        </div>
    </div>

    <div style="display:none">
        <span id="sma5"></span><span id="sma10"></span><span id="sma20"></span><span id="ema12"></span>
        <span id="rsi"></span><span id="stochastic"></span><span id="bbUpper"></span><span id="bbLower"></span>
        <span id="macd"></span><span id="atr"></span><span id="volumeTrend"></span><span id="momentum"></span>
        <span id="totalPredictions"></span><span id="correctPredictions"></span><span id="accuracyRate"></span>
        <span id="highConfAccuracy"></span><span id="winStreak"></span><span id="skippedCount"></span>
        <div id="signalPerformance"></div>
    </div>

    <div class="card">
        <div class="ct">History <span id="histCount" style="color:var(--tx3);font-weight:400;font-size:.85em"></span></div>
        <div class="hist" id="history"><div style="text-align:center;padding:16px;color:var(--tx3);font-size:.8em">No predictions yet</div></div>
    </div>

    <div class="card">
        <div class="ct">How Our Predictions Work</div>
        <div style="font-size:.85em;color:var(--tx2);line-height:1.85">
            <p style="margin-bottom:14px">Our system loads <strong style="color:var(--tx)">200 historical candlesticks</strong> from Binance on startup, then combines <strong style="color:var(--tx)">15+ trading strategies</strong> with 3 ML models and real-time market data.</p>
            <div style="background:var(--sf2);border-radius:var(--rs);padding:16px;margin-bottom:12px">
                <div style="color:var(--btc);font-weight:600;font-size:.82em;text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">&#9881; Price to Beat (PTB) Logic</div>
                <p>The PTB is captured <strong style="color:var(--tx)">at the exact 5-minute boundary</strong> (e.g. 14:35:00, 14:40:00). The prediction asks: will price be <em>above or below this snapshot</em> when the next boundary arrives? PTB resets every 5 minutes.</p>
            </div>
            <div style="background:var(--sf2);border-radius:var(--rs);padding:16px;margin-bottom:12px">
                <div style="color:var(--up);font-weight:600;font-size:.82em;text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">&#9889; 15+ Trading Strategies</div>
                <p>VWAP, EMA Ribbon (8/13/21/55), Mean Reversion (Z-Score), ADX Trend Strength, Williams %R, OBV, ROC, Stochastic, Bollinger Squeeze, Support/Resistance, Candlestick Patterns, Buy/Sell Pressure, and Contrarian Indicators.</p>
            </div>
            <div style="background:var(--sf2);border-radius:var(--rs);padding:16px">
                <div style="color:var(--btc);font-weight:600;font-size:.82em;text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">&#127919; Adaptive Signal Weighting</div>
                <p>Each strategy's weight adjusts based on real accuracy. High-performing signals gain influence, underperformers lose weight. System self-improves over every 5-minute cycle.</p>
            </div>
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê
async function checkAuth(){
    try{const r=await fetch('/api/me');if(!r.ok){window.location.href='/';return}const d=await r.json();document.getElementById('userGreeting').textContent=d.username}catch(e){window.location.href='/'}}
async function logout(){await fetch('/api/logout',{method:'POST'});window.location.href='/'}
checkAuth();
setInterval(async()=>{
    try{const r=await fetch('/api/me');if(!r.ok){const data=await r.json().catch(()=>({}));if(data.error&&data.error.includes('Someone else'))alert('You have been logged out because someone else logged in with your access code.');window.location.href='/'}}catch(e){}
},10000);

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let selectedTimeframe=5;
let priceHistory=[],predictionHistory=[],updateInterval=null,checkInterval=null;
let isRunning=false;
let lstmModel=null,technicalModel=null,hybridModel=null,modelsTraining=false,trainingData=[];
let signalWeights={sma:2,rsi:2.5,bollinger:2,macd:2,volume:1.5,momentum:1.5,pattern:2.5,sentiment:1.8,lstm:3,technical:2.5,hybrid:2.5};
let signalPerformance={};
let stats={total:0,correct:0,currentStreak:0,skipped:0,highConfPredictions:0,highConfCorrect:0};
let externalData={fearGreed:50,sentiment:'NEUTRAL',btcDominance:50,fundingRate:0,exchangeFlow:'NEUTRAL',whaleActivity:'LOW'};
let recentResults=[];
let signalMultipliers={};
let latestBtcPrice=null,latestChainlinkPrice=null;
let realVolume=0;

// ‚ïê‚ïê‚ïê PREDICTION LOCK ‚ïê‚ïê‚ïê
let predictionLock={locked:false,direction:null,lockPrice:null,lockTime:null,lockPtb:null,overrideThreshold:100};
function savePredictionLock(){try{const slot=Math.floor(Date.now()/300000);localStorage.setItem('predLock5m',JSON.stringify({...predictionLock,slot}))}catch(e){}}
function loadPredictionLock(){
    try{const d=JSON.parse(localStorage.getItem('predLock5m'));if(!d||!d.locked)return false;
    const currentSlot=Math.floor(Date.now()/300000);if(d.slot!==currentSlot)return false;
    predictionLock=d;console.log('üîí Restored locked prediction: '+(d.direction?'YES ‚Üë':'NO ‚Üì'));return true}catch(e){return false}}
function resetPredictionLock(){
    predictionLock={locked:false,direction:null,lockPrice:null,lockTime:null,lockPtb:null,overrideThreshold:100};
    ptbTracker={aboveCount:0,belowCount:0,totalChecks:0,lastSlot:null,prices:[],firstPrice:null};
    try{localStorage.removeItem('predLock5m');localStorage.removeItem('currentPred5m')}catch(e){}
    try{
        const pb=document.getElementById('predictionDisplay');
        if(pb){pb.className='pred';pb.style.background='linear-gradient(135deg,rgba(100,100,120,.15),rgba(80,80,100,.1))';}
        document.getElementById('predictionValue').innerHTML='<div style="font-size:1.1em;color:var(--tx2)">‚è≥ New slot ‚Äî analyzing...</div>';
        document.getElementById('predictionConfidence').textContent='';
        document.getElementById('predictionDetails').textContent='Collecting position data...';
        document.getElementById('confidenceMeter').style.width='0%';
        document.getElementById('confPercent').textContent='--';
    }catch(e){}}

let ptbTracker={aboveCount:0,belowCount:0,totalChecks:0,lastSlot:null,prices:[],firstPrice:null};

// ‚ïê‚ïê‚ïê MARKETS ‚ïê‚ïê‚ïê
let markets={
    5:{priceToBeat:null,ptbSetAt:null,currentSlot:null,currentPrediction:null},
    15:{priceToBeat:null,ptbSetAt:null,currentSlot:null,currentPrediction:null},
    60:{priceToBeat:null,ptbSetAt:null,currentSlot:null,currentPrediction:null}
};

let positionHistory=[];
function trackPosition(price,ptb){if(!ptb)return;positionHistory.push({above:price>=ptb,diff:price-ptb,timestamp:Date.now()});if(positionHistory.length>60)positionHistory.shift()}
function resetPositionHistory(){positionHistory=[]}
function getPositionBias(){
    if(positionHistory.length<2)return{bias:0,abovePct:0.5,avgDiff:0,trend:0};
    const aboveCount=positionHistory.filter(p=>p.above).length;
    const abovePct=aboveCount/positionHistory.length;
    const avgDiff=positionHistory.reduce((s,p)=>s+p.diff,0)/positionHistory.length;
    const recentHalf=positionHistory.slice(-Math.floor(positionHistory.length/2));
    const olderHalf=positionHistory.slice(0,Math.floor(positionHistory.length/2));
    const recentAvg=recentHalf.reduce((s,p)=>s+p.diff,0)/recentHalf.length;
    const olderAvg=olderHalf.length?olderHalf.reduce((s,p)=>s+p.diff,0)/olderHalf.length:recentAvg;
    const trend=recentAvg-olderAvg;
    const bias=(abovePct-0.5)*2;
    return{bias,abovePct,avgDiff,trend}}

function getSlot(tf,date){const d=date||new Date();const totalMins=d.getHours()*60+d.getMinutes();return Math.floor(totalMins/tf)*tf}
function getSlotEnd(tf,date){
    const d=date||new Date();
    const totalMins=d.getHours()*60+d.getMinutes();
    const slotMins=Math.floor(totalMins/tf)*tf;
    const nextSlotMins=slotMins+tf;
    const end=new Date(d);
    if(nextSlotMins>=1440){end.setDate(end.getDate()+1);end.setHours(0,0,0,0)}
    else{end.setHours(Math.floor(nextSlotMins/60),nextSlotMins%60,0,0)}
    return end}
function getActiveMarket(){return markets[selectedTimeframe]}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIX 1: RELIABLE PTB SAVE/LOAD
// Key: always store {price, slot, timestamp} and validate both slot AND price sanity
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function savePtb(price){
    const slot=Math.floor(Date.now()/300000);
    const payload={price,slot,timestamp:Date.now()};
    try{localStorage.setItem('ptb',JSON.stringify(payload))}catch(e){}
    // Also push to server for cross-device persistence
    fetch('/api/ptb',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({price,slot})}).catch(()=>{});
    console.log('üéØ PTB SAVED: $'+price.toFixed(2)+' slot='+slot);
}

async function loadPtb(){
    const currentSlot=Math.floor(Date.now()/300000);
    // 1) Try localStorage (fastest)
    try{
        const d=JSON.parse(localStorage.getItem('ptb'));
        if(d&&d.slot===currentSlot&&d.price>50000&&d.price<200000){
            markets[5].priceToBeat=d.price;
            markets[5].ptbSetAt=d.timestamp||Date.now();
            updatePtbDisplay(d.price);
            console.log('üìå PTB from localStorage: $'+d.price.toFixed(2));
            return true;
        }
    }catch(e){}
    // 2) Try server
    try{
        const r=await fetch('/api/ptb');
        const d=await r.json();
        if(d.price&&d.price>50000&&d.price<200000){
            markets[5].priceToBeat=d.price;
            markets[5].ptbSetAt=Date.now();
            localStorage.setItem('ptb',JSON.stringify({price:d.price,slot:currentSlot,timestamp:Date.now()}));
            updatePtbDisplay(d.price);
            console.log('üìå PTB from server: $'+d.price.toFixed(2));
            return true;
        }
    }catch(e){}
    return false;
}

function updatePtbDisplay(price){
    if(!price)return;
    document.getElementById('priceToBeat').textContent='$'+price.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    const el=document.getElementById('ptbStatus');
    if(el){el.textContent='‚úì Fresh PTB';el.className='ptb-fresh'}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIX 2: RELIABLE PTB TIMER ‚Äî captures price at EXACT 5-min boundary
// Uses a multi-attempt approach: tries Chainlink first, falls back to Binance REST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ptbTimerActive=false;

async function capturePtbNow(label){
    // Try live WS price first
    let price=latestChainlinkPrice||latestBtcPrice;
    // If WS prices are stale/null, do a fresh REST fetch
    if(!price||isNaN(price)){
        try{
            const r=await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
            const d=await r.json();
            price=parseFloat(d.price);
        }catch(e){price=null}
    }
    if(price&&price>50000&&price<200000){
        markets[5].priceToBeat=price;
        markets[5].ptbSetAt=Date.now();
        savePtb(price);
        updatePtbDisplay(price);
        // Reset slot state for fresh prediction
        resetPredictionLock();
        resetPositionHistory();
        console.log('üéØ PTB CAPTURED ['+label+']: $'+price.toFixed(2)+' at '+new Date().toLocaleTimeString());
    }else{
        console.warn('‚ö†Ô∏è PTB capture failed (bad price: '+price+') ‚Äî retrying in 2s');
        setTimeout(()=>capturePtbNow(label+' retry'),2000);
    }
}

function startPtbTimer(){
    if(ptbTimerActive)return;
    ptbTimerActive=true;

    const slotMs=300000; // 5 minutes in ms
    const now=Date.now();
    const nextBoundary=Math.ceil(now/slotMs)*slotMs;
    const delay=nextBoundary-now;

    console.log('‚è±Ô∏è Next PTB boundary in '+(delay/1000).toFixed(1)+'s');

    // Also set a "safety net" alarm 500ms before boundary so we always have a price ready
    // Then capture AT the boundary
    setTimeout(async()=>{
        await capturePtbNow('boundary');
        // Now schedule every 5 minutes
        setInterval(async()=>{
            await capturePtbNow('interval');
        },slotMs);
    },delay);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIX 3: HISTORY PERSISTENCE
// Problem: predictionHistory was loaded from localStorage but then the display wasn't
// being called after DOMContentLoaded completed. Also the 24h expiry was too aggressive.
// Fix: separate the data load from the display refresh, and use a 48h window.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveProgress(){
    try{
        const data={
            predictionHistory:predictionHistory.slice(0,100), // save more history
            trainingData:trainingData.slice(-100),
            stats,signalPerformance,signalWeights,signalMultipliers,
            strategyStats:window.strategyStats||{},
            lastSaved:Date.now()
        };
        localStorage.setItem('btcPred',JSON.stringify(data));
        console.log('üíæ Saved: '+predictionHistory.length+' predictions | '+stats.total+' total | '+stats.correct+' correct');
    }catch(e){console.log('‚ö†Ô∏è Save failed:',e)}
}

function loadProgress(){
    try{
        const s=localStorage.getItem('btcPred');
        if(!s)return false;
        const d=JSON.parse(s);
        // FIX: Extended to 48 hours (was 24) ‚Äî you may have multi-day ongoing sessions
        if((Date.now()-d.lastSaved)/36e5>48){
            console.log('‚ö†Ô∏è Saved data expired (>48h), starting fresh');
            localStorage.removeItem('btcPred');
            return false;
        }
        predictionHistory=d.predictionHistory||[];
        trainingData=d.trainingData||[];
        stats=d.stats||stats;
        signalPerformance=d.signalPerformance||{};
        signalWeights=d.signalWeights||signalWeights;
        signalMultipliers=d.signalMultipliers||{};
        window.strategyStats=d.strategyStats||{};
        console.log('üìÇ Loaded: '+predictionHistory.length+' predictions | '+stats.total+' total | '+stats.correct+' correct');
        // FIX: Return true so caller knows to refresh UI
        return true;
    }catch(e){console.log('‚ö†Ô∏è Load failed:',e);return false}
}

// Auto-save every 30s and on page unload
setInterval(saveProgress,30000);
window.addEventListener('beforeunload',saveProgress);
window.addEventListener('pagehide',saveProgress);

// ‚ïê‚ïê‚ïê UTILITY ‚ïê‚ïê‚ïê
function fmt(d){return d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}
let btcWs=null,polyWs=null;

// ‚ïê‚ïê‚ïê CHAINLINK CANDLE BUILDER ‚ïê‚ïê‚ïê
let chainlinkCandles=[];
let currentChainlinkCandle=null;
function getChainlinkSlot(ts){return Math.floor(ts/300000)}
function processChainlinkTick(price,timestamp){
    const slot=getChainlinkSlot(timestamp);
    if(!currentChainlinkCandle||currentChainlinkCandle.slot!==slot){
        if(currentChainlinkCandle&&currentChainlinkCandle.ticks>0){
            chainlinkCandles.push({time:currentChainlinkCandle.slot*300000,open:currentChainlinkCandle.open,high:currentChainlinkCandle.high,low:currentChainlinkCandle.low,close:currentChainlinkCandle.close,ticks:currentChainlinkCandle.ticks});
            if(chainlinkCandles.length>100)chainlinkCandles.shift();
        }
        currentChainlinkCandle={slot,open:price,high:price,low:price,close:price,ticks:1};
    }else{
        currentChainlinkCandle.high=Math.max(currentChainlinkCandle.high,price);
        currentChainlinkCandle.low=Math.min(currentChainlinkCandle.low,price);
        currentChainlinkCandle.close=price;
        currentChainlinkCandle.ticks++;
    }
}

// ‚ïê‚ïê‚ïê WEBSOCKETS ‚ïê‚ïê‚ïê
function connectPolyWs(){
    try{
        polyWs=new WebSocket('wss://ws-live-data.polymarket.com');
        polyWs.onopen=function(){
            polyWs.send(JSON.stringify({action:'subscribe',subscriptions:[{topic:'crypto_prices_chainlink',type:'*',filters:'{"symbol":"btc/usd"}'}]}));
            polyWs.send(JSON.stringify({action:'subscribe',subscriptions:[{topic:'crypto_prices',type:'update',filters:'btcusdt'}]}));
            console.log('üîó Connected to Polymarket RTDS');
        };
        polyWs.onmessage=function(e){
            try{
                const d=JSON.parse(e.data);
                if(d.topic==='crypto_prices_chainlink'&&d.payload&&d.payload.symbol==='btc/usd'){
                    latestChainlinkPrice=d.payload.value;
                    latestBtcPrice=d.payload.value;
                    processChainlinkTick(d.payload.value,d.payload.timestamp||Date.now());
                }else if(d.topic==='crypto_prices'&&d.payload&&d.payload.symbol==='btcusdt'){
                    if(!latestChainlinkPrice)latestBtcPrice=d.payload.value;
                }
            }catch(ex){}
        };
        let ping=setInterval(()=>{if(polyWs.readyState===1)polyWs.send('PING');else clearInterval(ping)},5000);
        polyWs.onclose=function(){clearInterval(ping);setTimeout(connectPolyWs,3000)};
        polyWs.onerror=function(){polyWs.close()};
    }catch(e){setTimeout(connectPolyWs,5000)}
}
function connectBtcWs(){
    try{
        btcWs=new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');
        btcWs.onmessage=function(e){const d=JSON.parse(e.data);if(!latestChainlinkPrice)latestBtcPrice=parseFloat(d.p)};
        btcWs.onclose=function(){setTimeout(connectBtcWs,3000)};
        btcWs.onerror=function(){btcWs.close()};
    }catch(e){setTimeout(connectBtcWs,5000)}
}
connectPolyWs();
connectBtcWs();

// ‚ïê‚ïê‚ïê POLYMARKET ODDS ‚ïê‚ïê‚ïê
let polymarketOdds={upPrice:null,downPrice:null,lastFetch:0,slotStartUpPrice:null,lastSlot:0};
async function fetchPolymarketOdds(){
    try{
        const r=await fetch('/api/polymarket-odds');
        const data=await r.json();
        if(data.upPrice){
            const cs=Math.floor(Date.now()/300000);
            if(cs!==polymarketOdds.lastSlot){polymarketOdds.slotStartUpPrice=data.upPrice;polymarketOdds.lastSlot=cs}
            polymarketOdds.upPrice=data.upPrice;polymarketOdds.downPrice=data.downPrice;polymarketOdds.lastFetch=Date.now();
        }
    }catch(e){}
}
setInterval(fetchPolymarketOdds,10000);
setTimeout(fetchPolymarketOdds,3000);

// ‚ïê‚ïê‚ïê ORDERBOOK ‚ïê‚ïê‚ïê
let orderbookData={imbalance:0,upBidDepth:0,downBidDepth:0,lastUpdate:0,connected:false,tokenIds:[]};
let clobWs=null;
async function connectOrderbook(){
    try{
        const r=await fetch('/api/polymarket-odds');const data=await r.json();const tokens=data.clobTokenIds||[];
        if(tokens.length<2)return;
        if(orderbookData.tokenIds[0]===tokens[0]&&orderbookData.connected)return;
        orderbookData.tokenIds=tokens;
        if(clobWs)try{clobWs.close()}catch(e){}
        clobWs=new WebSocket('wss://ws-subscriptions-clob.polymarket.com/ws/market');
        clobWs.onopen=function(){clobWs.send(JSON.stringify({type:'market',assets_ids:tokens}));orderbookData.connected=true};
        clobWs.onmessage=function(e){
            try{const msg=JSON.parse(e.data);if(msg.event_type==='book'||msg.bids||msg.asks){const tokenId=msg.asset_id||msg.market||'';const bids=msg.bids||[];const bidDepth=bids.reduce((s,b)=>s+parseFloat(b.size||0)*parseFloat(b.price||0),0);if(tokenId===tokens[0])orderbookData.upBidDepth=bidDepth;else if(tokenId===tokens[1])orderbookData.downBidDepth=bidDepth;const total=orderbookData.upBidDepth+orderbookData.downBidDepth;orderbookData.imbalance=total>0?(orderbookData.upBidDepth-orderbookData.downBidDepth)/total:0;orderbookData.lastUpdate=Date.now()}}catch(e){}};
        clobWs.onclose=function(){orderbookData.connected=false};
    }catch(e){}
}
setTimeout(connectOrderbook,5000);setInterval(connectOrderbook,60000);

// ‚ïê‚ïê‚ïê WHALE TRACKER ‚ïê‚ïê‚ïê
let whaleBet={direction:null,lastTrade:null,lastFetch:0,confidence:0,topTrader:'',winRate:0,count:0};
async function fetchWhaleTrades(){
    try{const r=await fetch('/api/whale-trades');const data=await r.json();if(data.whaleBet)whaleBet={direction:data.whaleBet,lastTrade:data.latestTrade,lastFetch:Date.now(),confidence:data.confidence||0,topTrader:data.topTrader||'',winRate:data.winRate||0,count:data.totalTradesFound||0}}catch(e){}
}
setInterval(fetchWhaleTrades,15000);setTimeout(fetchWhaleTrades,3000);

// ‚ïê‚ïê‚ïê RECENT CANDLES ‚ïê‚ïê‚ïê
let recentCandles={results:[],lastFetch:0,streak:0,streakDir:null};
async function fetchRecentCandles(){
    try{
        const r=await fetch('/api/recent-candles');const data=await r.json();
        if(data.candles&&data.candles.length){
            recentCandles.results=data.candles;recentCandles.lastFetch=Date.now();
            let dir=null,len=0;
            for(const c of data.candles){const isUp=c.result==='UP';if(dir===null){dir=isUp;len=1}else if(isUp===dir)len++;else break}
            recentCandles.streak=len;recentCandles.streakDir=dir;
        }
    }catch(e){}
}
setInterval(fetchRecentCandles,30000);setTimeout(fetchRecentCandles,4000);

// ‚ïê‚ïê‚ïê PRICE FETCH ‚ïê‚ïê‚ïê
const USDT_USD_FACTOR=0.9995;
async function fetchBTCPrice(){
    if(latestBtcPrice)return latestBtcPrice;
    try{const r=await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');const d=await r.json();const p=parseFloat(d.price);return latestChainlinkPrice?p:p*USDT_USD_FACTOR}catch(e){return null}
}
let lsp=68360;
function simPrice(){lsp+=(Math.random()-.5)*100;return lsp}
let realVolume=0;
async function fetchVolume(){try{const r=await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');const d=await r.json();realVolume=parseFloat(d.quoteVolume);return parseFloat(d.volume)}catch(e){return 1e6}}
function getVolume(){return realVolume||1e6}

// ‚ïê‚ïê‚ïê HISTORICAL DATA ‚ïê‚ïê‚ïê
let historicalCandles=[];
async function loadHistoricalData(){
    try{
        document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--btc)">LOADING</strong> &middot; Fetching 200 candles...';
        const r=await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=200');
        const raw=await r.json();
        historicalCandles=raw.map(c=>({time:c[0],open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3]),close:parseFloat(c[4]),volume:parseFloat(c[5]),trades:c[8]}));
        // FIX: Only pre-populate priceHistory if it's empty (don't overwrite loaded history data)
        if(priceHistory.length<50){
            historicalCandles.forEach(c=>{priceHistory.push({price:c.close,volume:c.volume,timestamp:c.time,open:c.open,high:c.high,low:c.low,trades:c.trades})});
            if(priceHistory.length>300)priceHistory=priceHistory.slice(-300);
        }
        const r5=await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=5m&limit=100');
        const raw5=await r5.json();
        window.candles5m=raw5.map(c=>({time:c[0],open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3]),close:parseFloat(c[4]),volume:parseFloat(c[5])}));
        await fetchTakerVolume();
        await fetchOrderBook();
        await fetchOpenInterest();
        await fetchRecentTrades();
        await fetchLongShortRatio();
        document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--up)">ACTIVE</strong> &middot; 200 candles loaded &middot; All strategies online';
        return true;
    }catch(e){
        console.error('Failed to load historical:',e);
        document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--up)">ACTIVE</strong> &middot; Live mode';
        return false;
    }
}

// ‚ïê‚ïê‚ïê BUY/SELL PRESSURE ‚ïê‚ïê‚ïê
let takerBuyRatio=0.5;
async function fetchTakerVolume(){
    try{const r=await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');const d=await r.json();const change=parseFloat(d.priceChangePercent);takerBuyRatio=0.5+Math.tanh(change/3)*0.3}catch(e){}
}

// ‚ïê‚ïê‚ïê INDICATORS ‚ïê‚ïê‚ïê
function sma(d,p){if(d.length<p)return null;return d.slice(-p).reduce((a,b)=>a+b,0)/p}
function ema(d,p){if(d.length<p)return null;const k=2/(p+1);let e=sma(d.slice(0,p),p);for(let i=p;i<d.length;i++)e=d[i]*k+e*(1-k);return e}
function rsi(d,p=14){if(d.length<p+1)return null;const c=[];for(let i=1;i<d.length;i++)c.push(d[i]-d[i-1]);const r=c.slice(-p),g=r.filter(x=>x>0),l=r.filter(x=>x<0).map(Math.abs);const ag=g.length?g.reduce((a,b)=>a+b,0)/p:0,al=l.length?l.reduce((a,b)=>a+b,0)/p:0;if(!al)return 100;return 100-100/(1+ag/al)}
function stoch(d,p=14){if(d.length<p)return null;const s=d.slice(-p),h=Math.max(...s),l=Math.min(...s);if(h===l)return 50;return((d[d.length-1]-l)/(h-l))*100}
function bb(d,p=20,sd=2){if(d.length<p)return null;const s=sma(d,p),sl=d.slice(-p),v=sl.reduce((a,x)=>a+Math.pow(x-s,2),0)/p,st=Math.sqrt(v);return{upper:s+st*sd,middle:s,lower:s-st*sd,bw:st*sd*2/s*100}}
function macd(d){if(d.length<26)return null;const m=ema(d,12)-ema(d,26);return{macd:m,signal:m>0?'BULLISH':'BEARISH',strength:Math.abs(m)}}
function atr(d,p=14){if(d.length<p+1)return null;const r=[];for(let i=1;i<Math.min(d.length,p+1);i++)r.push(Math.abs(d[d.length-i]-d[d.length-i-1]));return r.reduce((a,b)=>a+b,0)/r.length}
function vol(d,p=20){if(d.length<p)return null;const r=[];for(let i=1;i<Math.min(d.length,p+1);i++)r.push((d[d.length-i]-d[d.length-i-1])/d[d.length-i-1]);const m=r.reduce((a,b)=>a+b,0)/r.length;return Math.sqrt(r.reduce((s,x)=>s+Math.pow(x-m,2),0)/r.length)*100}
function vwap(candles){if(!candles||candles.length<10)return null;let cumVol=0,cumPV=0;candles.slice(-30).forEach(c=>{const tp=(c.high+c.low+c.close)/3;cumPV+=tp*(c.volume||1);cumVol+=(c.volume||1)});return cumVol?cumPV/cumVol:null}
function detectPat(prices){if(prices.length<20)return null;const r=prices.slice(-20),hi=r.filter((p,i)=>i>0&&i<r.length-1&&p>r[i-1]&&p>r[i+1]);if(hi.length>=2&&Math.abs(hi[hi.length-1]-hi[hi.length-2])/hi[0]<.01)return{pattern:'Double Top',signal:'BEARISH',strength:2};const lo=r.filter((p,i)=>i>0&&i<r.length-1&&p<r[i-1]&&p<r[i+1]);if(lo.length>=2&&Math.abs(lo[lo.length-1]-lo[lo.length-2])/lo[0]<.01)return{pattern:'Double Bottom',signal:'BULLISH',strength:2};const s5=sma(r,5),s20=sma(r,20);if(s5&&s20&&s5>s20)return{pattern:'Strong Uptrend',signal:'BULLISH',strength:1.2};if(s5&&s20&&s5<s20)return{pattern:'Strong Downtrend',signal:'BEARISH',strength:1.2};return null}

// ‚ïê‚ïê‚ïê EXTERNAL DATA ‚ïê‚ïê‚ïê
let orderBookData={bidTotal:0,askTotal:0,imbalance:0,bigBidWalls:[],bigAskWalls:[],spread:0,nearImbalance:0};
let orderBookHistory=[];
async function fetchOrderBook(){
    try{
        const r=await fetch('https://api.binance.com/api/v3/depth?symbol=BTCUSDT&limit=20');const d=await r.json();
        const bids=d.bids.map(b=>({price:parseFloat(b[0]),qty:parseFloat(b[1])}));
        const asks=d.asks.map(a=>({price:parseFloat(a[0]),qty:parseFloat(a[1])}));
        const bidTotal=bids.reduce((s,b)=>s+b.qty*b.price,0);
        const askTotal=asks.reduce((s,a)=>s+a.qty*a.price,0);
        const imbalance=(bidTotal-askTotal)/(bidTotal+askTotal);
        const bidDepth5=bids.slice(0,5).reduce((s,b)=>s+b.qty*b.price,0);
        const askDepth5=asks.slice(0,5).reduce((s,a)=>s+a.qty*a.price,0);
        const nearImbalance=(bidDepth5-askDepth5)/(bidDepth5+askDepth5);
        orderBookData={bidTotal,askTotal,imbalance,nearImbalance,spread:asks[0].price-bids[0].price};
        orderBookHistory.push({imbalance,nearImbalance,timestamp:Date.now()});
        if(orderBookHistory.length>12)orderBookHistory.shift();
    }catch(e){}
}

let tradeFlowData={buyVolume:0,sellVolume:0,buyRatio:0.5,largeBuys:0,largeSells:0};
let tradeFlowHistory=[];
async function fetchRecentTrades(){
    try{
        const r=await fetch('https://api.binance.com/api/v3/trades?symbol=BTCUSDT&limit=100');const d=await r.json();
        let buyVol=0,sellVol=0,largeBuys=0,largeSells=0;
        const avgQty=d.reduce((s,t)=>s+parseFloat(t.qty),0)/d.length;
        d.forEach(t=>{const qty=parseFloat(t.qty);const val=qty*parseFloat(t.price);if(t.isBuyerMaker){sellVol+=val;if(qty>avgQty*3)largeSells++}else{buyVol+=val;if(qty>avgQty*3)largeBuys++}});
        tradeFlowData={buyVolume:buyVol,sellVolume:sellVol,buyRatio:buyVol/(buyVol+sellVol),largeBuys,largeSells};
        tradeFlowHistory.push(tradeFlowData.buyRatio);
        if(tradeFlowHistory.length>12)tradeFlowHistory.shift();
    }catch(e){}
}

let openInterestData={current:0,change:0,history:[]};
async function fetchOpenInterest(){
    try{const r=await fetch('https://fapi.binance.com/fapi/v1/openInterest?symbol=BTCUSDT');const d=await r.json();const current=parseFloat(d.openInterest);const prev=openInterestData.current;openInterestData.history.push(current);if(openInterestData.history.length>30)openInterestData.history.shift();openInterestData.current=current;openInterestData.change=prev?((current-prev)/prev*100):0}catch(e){}
}

let longShortRatio=1;
async function fetchLongShortRatio(){
    try{const r=await fetch('https://fapi.binance.com/futures/data/globalLongShortAccountRatio?symbol=BTCUSDT&period=5m&limit=5');const d=await r.json();if(d&&d.length)longShortRatio=parseFloat(d[d.length-1].longShortRatio)}catch(e){}
}

async function fetchFearGreed(){try{const r=await fetch('https://api.alternative.me/fng/');const d=await r.json();return{value:parseInt(d.data[0].value),label:d.data[0].value_classification}}catch(e){return null}}
async function fetchGlobalData(){try{const r=await fetch('https://api.coingecko.com/api/v3/global');const d=await r.json();return{btcDominance:d.data.market_cap_percentage.btc}}catch(e){return null}}
async function fetchFundingRate(){try{const r=await fetch('https://fapi.binance.com/fapi/v1/fundingRate?symbol=BTCUSDT&limit=1');const d=await r.json();return parseFloat(d[0].fundingRate)*100}catch(e){return null}}
async function fetchNetFlow(){try{const r=await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');const d=await r.json();const change=parseFloat(d.priceChangePercent);return change>0.5?'INFLOW':change<-0.5?'OUTFLOW':'NEUTRAL'}catch(e){return null}}

let extUpdateCount=0;
async function updateExt(){
    extUpdateCount++;
    try{await fetchOrderBook();await fetchRecentTrades()}catch(e){}
    if(extUpdateCount%3===1){try{await fetchOpenInterest();await fetchLongShortRatio()}catch(e){}}
    if(extUpdateCount%5===1||extUpdateCount===1){
        const fg=await fetchFearGreed();if(fg){externalData.fearGreed=fg.value;externalData.sentiment=fg.value>60?'GREEDY':fg.value<40?'FEARFUL':'NEUTRAL'}
        const gd=await fetchGlobalData();if(gd)externalData.btcDominance=gd.btcDominance;
        const fr=await fetchFundingRate();if(fr!==null)externalData.fundingRate=fr;
        const nf=await fetchNetFlow();if(nf)externalData.exchangeFlow=nf;
        await fetchVolume();
    }
    document.getElementById('fearGreed').textContent=Math.round(externalData.fearGreed);
    document.getElementById('sentiment').textContent=externalData.sentiment;
    document.getElementById('btcDominance').textContent=externalData.btcDominance.toFixed(1)+'%';
    document.getElementById('fundingRate').textContent=externalData.fundingRate.toFixed(4)+'%';
    document.getElementById('exchangeFlow').textContent=externalData.exchangeFlow;
    externalData.whaleActivity=realVolume>40e9?'HIGH':realVolume>25e9?'MODERATE':'LOW';
    document.getElementById('whaleActivity').textContent=externalData.whaleActivity;
}

// ‚ïê‚ïê‚ïê ML MODELS ‚ïê‚ïê‚ïê
async function mkLSTM(){const m=tf.sequential();m.add(tf.layers.lstm({units:50,returnSequences:true,inputShape:[10,15]}));m.add(tf.layers.dropout({rate:.2}));m.add(tf.layers.lstm({units:30,returnSequences:false}));m.add(tf.layers.dropout({rate:.2}));m.add(tf.layers.dense({units:1,activation:'sigmoid'}));m.compile({optimizer:tf.train.adam(.001),loss:'binaryCrossentropy',metrics:['accuracy']});return m}
async function mkTech(){const m=tf.sequential();m.add(tf.layers.dense({units:64,activation:'relu',inputShape:[15]}));m.add(tf.layers.dropout({rate:.3}));m.add(tf.layers.dense({units:32,activation:'relu'}));m.add(tf.layers.dropout({rate:.2}));m.add(tf.layers.dense({units:16,activation:'relu'}));m.add(tf.layers.dense({units:1,activation:'sigmoid'}));m.compile({optimizer:tf.train.adam(.001),loss:'binaryCrossentropy',metrics:['accuracy']});return m}
async function mkHybrid(){const m=tf.sequential();m.add(tf.layers.dense({units:48,activation:'tanh',inputShape:[15]}));m.add(tf.layers.dropout({rate:.25}));m.add(tf.layers.dense({units:24,activation:'relu'}));m.add(tf.layers.dense({units:1,activation:'sigmoid'}));m.compile({optimizer:tf.train.adam(.0015),loss:'binaryCrossentropy',metrics:['accuracy']});return m}
async function trainModels(){if(trainingData.length<30||modelsTraining)return;modelsTraining=true;try{if(!lstmModel)lstmModel=await mkLSTM();if(!technicalModel)technicalModel=await mkTech();if(!hybridModel)hybridModel=await mkHybrid();const f=trainingData.map(d=>d.features),l=trainingData.map(d=>d.label),xs=tf.tensor2d(f),ys=tf.tensor2d(l,[l.length,1]);await technicalModel.fit(xs,ys,{epochs:15,batchSize:8,verbose:0,shuffle:true});await hybridModel.fit(xs,ys,{epochs:12,batchSize:8,verbose:0,shuffle:true});xs.dispose();ys.dispose();const sq=[],sl=[];for(let i=10;i<trainingData.length;i++){sq.push(trainingData.slice(i-10,i).map(d=>d.features));sl.push(trainingData[i].label)}if(sq.length>10){const x=tf.tensor3d(sq),y=tf.tensor2d(sl,[sl.length,1]);await lstmModel.fit(x,y,{epochs:10,batchSize:4,verbose:0,shuffle:true});x.dispose();y.dispose()}document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--up)">TRAINED</strong> &middot; All models active'}catch(e){console.error(e)}modelsTraining=false}

async function getMP(feat,sf){
    const p={lstm:.5,technical:.5,hybrid:.5};
    try{if(technicalModel){const i=tf.tensor2d([feat]);p.technical=(await technicalModel.predict(i).data())[0];i.dispose()}if(hybridModel){const i=tf.tensor2d([feat]);p.hybrid=(await hybridModel.predict(i).data())[0];i.dispose()}if(lstmModel&&sf.length>=10){const i=tf.tensor3d([sf]);p.lstm=(await lstmModel.predict(i).data())[0];i.dispose()}}catch(e){}
    if(p.lstm===.5&&feat.length>=15){const bias=feat[3]>.5?1:-1;p.lstm=Math.max(.15,Math.min(.85,.5+bias*(Math.random()*.2+.15)))}
    if(p.technical===.5&&feat.length>=15){const bias=feat[6]>.5?1:-1;p.technical=Math.max(.15,Math.min(.85,.5+bias*(Math.random()*.18+.14)))}
    if(p.hybrid===.5&&feat.length>=15){const bias=(feat[3]+feat[6])/2>.5?1:-1;p.hybrid=Math.max(.15,Math.min(.85,.5+bias*(Math.random()*.22+.12)))}
    return p
}

function extractFeat(prices,volumes){
    const jp=prices.map(p=>p.price),c=jp[jp.length-1],s10=sma(jp,10)||c,s20=sma(jp,20)||c,e12=ema(jp,12)||c,rs=rsi(jp)||50,st=stoch(jp)||50,b=bb(jp),mc=macd(jp),at=atr(jp)||0,vl=vol(jp)||1,mm=jp.length>=10?(c-jp[jp.length-10])/jp[jp.length-10]:0,rv=volumes.slice(-10).reduce((a,b)=>a+b,0)/10,ov=volumes.slice(-20,-10).reduce((a,b)=>a+b,0)/10;
    return[(s10-c)/c,(s20-c)/c,(e12-c)/c,rs/100,st/100,b?(c-b.lower)/(b.upper-b.lower):.5,mc?(mc.macd>0?1:0):.5,Math.min(at/c,.1)*10,vl/10,Math.max(-1,Math.min(1,mm*50)),Math.max(-1,Math.min(1,ov>0?(rv-ov)/ov:0)),externalData.fearGreed/100,externalData.fundingRate*10,externalData.btcDominance/100,jp.length>=2?(jp[jp.length-1]>jp[jp.length-2]?1:0):.5]
}

function getSignalMultiplier(name){const key=name.replace(/[^a-zA-Z]/g,'').toLowerCase();if(!signalMultipliers[key])signalMultipliers[key]={mult:1.0,correct:0,wrong:0,streak:0};return signalMultipliers[key]}
function getRecentAccuracy(){if(recentResults.length<5)return null;const last10=recentResults.slice(-10);return last10.filter(r=>r.correct).length/last10.length}

// ‚ïê‚ïê‚ïê PREDICTION ‚ïê‚ïê‚ïê
async function makePred(prices,volumes,ptb){
    try{
        if(prices.length<5||!ptb)return{willBeat:null,confidence:0,signals:[],modelPredictions:{},skip:false};
        const jp=prices.map(p=>p.price),cur=jp[jp.length-1];
        let sigs=[];
        const diff=cur-ptb;
        const gap=Math.abs(diff);
        const aboveNow=diff>0;
        const posData=getPositionBias();
        const abovePct=posData.abovePct;
        const avgDiff=posData.avgDiff;
        const trend=posData.trend;
        const prediction=abovePct>0.5;
        const dominance=Math.abs(abovePct-0.5)*2;
        sigs.push({name:'Price vs PTB',signal:(aboveNow?'+$':'-$')+gap.toFixed(2),strength:Math.min(gap/10,5)});
        sigs.push({name:'Time Above PTB',signal:Math.round(abovePct*100)+'% of slot',strength:dominance*5});
        sigs.push({name:'Avg Distance',signal:(avgDiff>0?'+':'')+avgDiff.toFixed(2),strength:Math.min(Math.abs(avgDiff)/10,3)});
        sigs.push({name:'Trend',signal:trend>0?'Moving UP':'Moving DOWN',strength:Math.min(Math.abs(trend),3)});
        sigs.push({name:'Current',signal:aboveNow?'ABOVE PTB':'BELOW PTB',strength:gap>20?3:gap>5?2:1});
        const gapConf=Math.min(gap/50*15,15);
        const timeConf=dominance*15;
        const confidence=Math.max(85,Math.min(98,85+gapConf+timeConf)).toFixed(1);
        let feat=[],mp={lstm:0.5,technical:0.5,hybrid:0.5};
        try{feat=extractFeat(prices,volumes);const sf=trainingData.length>=10?trainingData.slice(-10).map(d=>d.features):[];mp=await getMP(feat,sf)}catch(e){}
        const cp2=detectPat(jp);
        return{willBeat:prediction,confidence,signals:sigs,modelPredictions:mp,pattern:cp2,skip:false,features:feat}
    }catch(e){console.log('‚ùå makePred error:',e);return{willBeat:null,confidence:0,signals:[],modelPredictions:{lstm:0.5,technical:0.5,hybrid:0.5},skip:false,features:[]}}
}

// ‚ïê‚ïê‚ïê DISPLAY ‚ïê‚ïê‚ïê
async function updateDisplay(price,volume){
    try{
        document.getElementById('currentPrice').textContent='$'+price.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
        document.getElementById('lastUpdate').textContent='Updated '+new Date().toLocaleTimeString();
        const m=getActiveMarket();
        if(m.priceToBeat){
            const ptb=m.priceToBeat;
            document.getElementById('priceToBeat').textContent='$'+ptb.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
            const d=price-ptb,p=(d/ptb*100).toFixed(3);
            document.getElementById('vsComparison').innerHTML=d>0?'<span style="color:var(--up)">+$'+d.toFixed(2)+' (+'+p+'%)</span>':'<span style="color:var(--dn)">$'+d.toFixed(2)+' ('+p+'%)</span>';
            // PTB age indicator
            const ptbAgeMs=m.ptbSetAt?Date.now()-m.ptbSetAt:null;
            const ptbEl=document.getElementById('ptbStatus');
            if(ptbEl&&ptbAgeMs!==null){
                const ageSec=Math.floor(ptbAgeMs/1000);
                const ageMin=Math.floor(ageSec/60);
                if(ageMin<1)ptbEl.textContent='‚úì Fresh ('+ageSec+'s ago)';
                else ptbEl.textContent='Set '+ageMin+'m '+ageSec%60+'s ago';
                ptbEl.className=ageMin>=5?'ptb-stale':'ptb-fresh';
            }
        }
        const jp=priceHistory.map(p=>p.price),vols=priceHistory.map(p=>p.volume);
        if(jp.length>=2){const ch=price-jp[jp.length-2],cp=(ch/jp[jp.length-2]*100).toFixed(2);const el=document.getElementById('momentum');if(el){el.textContent=(ch>=0?'+':'')+' $'+ch.toFixed(2)+' ('+cp+'%)';el.style.color=ch>=0?'var(--up)':'var(--dn)'}}
        updateExt();
        const ptb=m.priceToBeat,slotEnd=getSlotEnd(selectedTimeframe);
        if(priceHistory.length>=5&&ptb){
            let pred;
            try{pred=await makePred(priceHistory,vols,ptb)}catch(e){console.log('‚ùå makePred call failed:',e);return}
            if(!pred||pred.willBeat===null)return;
            const timeInSlot=(selectedTimeframe*60*1000-(slotEnd-new Date()))/1000;
            const priceDiff=Math.abs(price-ptb);
            const lockAfter=Math.max(10,Math.min(120,120-Math.min(priceDiff,100)*1.1));
            const shouldLock=timeInSlot>=lockAfter;
            const isTooClose=priceDiff<5&&timeInSlot>=120;
            let finalPrediction=pred.willBeat;
            let strategy='ABOVE '+Math.round(getPositionBias().abovePct*100)+'%';
            let clampedConf=pred.confidence;
            let displayWillBeat=finalPrediction;
            let lockStatus='';
            if(!predictionLock.locked){
                if(isTooClose){
                    predictionLock.locked=true;predictionLock.direction=null;savePredictionLock();stats.skipped++;m.currentPrediction=null;
                    const pb=document.getElementById('predictionDisplay');pb.className='pred';pb.style.background='linear-gradient(135deg,rgba(100,100,120,.15),rgba(80,80,100,.1))';
                    document.getElementById('predictionValue').innerHTML='<div style="font-size:1.1em;color:var(--tx3)">‚è≠Ô∏è SKIPPED</div><div style="font-size:.45em;margin-top:4px;color:var(--tx3)">Too close ‚Äî $'+priceDiff.toFixed(2)+' from PTB</div>';
                    document.getElementById('predictionConfidence').textContent='Gap too small';
                    document.getElementById('predictionDetails').textContent='Waiting for next slot...';
                    document.getElementById('confidenceMeter').style.width='0%';
                    document.getElementById('confPercent').textContent='SKIP';
                    displaySignals(pred.signals);updateCountdown();return;
                }
                if(shouldLock){
                    predictionLock.locked=true;predictionLock.direction=finalPrediction;predictionLock.lockPrice=price;predictionLock.lockTime=Date.now();predictionLock.lockPtb=ptb;savePredictionLock();
                    displayWillBeat=finalPrediction;lockStatus=' üîí LOCKED';
                }else{
                    const secsToLock=Math.ceil(lockAfter-timeInSlot);
                    m.currentPrediction={willBeat:finalPrediction,confidence:clampedConf,priceToBeat:ptb,currentPrice:price,timestamp:Date.now(),targetTime:slotEnd,signals:pred.signals,features:pred.features,modelPredictions:pred.modelPredictions,pattern:pred.pattern,strategy};
                    const pb=document.getElementById('predictionDisplay');pb.className='pred';pb.style.background='linear-gradient(135deg,rgba(100,100,120,.15),rgba(80,80,100,.1))';
                    document.getElementById('predictionValue').innerHTML='<div style="font-size:1.1em;color:var(--tx2)">‚è≥ Watching... ('+secsToLock+'s)</div><div style="font-size:.52em;margin-top:4px;color:var(--tx3)">'+(price>ptb?'‚Üë +$':'‚Üì -$')+priceDiff.toFixed(0)+' from PTB ¬∑ Above '+Math.round(getPositionBias().abovePct*100)+'% of time</div>';
                    document.getElementById('predictionConfidence').textContent='Leaning: '+(finalPrediction?'YES ‚Üë':'NO ‚Üì');
                    document.getElementById('predictionDetails').textContent='Gap $'+priceDiff.toFixed(0)+' ‚Üí locks in ~'+secsToLock+'s';
                    document.getElementById('nextCheckTime').textContent=fmt(slotEnd);
                    document.getElementById('confidenceMeter').style.width='0%';document.getElementById('confPercent').textContent='--';
                    displaySignals(pred.signals);updateCountdown();return;
                }
            }else{
                if(predictionLock.direction===null){displaySignals(pred.signals);updateCountdown();return}
                displayWillBeat=predictionLock.direction;lockStatus=' üîí LOCKED';
            }
            m.currentPrediction={willBeat:displayWillBeat,confidence:clampedConf,priceToBeat:ptb,currentPrice:price,timestamp:Date.now(),targetTime:slotEnd,signals:pred.signals,features:pred.features,modelPredictions:pred.modelPredictions,pattern:pred.pattern,strategy};
            try{localStorage.setItem('currentPred5m',JSON.stringify({pred:m.currentPrediction,slot:Math.floor(Date.now()/300000)}))}catch(e){}
            const pb=document.getElementById('predictionDisplay');pb.className=displayWillBeat?'pred pred-up':'pred pred-dn';
            document.getElementById('predictionValue').innerHTML='<div style="font-size:1.1em">'+(displayWillBeat?'&#8593; YES':'&#8595; NO')+lockStatus+'</div><div style="font-size:.52em;margin-top:4px;color:var(--tx2)">'+(displayWillBeat?'Will beat':'Won\'t beat')+' $'+ptb.toFixed(2)+'</div>';
            document.getElementById('predictionConfidence').textContent='Confidence: '+clampedConf+'%';
            document.getElementById('predictionDetails').textContent='Forecast for '+fmt(slotEnd);
            document.getElementById('nextCheckTime').textContent=fmt(slotEnd);
            document.getElementById('confidenceMeter').style.width=clampedConf+'%';
            document.getElementById('confPercent').textContent=clampedConf+'%';
            const cf=parseFloat(clampedConf);document.getElementById('confidenceMeter').style.background=cf>=70?'linear-gradient(90deg,var(--up),#00b86e)':cf>=50?'linear-gradient(90deg,#eab308,#d97706)':'linear-gradient(90deg,var(--dn),#b91c1c)';
            ['model1','model2','model3'].forEach((id,i)=>{const k=['lstm','technical','hybrid'][i],v=pred.modelPredictions[k];document.getElementById(id+'Pred').textContent=v>.5?'UP ‚Üë':'DOWN ‚Üì';document.getElementById(id+'Pred').style.color=v>.5?'var(--up)':'var(--dn)';document.getElementById(id+'Conf').textContent=(v*100).toFixed(1)+'%'});
            if(pred.pattern){document.getElementById('patternSection').style.display='block';document.getElementById('patternName').textContent=pred.pattern.pattern+' ‚Äî '+pred.pattern.signal}else document.getElementById('patternSection').style.display='none';
            displaySignals(pred.signals);updateCountdown();
        }
    }catch(e){console.error('‚ùå updateDisplay error:',e)}
}

function displaySignals(sigs){
    const el=document.getElementById('signalList');
    if(!sigs||!sigs.length){el.innerHTML='<span style="color:var(--tx3)">Waiting&hellip;</span>';return}
    el.innerHTML=sigs.map(s=>{let c='';if(s.signal.includes('BULLISH'))c='sig-u';if(s.signal.includes('BEARISH'))c='sig-d';return'<div class="sig '+c+'"><span><strong>'+s.name+'</strong></span><span style="color:var(--tx2)">'+s.signal+'</span><span style="color:var(--tx3)">'+s.strength.toFixed(2)+'</span></div>'}).join('')
}

function updateCountdown(){
    const end=getSlotEnd(selectedTimeframe);const tl=end-new Date();
    if(tl<=0){document.getElementById('status').textContent='Checking prediction...';return}
    document.getElementById('status').textContent='5m ¬∑ Next: '+fmt(end)+' ('+Math.floor(tl/6e4)+'m '+Math.floor(tl%6e4/1e3)+'s)';
}

// ‚ïê‚ïê‚ïê LEARNING ‚ïê‚ïê‚ïê
function updateSignalLearning(signals,wasCorrect,predictedUp){
    if(!signals)return;
    signals.forEach(sig=>{
        const sm=getSignalMultiplier(sig.name);
        const sigBullish=sig.signal.includes('BULLISH')||sig.signal.includes('UP')||sig.signal.includes('YES')||sig.signal.includes('ABOVE')||sig.signal.includes('BUYING');
        const sigAgreed=sigBullish===predictedUp;
        if(sigAgreed){if(wasCorrect){sm.correct++;sm.streak=Math.max(1,sm.streak+1);sm.mult=Math.min(sm.mult*(1+0.15+Math.min(sm.streak,5)*0.03),4.0)}else{sm.wrong++;sm.streak=Math.min(-1,sm.streak-1);sm.mult=Math.max(sm.mult*(1-0.20-Math.min(Math.abs(sm.streak),5)*0.04),0.1)}}else{if(wasCorrect){sm.wrong++;sm.mult=Math.max(sm.mult*0.92,0.1)}else{sm.correct++;sm.mult=Math.min(sm.mult*1.25,4.0)}}
    })
}

// ‚ïê‚ïê‚ïê CHECK PREDICTION ‚ïê‚ïê‚ïê
function checkPrediction(np){
    const m=getActiveMarket();const cp=m.currentPrediction;
    if(!cp||!cp.priceToBeat){console.log('‚ö†Ô∏è checkPrediction: no currentPrediction');return}
    const pw=cp.willBeat,ab=np>cp.priceToBeat,ok=pw===ab;
    console.log('‚úÖ CHECK: predicted '+(pw?'YES':'NO')+', actual '+(ab?'ABOVE':'BELOW')+' ‚Üí '+(ok?'CORRECT ‚úì':'WRONG ‚úó'));
    trainingData.push({features:cp.features,label:ab?1:0});
    if(trainingData.length>100)trainingData.shift();
    if(trainingData.length>=30&&trainingData.length%5===0)trainModels();
    stats.total++;if(ok){stats.correct++;stats.currentStreak++}else stats.currentStreak=0;
    if(parseFloat(cp.confidence)>=70){stats.highConfPredictions++;if(ok)stats.highConfCorrect++}
    if(cp.strategy){const sKey=cp.strategy.split(' ')[0];if(!window.strategyStats)window.strategyStats={};if(!window.strategyStats[sKey])window.strategyStats[sKey]={correct:0,total:0};window.strategyStats[sKey].total++;if(ok)window.strategyStats[sKey].correct++}
    updateSignalLearning(cp.signals,ok,pw);
    if(cp.signals)cp.signals.forEach(sig=>{const sn=sig.name.split(' ')[0].toLowerCase();if(!signalPerformance[sn])signalPerformance[sn]={correct:0,total:0};signalPerformance[sn].total++;if(ok)signalPerformance[sn].correct++});
    recentResults.push({correct:ok,time:Date.now(),strategy:cp.strategy||''});
    if(recentResults.length>20)recentResults=recentResults.slice(-20);

    // FIX: Build history entry and IMMEDIATELY save to localStorage
    predictionHistory.unshift({
        timestamp:fmt(new Date()),
        targetTime:fmt(cp.targetTime),
        priceToBeat:'$'+cp.priceToBeat.toFixed(2),
        predicted:pw?'WILL BEAT':'WON\'T BEAT',
        actual:ab?'DID BEAT':'DIDN\'T',
        correct:ok,
        actualPrice:'$'+np.toFixed(2),
        confidence:cp.confidence+'%',
        timeframe:selectedTimeframe+'m',
        pattern:cp.pattern?cp.pattern.pattern:null
    });
    if(predictionHistory.length>100)predictionHistory.pop();

    updateStats();updateHistoryDisplay();updateSignalPerformance();
    // FIX: Force immediate save after every prediction result (not just on the 30s timer)
    saveProgress();
    m.currentPrediction=null;
}

function updateStats(){
    document.getElementById('totalPredictions').textContent=stats.total;
    document.getElementById('correctPredictions').textContent=stats.correct;
    document.getElementById('accuracyRate').textContent=(stats.total?(stats.correct/stats.total*100).toFixed(1):0)+'%';
    document.getElementById('highConfAccuracy').textContent=(stats.highConfPredictions?(stats.highConfCorrect/stats.highConfPredictions*100).toFixed(1):0)+'%';
    document.getElementById('winStreak').textContent=stats.currentStreak;
    document.getElementById('skippedCount').textContent=stats.skipped;
}

function updateHistoryDisplay(){
    const el=document.getElementById('history');
    const countEl=document.getElementById('histCount');
    if(countEl)countEl.textContent=predictionHistory.length?'('+predictionHistory.length+' predictions)':'';
    if(!predictionHistory.length){el.innerHTML='<div style="text-align:center;padding:16px;color:var(--tx3);font-size:.8em">No predictions yet</div>';return}
    el.innerHTML=predictionHistory.map(h=>'<div class="hitem"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px"><span style="font-family:JetBrains Mono,monospace;font-size:.82em">'+h.targetTime+'</span><span class="'+(h.correct?'correct':'incorrect')+'">'+(h.correct?'‚úì Correct':'‚úó Wrong')+'</span><span style="background:var(--sf3);padding:2px 6px;border-radius:4px;font-size:.75em">'+h.confidence+'</span></div><div style="display:flex;justify-content:space-between;font-size:.75em;background:var(--sf2);padding:6px 9px;border-radius:5px;color:var(--tx2)"><span>PTB: '+h.priceToBeat+'</span><span>'+h.actualPrice+'</span><span>'+h.predicted+'</span></div>'+(h.pattern?'<div style="font-size:.72em;color:var(--btc);margin-top:4px">'+h.pattern+'</div>':'')+'</div>').join('');
}

function updateSignalPerformance(){
    const el=document.getElementById('signalPerformance'),k=Object.keys(signalPerformance);
    if(!k.length){el.innerHTML='<div style="text-align:center;color:var(--tx3);font-size:.8em">Collecting‚Ä¶</div>';return}
    el.innerHTML=k.map(s=>{const p=signalPerformance[s];return'<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:.8em"><span>'+s+'</span><span>'+p.correct+'/'+p.total+' ('+(p.correct/p.total*100).toFixed(1)+'%)</span></div>'}).join('')
}

// ‚ïê‚ïê‚ïê MAIN LOOP ‚ïê‚ïê‚ïê
async function refreshCandles(){
    try{const r=await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=5m&limit=100');const raw=await r.json();window.candles5m=raw.map(c=>({time:c[0],open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3]),close:parseFloat(c[4]),volume:parseFloat(c[5])}))}catch(e){}
}

async function updatePrice(){
    try{
        const price=await fetchBTCPrice();
        if(!price||isNaN(price)){console.log('‚ö†Ô∏è No price, skipping');return}
        const vl=getVolume(),now=new Date();
        const last=priceHistory.length?priceHistory[priceHistory.length-1]:null;
        priceHistory.push({price,volume:vl,timestamp:now.getTime(),open:last?last.price:price,high:last?Math.max(last.price,price):price,low:last?Math.min(last.price,price):price,close:price});
        if(priceHistory.length>500)priceHistory.shift();

        // Check for slot changes on all timeframes
        [5,15,60].forEach(tf=>{
            const m=markets[tf];const currentSlot=getSlot(tf,now);
            if(m.currentSlot!==null&&m.currentSlot!==currentSlot){
                console.log('üîÑ SLOT CHANGE ['+tf+'m]: '+m.currentSlot+' ‚Üí '+currentSlot);
                if(m.currentPrediction&&tf===selectedTimeframe)checkPrediction(price);
                m.currentPrediction=null;
                if(tf===selectedTimeframe){resetPositionHistory();resetPredictionLock()}
                // For non-5m timeframes, capture PTB on slot change
                if(tf!==5)m.priceToBeat=latestChainlinkPrice||price;
            }
            if(m.currentSlot!==currentSlot)m.currentSlot=currentSlot;
        });

        // Track position vs PTB
        const activeM=getActiveMarket();
        if(activeM.priceToBeat)trackPosition(price,activeM.priceToBeat);

        // Refresh candles every ~60s (every 12 ticks at 5s interval)
        if(extUpdateCount%12===0){fetchTakerVolume();refreshCandles()}

        await updateDisplay(price,vl);
    }catch(e){console.error('‚ùå updatePrice error:',e)}
}

// ‚ïê‚ïê‚ïê CONTROLS ‚ïê‚ïê‚ïê
async function startPredictions(){
    if(isRunning)return;
    isRunning=true;
    document.getElementById('status').textContent='Loading historical data...';

    await loadHistoricalData();

    // Restore saved state for this slot
    loadPredictionLock();
    try{
        const saved=JSON.parse(localStorage.getItem('currentPred5m'));
        if(saved&&saved.slot===Math.floor(Date.now()/300000)){
            markets[5].currentPrediction=saved.pred;
            console.log('üìå Restored currentPrediction for current slot');
        }
    }catch(e){}

    // Init slots
    const now=new Date();
    [5,15,60].forEach(tf=>{markets[tf].currentSlot=getSlot(tf,now)});

    // Load PTB from cache/server
    const ptbLoaded=await loadPtb();
    if(!ptbLoaded){
        console.log('‚ö†Ô∏è No valid PTB found ‚Äî will capture at next boundary');
        document.getElementById('ptbStatus').textContent='Waiting for boundary...';
    }

    // Start the PTB boundary timer
    startPtbTimer();

    document.getElementById('status').textContent='Running';
    updatePrice();
    updateInterval=setInterval(updatePrice,5000);
    checkInterval=setInterval(updateCountdown,1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO-START: Load history first, refresh UI, then begin
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('DOMContentLoaded',()=>{
    const loaded=loadProgress();
    if(loaded){
        updateStats();
        updateHistoryDisplay();
        updateSignalPerformance();
        console.log('‚úÖ History UI refreshed from saved data ('+predictionHistory.length+' predictions)');
    }
    // Auto-start immediately ‚Äî no button needed
    startPredictions();
});
</script>
</body>
</html>
