<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Polymarket Bitcoin Prediction Bot ‚Äî Free</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#08090d;--sf:#13151c;--sf2:#1a1c25;--bd:rgba(255,255,255,.06);--tx:#edeef2;--tx2:#a0a5b8;--tx3:#5d6277;--btc:#f7931a;--up:#22c55e;--dn:#ff4757;--rs:12px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;-webkit-font-smoothing:antialiased}
        .shell{max-width:680px;margin:0 auto;padding:20px}
        .nav{display:flex;align-items:center;gap:14px;padding:14px 0;margin-bottom:10px}
        .nav-mark{font-size:1.5em;color:var(--btc)}
        .nav-text h1{font-size:1em;font-weight:600;letter-spacing:-.01em}
        .nav-text span{font-size:.68em;color:var(--tx3)}
        .nav-right{margin-left:auto;display:flex;gap:8px;align-items:center}
        .btn{padding:6px 14px;border:none;border-radius:8px;font-size:.72em;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s}
        .btn-btc{background:linear-gradient(140deg,var(--btc),#e07c0e);color:#fff;box-shadow:0 4px 16px rgba(247,147,26,.2)}
        .btn-btc:hover{transform:translateY(-1px);box-shadow:0 6px 24px rgba(247,147,26,.3)}
        .disc{font-size:.68em;color:var(--tx3);padding:8px 14px;background:var(--sf);border-radius:10px;margin-bottom:14px;border:1px solid var(--bd);display:flex;align-items:center;gap:8px}
        .badge{display:inline-block;background:rgba(34,197,94,.1);color:var(--up);font-size:.62em;font-weight:700;padding:2px 8px;border-radius:6px;letter-spacing:.08em;margin-left:8px}
        .card{background:var(--sf);border:1px solid var(--bd);border-radius:var(--rs);padding:20px;margin-bottom:12px}
        .ct{font-size:.65em;font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--tx3);margin-bottom:14px}
        .g2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        .plbl{font-size:.65em;text-transform:uppercase;letter-spacing:.1em;color:var(--tx3);margin-bottom:4px}
        .pbig{font-family:'JetBrains Mono',monospace;font-size:1.8em;font-weight:700}
        .psub{font-size:.7em;color:var(--tx3)}
        .vs{text-align:center;padding:10px;background:var(--sf2);border-radius:8px;margin-top:12px}
        .vsl{font-size:.62em;color:var(--tx3);text-transform:uppercase;letter-spacing:.1em}
        .vsv{font-family:'JetBrains Mono',monospace;font-size:1em;font-weight:700;margin-top:2px}
        .pred{border-radius:var(--rs);padding:28px 20px;text-align:center;transition:all .3s}
        .pred-up{background:linear-gradient(135deg,rgba(34,197,94,.08),rgba(34,197,94,.02));border:1px solid rgba(34,197,94,.12)}
        .pred-dn{background:linear-gradient(135deg,rgba(255,71,87,.08),rgba(255,71,87,.02));border:1px solid rgba(255,71,87,.12)}
        .pred-nu{background:var(--sf2);border:1px solid var(--bd)}
        .val{font-size:2.2em;font-weight:700}
        .conf{font-size:.82em;color:var(--tx2);margin-top:4px}
        .cftrack{height:5px;background:var(--sf2);border-radius:3px;overflow:hidden;margin-top:12px}
        .cffill{height:100%;border-radius:3px;transition:width .5s ease}
        .cflbl{display:flex;justify-content:space-between;font-size:.7em;color:var(--tx2);margin-top:14px;margin-bottom:4px}
        .status{font-size:.82em;color:var(--tx2);padding:10px 0;text-align:center}
        .countdown{font-family:'JetBrains Mono',monospace;font-size:1.5em;font-weight:700;color:var(--btc);text-align:center;margin:12px 0}
        .sig{display:flex;justify-content:space-between;align-items:center;padding:7px 10px;margin:3px 0;background:var(--sf2);border-radius:6px;font-size:.75em;border-left:3px solid var(--bd)}
        .sig-u{border-left-color:var(--up)}.sig-d{border-left-color:var(--dn)}
        .upgrade{background:linear-gradient(135deg,rgba(247,147,26,.06),rgba(247,147,26,.02));border:1.5px solid rgba(247,147,26,.15);border-radius:var(--rs);padding:20px;text-align:center;margin-top:14px}
        .upgrade h3{color:var(--btc);font-size:.95em;margin-bottom:4px}
        .upgrade p{font-size:.78em;color:var(--tx3);margin-bottom:12px}
        .echip{background:var(--sf2);border:1px solid var(--bd);border-radius:8px;padding:10px 14px;text-align:center}
        .echip .cl{font-size:.6em;color:var(--tx3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px}
        .echip .cv{font-family:'JetBrains Mono',monospace;font-size:.88em;font-weight:600}
        .g3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
        @media(max-width:500px){.shell{padding:12px}.pbig{font-size:1.4em}.val{font-size:1.8em}}
    </style>
</head>
<body>
<div class="shell">
    <nav class="nav">
        <div class="nav-mark">&#8383;</div>
        <div class="nav-text"><h1>Polymarket BTC Predictor<span class="badge">FREE</span></h1><span>1-Hour Predictions &middot; Chainlink BTC/USD</span></div>
        <div class="nav-right">
            <button class="btn btn-btc" onclick="window.location.href='/'">Upgrade to 5-Min</button>
        </div>
    </nav>

    <div class="disc">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        Free tier ‚Äî predictions every 1 hour. Not financial advice.
    </div>

    <div class="card">
        <div class="ct">Market</div>
        <div class="status" id="status">Loading...</div>
        <div class="g2" style="margin-top:12px">
            <div style="text-align:center"><div class="plbl">Price to Beat</div><div class="pbig" id="priceToBeat" style="color:var(--tx2)">--</div><div class="psub" id="ptbTime">Set at hour mark</div></div>
            <div style="text-align:center"><div class="plbl">Current BTC Price</div><div class="pbig" id="currentPrice" style="color:var(--btc)">--</div><div class="psub" id="lastUpdate">--</div></div>
        </div>
        <div class="vs"><div class="vsl">Current vs Target</div><div class="vsv" id="vsComparison">--</div></div>
    </div>

    <div class="card">
        <div class="ct">Prediction</div>
        <div class="pred pred-nu" id="predDisplay">
            <div class="val" id="predValue">--</div>
            <div class="conf" id="predConf">Waiting for data...</div>
        </div>
        <div><div class="cflbl"><span>Confidence</span><span id="confPct">0%</span></div><div class="cftrack"><div class="cffill" id="confBar" style="width:0%"></div></div></div>
        <div style="text-align:center;margin-top:14px">
            <div class="plbl">Next prediction</div>
            <div class="countdown" id="countdown">--:--</div>
        </div>
        <div style="margin-top:14px"><div class="ct">Signals</div><div id="signals" style="color:var(--tx3);font-size:.78em">Collecting data...</div></div>
    </div>

    <div class="card">
        <div class="ct">Sentiment</div>
        <div class="g3">
            <div class="echip"><div class="cl">Fear/Greed</div><div class="cv" id="fearGreed">--</div></div>
            <div class="echip"><div class="cl">Sentiment</div><div class="cv" id="sentiment">--</div></div>
            <div class="echip"><div class="cl">Funding</div><div class="cv" id="funding">--</div></div>
        </div>
    </div>

    <div class="upgrade">
        <h3>‚ö° Want 5-Minute Predictions?</h3>
        <p>Get faster predictions with orderbook analysis, candle patterns, whale tracking, and ML strategy learning.</p>
        <button class="btn btn-btc" onclick="window.location.href='/'">Get Pro Access</button>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê FREE TIER: 1-HOUR BTC PREDICTION ‚ïê‚ïê‚ïê
// Improved scoring engine inspired by pro ensemble system
let btcPrice=null,ptb=null,ptbSetAt=null,locked=false,prediction=null;

// ‚ïê‚ïê‚ïê PRICE FEEDS ‚ïê‚ïê‚ïê
// Display: crypto_prices (Binance via Polymarket RTDS) ‚Äî matches Polymarket UI
// PTB: Binance 1H candle open via REST API ‚Äî exact settlement source
let btcWs=null,latestBtcPrice=null;
let polyWs=null,latestChainlinkPrice=null;
let displayPrice=null;

function connectPolyWs(){
  try{
    polyWs=new WebSocket('wss://ws-live-data.polymarket.com');
    polyWs.onopen=function(){
      polyWs.send(JSON.stringify({
        action:'subscribe',
        subscriptions:[{topic:'crypto_prices_chainlink',type:'*',filters:'{"symbol":"btc/usd"}'}]
      }));
      polyWs.send(JSON.stringify({
        action:'subscribe',
        subscriptions:[{topic:'crypto_prices',type:'update'}]
      }));
      console.log('Connected to Polymarket RTDS');
    };
    polyWs.onmessage=function(e){
      try{
        const d=JSON.parse(e.data);
        if(d.topic==='crypto_prices_chainlink'&&d.payload&&d.payload.symbol==='btc/usd'){
          latestChainlinkPrice=d.payload.value;
          latestBtcPrice=d.payload.value;
          btcPrice=d.payload.value;
          if(!displayPrice){displayPrice=d.payload.value;updateUI();}
        }
        if(d.topic==='crypto_prices'&&d.payload){
          const sym=(d.payload.symbol||'').toLowerCase();
          if(sym==='btcusdt'){
            displayPrice=d.payload.value;
            if(!latestChainlinkPrice){latestBtcPrice=d.payload.value;btcPrice=d.payload.value;}
            updateUI();
          }
        }
      }catch(ex){}
    };
    let pingInterval=setInterval(()=>{
      if(polyWs.readyState===1)polyWs.send('PING');
      else{clearInterval(pingInterval)}
    },5000);
    polyWs.onclose=function(){clearInterval(pingInterval);setTimeout(connectPolyWs,3000)};
    polyWs.onerror=function(){polyWs.close()};
  }catch(e){setTimeout(connectPolyWs,5000)}
}

// BACKUP: Direct Binance WebSocket
function connectBtcWs(){try{btcWs=new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');btcWs.onmessage=function(e){const d=JSON.parse(e.data);const p=parseFloat(d.p);if(!displayPrice){displayPrice=p;if(!btcPrice)btcPrice=p;updateUI()}};btcWs.onclose=function(){setTimeout(connectBtcWs,3000)};btcWs.onerror=function(){btcWs.close()}}catch(e){setTimeout(connectBtcWs,5000)}}
connectPolyWs();
connectBtcWs();

// If crypto_prices never arrives after 5 seconds, use Chainlink for display
setTimeout(()=>{
  if(!displayPrice&&latestChainlinkPrice){
    console.log('‚ö†Ô∏è crypto_prices not arriving, using Chainlink for display');
    setInterval(()=>{
      if(latestChainlinkPrice){displayPrice=latestChainlinkPrice;updateUI();}
    },1000);
  }
},5000);

// ‚ïê‚ïê‚ïê PTB: Binance 1H candle open ‚Äî exact Polymarket hourly settlement source ‚ïê‚ïê‚ïê
let ptbHour=-1;

// Fetch exact Binance 1H candle open price
async function fetchBinanceHourlyOpen(){
    try{
        const r=await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1h&limit=1');
        const d=await r.json();
        if(d&&d[0]){
            const openPrice=parseFloat(d[0][1]); // [1] = open price
            console.log('üìä Binance 1H candle open: $'+openPrice.toFixed(2));
            return openPrice;
        }
    }catch(e){console.log('‚ö†Ô∏è Binance API fetch failed:',e)}
    return null;
}

// Save PTB to server + localStorage
function savePtb(price){
    const hour=new Date().getUTCHours();
    localStorage.setItem('ptb_hourly',JSON.stringify({price,hour,ts:Date.now()}));
    fetch('/api/ptb-hourly',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({price,hour})}).catch(()=>{});
}

// Load PTB ‚Äî try Binance API first (exact), then server, then localStorage
async function loadPtb(){
    const currentHour=new Date().getUTCHours();
    const minutesIn=new Date().getMinutes();
    
    // If we're past minute 0, fetch the current 1H candle open from Binance (the definitive PTB)
    if(minutesIn>=1){
        const binanceOpen=await fetchBinanceHourlyOpen();
        if(binanceOpen&&binanceOpen>30000&&binanceOpen<200000){
            ptb=binanceOpen;
            ptbSetAt=new Date();
            ptbSetAt.setMinutes(0,0,0);
            ptbHour=currentHour;
            savePtb(binanceOpen);
            console.log('üìå PTB from Binance 1H candle open: $'+binanceOpen.toFixed(2));
            return;
        }
    }
    
    // Try server
    try{
        const r=await fetch('/api/ptb-hourly');
        const d=await r.json();
        if(d.price&&d.hour===currentHour&&d.price>30000&&d.price<200000){
            ptb=d.price;
            ptbSetAt=new Date();
            ptbSetAt.setMinutes(0,0,0);
            ptbHour=currentHour;
            console.log('üìå PTB from server: $'+d.price.toFixed(2));
            return;
        }
    }catch(e){}
    
    // Try localStorage
    try{
        const d=JSON.parse(localStorage.getItem('ptb_hourly'));
        if(d&&d.hour===currentHour&&d.price>30000&&d.price<200000&&(Date.now()-d.ts)<3600000){
            ptb=d.price;
            ptbSetAt=new Date();
            ptbSetAt.setMinutes(0,0,0);
            ptbHour=currentHour;
            console.log('üìå PTB from cache: $'+d.price.toFixed(2));
            return;
        }
    }catch(e){}
    
    console.log('‚è≥ No PTB available yet ‚Äî waiting for next hour boundary');
}
loadPtb();

// Timer at exact hour boundary ‚Äî then confirm with Binance REST API 5s later
function startPtbTimer(){
    const now=Date.now();
    const hourMs=3600000;
    const nextBoundary=Math.ceil(now/hourMs)*hourMs;
    const delay=nextBoundary-now;
    
    console.log('‚è±Ô∏è Next PTB capture in '+(delay/1000/60).toFixed(1)+' minutes');
    
    async function captureHourlyPtb(){
        locked=false;
        prediction=null;
        ptbHour=new Date().getUTCHours();
        ptbSetAt=new Date();
        
        // Wait 5 seconds for Binance candle to finalize, then fetch exact open
        setTimeout(async()=>{
            const binanceOpen=await fetchBinanceHourlyOpen();
            if(binanceOpen){
                ptb=binanceOpen;
                savePtb(binanceOpen);
                console.log('üéØ HOURLY PTB SET (Binance candle open): $'+binanceOpen.toFixed(2)+' at '+new Date().toLocaleTimeString());
                updateUI();
            }
        },5000);
    }
    
    setTimeout(()=>{
        captureHourlyPtb();
        setInterval(captureHourlyPtb,hourMs);
    },delay);
}
startPtbTimer();

// Retry loading PTB from server every 10s if we don't have one (someone else might save it)
function retryPtbFromServer(){
    if(ptb)return; // Already have one
    const interval=setInterval(async()=>{
        if(ptb){clearInterval(interval);return;}
        try{
            const currentHour=new Date().getUTCHours();
            const r=await fetch('/api/ptb-hourly');
            const d=await r.json();
            if(d.price&&d.hour===currentHour){
                ptb=d.price;
                ptbSetAt=new Date();
                ptbSetAt.setMinutes(0,0,0);
                ptbHour=currentHour;
                console.log('üìå PTB from server (retry): $'+d.price.toFixed(2));
                clearInterval(interval);
            }
        }catch(e){}
    },10000);
    // Stop retrying after 5 minutes
    setTimeout(()=>clearInterval(interval),300000);
}
retryPtbFromServer();

function getHourEnd(){
    const now=new Date();
    const next=new Date(now);
    next.setMinutes(0,0,0);
    next.setHours(next.getHours()+1);
    return next;
}

function getHourStart(){
    const now=new Date();
    const start=new Date(now);
    start.setMinutes(0,0,0);
    return start;
}

// checkPtb is now a no-op ‚Äî PTB comes from server or timer only
function checkPtb(){}

// RSI calculation
function calcRsi(prices,period){
    if(prices.length<period+1)return null;
    let gains=0,losses=0;
    for(let i=prices.length-period;i<prices.length;i++){
        const diff=prices[i]-prices[i-1];
        if(diff>0)gains+=diff;else losses-=diff;
    }
    const rs=gains/Math.max(losses,0.001);
    return 100-(100/(1+rs));
}

// Price history for indicators
let priceHistory=[];
let sentimentData={fearGreed:null,sentiment:null,funding:null};

// Fetch sentiment
async function fetchSentiment(){
    try{
        const r=await fetch('https://api.alternative.me/fng/');
        const d=await r.json();
        if(d.data&&d.data[0]){
            sentimentData.fearGreed=d.data[0].value+' ('+d.data[0].value_classification+')';
            document.getElementById('fearGreed').textContent=sentimentData.fearGreed;
        }
    }catch(e){}
    try{
        const r=await fetch('https://fapi.binance.com/fapi/v1/fundingRate?symbol=BTCUSDT&limit=1');
        const d=await r.json();
        if(d[0]){
            const rate=(parseFloat(d[0].fundingRate)*100).toFixed(4)+'%';
            sentimentData.funding=rate;
            document.getElementById('funding').textContent=rate;
        }
    }catch(e){}
    try{
        const r=await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=BTCUSDT');
        const d=await r.json();
        const change=parseFloat(d.priceChangePercent);
        sentimentData.sentiment=change>1?'Bullish':change<-1?'Bearish':'Neutral';
        document.getElementById('sentiment').textContent=sentimentData.sentiment;
        document.getElementById('sentiment').style.color=change>1?'var(--up)':change<-1?'var(--dn)':'var(--tx2)';
    }catch(e){}
}

// ‚ïê‚ïê‚ïê INDICATOR HELPERS ‚ïê‚ïê‚ïê
function sma(d,p){if(d.length<p)return null;return d.slice(-p).reduce((a,b)=>a+b,0)/p}
function ema(d,p){if(d.length<p)return null;const k=2/(p+1);let e=sma(d.slice(0,p),p);for(let i=p;i<d.length;i++)e=d[i]*k+e*(1-k);return e}
function macd(d){if(d.length<26)return null;const m=ema(d,12)-ema(d,26);return{macd:m,bullish:m>0}}
function bollingerBands(d,p=20){if(d.length<p)return null;const avg=sma(d,p);const std=Math.sqrt(d.slice(-p).reduce((s,x)=>s+Math.pow(x-avg,2),0)/p);return{upper:avg+2*std,lower:avg-2*std,mid:avg,pos:(d[d.length-1]-(avg-2*std))/(4*std)}}
function stochastic(d,p=14){if(d.length<p)return null;const s=d.slice(-p),h=Math.max(...s),l=Math.min(...s);if(h===l)return 50;return((d[d.length-1]-l)/(h-l))*100}
function meanReversionZ(d,p=20){if(d.length<p)return null;const avg=sma(d,p);const std=Math.sqrt(d.slice(-p).reduce((s,x)=>s+Math.pow(x-avg,2),0)/p);return std?(d[d.length-1]-avg)/std:0}
function emaCrossover(d){if(d.length<25)return null;const e9=ema(d,9),e21=ema(d,21);if(!e9||!e21)return null;const e9p=ema(d.slice(0,-1),9),e21p=ema(d.slice(0,-1),21);return{bullish:e9>e21,crossUp:e9p<=e21p&&e9>e21,crossDown:e9p>=e21p&&e9<e21}}

// ‚ïê‚ïê‚ïê POSITION TRACKER ‚Äî how long has price stayed above/below PTB this hour? ‚ïê‚ïê‚ïê
let positionHistory=[];
function trackPosition(price,ptb){
    positionHistory.push({above:price>=ptb,diff:price-ptb,ts:Date.now()});
    if(positionHistory.length>200)positionHistory.shift();
}
function getPositionBias(){
    if(positionHistory.length<3)return{bias:0,abovePct:0.5,avgDiff:0,trend:0};
    const abovePct=positionHistory.filter(p=>p.above).length/positionHistory.length;
    const avgDiff=positionHistory.reduce((s,p)=>s+p.diff,0)/positionHistory.length;
    const half=Math.floor(positionHistory.length/2);
    const recentAvg=positionHistory.slice(-half).reduce((s,p)=>s+p.diff,0)/half;
    const olderAvg=positionHistory.slice(0,half).reduce((s,p)=>s+p.diff,0)/half;
    return{bias:(abovePct-0.5)*2,abovePct,avgDiff,trend:recentAvg-olderAvg};
}
function resetPositionHistory(){positionHistory=[];}

// Make prediction once we have enough price data
// WARMUP: need at least 3 minutes of ticks (~36 ticks at 5s) before making a prediction
const MIN_TICKS_BEFORE_PREDICT=36;

function makePrediction(){
    if(!btcPrice||!ptb||locked)return;
    const now=new Date();
    // Wait for warmup ‚Äî need meaningful price history
    if(priceHistory.length<MIN_TICKS_BEFORE_PREDICT)return;

    const prices=priceHistory.map(p=>p.price);
    const diff=btcPrice-ptb;
    const abovePtb=diff>0;
    const gap=Math.abs(diff);

    // ‚ïê‚ïê‚ïê IMPROVED SCORING ENGINE ‚ïê‚ïê‚ïê
    let score=0;
    const signals=[];

    // ‚ïê‚ïê‚ïê SESSION DETECTION ‚ïê‚ïê‚ïê
    const hourET=new Date().toLocaleString('en-US',{timeZone:'America/New_York',hour:'numeric',hour12:false});
    const h=parseInt(hourET);
    const isUSSession=h>=9&&h<16;
    const isAsiaSession=h>=20||h<4;
    const isEuroSession=h>=3&&h<9;
    const sessionName=isUSSession?'US üá∫üá∏':isAsiaSession?'ASIA üåè':isEuroSession?'EURO üá™üá∫':'OFF';
    const momentumBoost=isUSSession?1.5:isEuroSession?1.2:0.8;
    const reversionBoost=isAsiaSession?1.5:isUSSession?0.7:1.0;
    signals.push({name:'Session: '+sessionName,up:isUSSession});

    // 1. PRICE vs PTB ‚Äî heaviest signal (scaled by time remaining + gap size)
    const minutesLeft=60-now.getMinutes();
    const timePct=minutesLeft/60;
    const timeScale=5+Math.pow(1-timePct,2)*15;
    const gapScale=Math.min(gap/50,3);
    const priceWeight=timeScale*Math.max(gapScale,0.5);
    score+=abovePtb?priceWeight:-priceWeight;
    signals.push({name:'Price vs PTB: '+(abovePtb?'+':'-')+'$'+gap.toFixed(0)+' ('+minutesLeft+'m left)',up:abovePtb});

    // 2. POSITION BIAS ‚Äî how has price behaved vs PTB this whole hour?
    trackPosition(btcPrice,ptb);
    if(positionHistory.length>=10){
        const pb=getPositionBias();
        const pbWeight=1.5*momentumBoost;
        score+=pb.bias*pbWeight;
        // Also score the intra-hour trend direction
        if(Math.abs(pb.trend)>5){
            score+=pb.trend>0?0.8*momentumBoost:-0.8*momentumBoost;
            signals.push({name:'Hour trend: '+(pb.trend>0?'Rising ‚Üë':'Falling ‚Üì')+' $'+Math.abs(pb.trend).toFixed(0),up:pb.trend>0});
        }
        signals.push({name:'Time above PTB: '+(pb.abovePct*100).toFixed(0)+'% of hour',up:pb.abovePct>0.5});
    }

    // 3. RSI ‚Äî momentum in US, mean-reversion in Asia
    const rsiVal=calcRsi(prices,14);
    if(rsiVal){
        if(isAsiaSession&&(rsiVal>75||rsiVal<25)){
            const revScore=rsiVal>75?-1.8*reversionBoost:1.8*reversionBoost;
            score+=revScore;
            signals.push({name:'RSI '+rsiVal.toFixed(0)+': '+(rsiVal>75?'OVERBOUGHT‚ÜíFADE':'OVERSOLD‚ÜíBOUNCE'),up:rsiVal<25});
        }else if(rsiVal>70||rsiVal<30){
            // Extreme RSI gets contrarian weight even in US
            const w=0.8;
            score+=rsiVal>70?-w:w;
            signals.push({name:'RSI '+rsiVal.toFixed(0)+': '+(rsiVal>70?'Overbought':'Oversold'),up:rsiVal<30});
        }else{
            const w=0.6*momentumBoost;
            score+=rsiVal>50?w:-w;
            signals.push({name:'RSI: '+rsiVal.toFixed(0),up:rsiVal>50});
        }
    }

    // 4. MACD ‚Äî trend momentum
    const mc=macd(prices);
    if(mc){
        const w=0.7*momentumBoost;
        score+=mc.bullish?w:-w;
        signals.push({name:'MACD: '+(mc.bullish?'Bullish':'Bearish')+' ($'+mc.macd.toFixed(1)+')',up:mc.bullish});
    }

    // 5. EMA 9/21 Crossover ‚Äî the key scalping signal
    const emaCross=emaCrossover(prices);
    if(emaCross){
        const w=emaCross.crossUp||emaCross.crossDown?1.2*momentumBoost:0.5*momentumBoost;
        score+=emaCross.bullish?w:-w;
        const label=emaCross.crossUp?'Golden Cross ‚ñ≤':emaCross.crossDown?'Death Cross ‚ñº':emaCross.bullish?'Bullish':'Bearish';
        signals.push({name:'EMA 9/21: '+label,up:emaCross.bullish});
    }

    // 6. Bollinger Bands position
    const bb=bollingerBands(prices);
    if(bb){
        const pos=bb.pos; // 0=at lower band, 1=at upper
        if(isAsiaSession){
            // Asia: revert from extremes
            if(pos>0.85){score-=1.0*reversionBoost;signals.push({name:'BB: Near upper (Asia‚Üífade)',up:false});}
            else if(pos<0.15){score+=1.0*reversionBoost;signals.push({name:'BB: Near lower (Asia‚Üíbounce)',up:true});}
        }else{
            // US/Euro: momentum ‚Äî above midline = bullish
            const w=0.5*momentumBoost;
            score+=pos>0.5?w:-w;
            signals.push({name:'BB position: '+(pos*100).toFixed(0)+'%',up:pos>0.5});
        }
    }

    // 7. Mean Reversion Z-Score ‚Äî statistical extremes
    const zScore=meanReversionZ(prices,Math.min(prices.length,30));
    if(zScore!==null&&Math.abs(zScore)>1.5){
        const revScore=zScore>2?-1.2*reversionBoost:zScore<-2?1.2*reversionBoost:zScore>1.5?-0.6:0.6;
        score+=revScore;
        signals.push({name:'Z-Score: '+zScore.toFixed(1)+' '+(zScore>1.5?'(Overbought)':'(Oversold)'),up:zScore<-1.5});
    }

    // 8. Stochastic ‚Äî fast oscillator
    const stoch=stochastic(prices);
    if(stoch!==null){
        if(stoch>80){score-=0.6*reversionBoost;signals.push({name:'Stoch '+stoch.toFixed(0)+': Overbought',up:false});}
        else if(stoch<20){score+=0.6*reversionBoost;signals.push({name:'Stoch '+stoch.toFixed(0)+': Oversold',up:true});}
        else{const w=0.3;score+=stoch>50?w:-w;signals.push({name:'Stoch: '+stoch.toFixed(0),up:stoch>50});}
    }

    // 9. Recent tick direction (momentum of last ~2 minutes)
    if(prices.length>=12){
        const recent=prices.slice(-12);
        const dir=recent[11]-recent[0];
        const w=0.5*momentumBoost;
        score+=dir>0?w:-w;
        signals.push({name:'2min Direction: '+(dir>0?'‚Üë +$':'-$')+Math.abs(dir).toFixed(0),up:dir>0});
    }

    // 10. Streak fade ‚Äî if candles have moved hard one way, lean opposite in Asia
    if(prices.length>=20){
        let upRun=0,downRun=0;
        for(let i=prices.length-10;i<prices.length;i++){
            if(prices[i]>prices[i-1])upRun++;else if(prices[i]<prices[i-1])downRun++;
        }
        const streak=Math.max(upRun,downRun);
        const streakUp=upRun>downRun;
        if(streak>=7&&gap<30){
            const fadeScore=streakUp?-0.9*reversionBoost:0.9*reversionBoost;
            score+=fadeScore;
            signals.push({name:'Streak fade: '+streak+'x '+(streakUp?'UP‚Üífade':'DOWN‚Üífade'),up:!streakUp});
        }
    }

    // 11. Sentiment ‚Äî boosted in US (institutional driven)
    if(sentimentData.sentiment){
        const bullish=sentimentData.sentiment==='Bullish';
        const w=isUSSession?0.6:0.3;
        score+=bullish?w:-w;
        signals.push({name:'Sentiment: '+sentimentData.sentiment,up:bullish});
    }

    // 12. Funding rate ‚Äî contrarian signal (extreme funding = crowded trade)
    if(sentimentData.funding){
        const rate=parseFloat(sentimentData.funding);
        if(Math.abs(rate)>0.01){
            if(Math.abs(rate)>0.05){
                // Extremely crowded ‚Üí contrarian
                const w=0.9*reversionBoost;
                score+=rate>0?-w:w;
                signals.push({name:'Funding '+(rate>0?'extreme long‚Üífade':'extreme short‚Üíbounce'),up:rate<0});
            }else{
                const w=0.4*(isUSSession?momentumBoost:0.8);
                score+=rate>0?w:-w;
                signals.push({name:'Funding: '+sentimentData.funding,up:rate>0});
            }
        }
    }

    // ‚ïê‚ïê‚ïê SCORE DECIDES ‚Äî no overrides ‚ïê‚ïê‚ïê
    const pred=score>0;
    const strategy='SCORE '+(score>0?'+':'')+score.toFixed(1);

    // Confidence (kept same as original)
    const conf=Math.max(85,Math.min(98,85+Math.abs(score)/priceWeight*10));

    prediction={willBeat:pred,confidence:Math.round(conf),strategy:strategy};
    locked=true;

    signals.push({name:'‚Üí '+(pred?'YES ‚Üë':'NO ‚Üì')+' ('+strategy+')',up:pred});

    document.getElementById('signals').innerHTML=signals.map(s=>
        '<div class="sig '+(s.up?'sig-u':'sig-d')+'"><span>'+s.name+'</span><span style="color:'+(s.up?'var(--up)':'var(--dn)')+'">'+
        (s.up?'‚ñ≤':'‚ñº')+'</span></div>').join('');

    updatePredDisplay();
    console.log('üîí LOCKED: '+(pred?'YES ‚Üë':'NO ‚Üì')+' | '+sessionName+' | '+strategy+' | Conf: '+conf.toFixed(0)+'%');
}

function updatePredDisplay(){
    if(!prediction)return;
    const el=document.getElementById('predDisplay');
    el.className='pred '+(prediction.willBeat?'pred-up':'pred-dn');
    document.getElementById('predValue').innerHTML=
        '<div style="font-size:1.1em">'+(prediction.willBeat?'‚Üë YES':'‚Üì NO')+'</div>'+
        '<div style="font-size:.45em;margin-top:4px;color:var(--tx2)">'+(prediction.willBeat?'Will beat':'Won\'t beat')+' $'+(ptb?ptb.toFixed(2):'--')+'</div>';
    document.getElementById('predConf').textContent='Confidence: '+prediction.confidence+'%';
    document.getElementById('confPct').textContent=prediction.confidence+'%';
    document.getElementById('confBar').style.width=prediction.confidence+'%';
    document.getElementById('confBar').style.background=prediction.confidence>=80?
        'linear-gradient(90deg,var(--up),#00b86e)':'linear-gradient(90deg,#eab308,#d97706)';
}

function updateUI(){
    if(!btcPrice&&!displayPrice)return;
    const showPrice=displayPrice||btcPrice;
    document.getElementById('currentPrice').textContent='$'+showPrice.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    document.getElementById('lastUpdate').textContent='Updated '+new Date().toLocaleTimeString();

    // Store price history (for prediction logic)
    if(btcPrice){
        priceHistory.push({price:btcPrice,time:Date.now()});
        if(priceHistory.length>200)priceHistory.shift();
    }

    if(ptb){
        document.getElementById('priceToBeat').textContent='$'+ptb.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
        document.getElementById('ptbTime').textContent=ptbSetAt?'Set at '+ptbSetAt.toLocaleTimeString():'Set at hour mark';
        const d=showPrice-ptb,p=(d/ptb*100).toFixed(3);
        document.getElementById('vsComparison').innerHTML=d>0?
            '<span style="color:var(--up)">+$'+d.toFixed(2)+' (+'+p+'%)</span>':
            '<span style="color:var(--dn)">$'+d.toFixed(2)+' ('+p+'%)</span>';
    }

    // Countdown
    const end=getHourEnd();
    const tl=end-new Date();
    const mins=Math.floor(tl/60000);
    const secs=Math.floor((tl%60000)/1000);
    document.getElementById('countdown').textContent=mins+'m '+secs+'s';

    // Status
    if(locked&&prediction){
        document.getElementById('status').textContent='üîí Prediction locked: '+(prediction.willBeat?'YES ‚Üë':'NO ‚Üì')+' | '+prediction.strategy;
    }else if(!ptb){
        const end=getHourEnd();
        const tl=end-new Date();
        const mins=Math.floor(tl/60000);
        document.getElementById('status').textContent='‚è≥ Waiting for PTB ‚Äî will capture at next hour mark ('+mins+'m)';
    }else if(ptb&&priceHistory.length<MIN_TICKS_BEFORE_PREDICT){
        const secsLeft=Math.ceil((MIN_TICKS_BEFORE_PREDICT-priceHistory.length)*5);
        document.getElementById('status').textContent='‚è≥ Warming up... '+priceHistory.length+'/'+MIN_TICKS_BEFORE_PREDICT+' ticks (~'+secsLeft+'s)';
    }else if(ptb){
        document.getElementById('status').textContent='Analyzing signals... prediction imminent';
    }

    checkPtb();
    if(!locked)makePrediction();
}

// Check for new hour ‚Üí reset
setInterval(()=>{
    const now=new Date();
    if(now.getMinutes()===0&&now.getSeconds()<3){
        locked=false;
        prediction=null;
        ptb=null;
        resetPositionHistory();
        document.getElementById('predDisplay').className='pred pred-nu';
        document.getElementById('predValue').textContent='--';
        document.getElementById('predConf').textContent='New hour starting...';
        document.getElementById('signals').innerHTML='<span style="color:var(--tx3)">Collecting data...</span>';
    }
},1000);

// Fetch sentiment on load and every 5 min
fetchSentiment();
setInterval(fetchSentiment,300000);

// Update countdown every second
setInterval(()=>{
    const end=getHourEnd();
    const tl=end-new Date();
    const mins=Math.floor(tl/60000);
    const secs=Math.floor((tl%60000)/1000);
    document.getElementById('countdown').textContent=mins+'m '+secs+'s';
},1000);
</script>
</body>
</html>
