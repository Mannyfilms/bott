<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket Bitcoin Prediction Bot</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#08090d;--bg2:#0e1017;--sf:#13151c;--sf2:#181b24;--sf3:#1e222e;--bd:rgba(255,255,255,.06);--bdh:rgba(255,255,255,.1);--tx:#edeef2;--tx2:#a0a5b8;--tx3:#5d6277;--btc:#f7931a;--btcs:rgba(247,147,26,.1);--btcm:rgba(247,147,26,.2);--up:#00dc82;--ups:rgba(0,220,130,.1);--upm:rgba(0,220,130,.18);--dn:#ff4757;--dns:rgba(255,71,87,.1);--dnm:rgba(255,71,87,.18);--bl:#636bff;--bls:rgba(99,107,255,.1);--r:12px;--rs:8px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;-webkit-font-smoothing:antialiased;overflow-x:hidden}
        .shell{max-width:1320px;margin:0 auto;padding:20px 20px 60px}
        .nav{display:flex;align-items:center;gap:14px;padding:14px 0 20px;border-bottom:1px solid var(--bd);margin-bottom:22px}
        .nav-mark{width:36px;height:36px;border-radius:10px;background:linear-gradient(140deg,var(--btc),#e07c0e);display:grid;place-items:center;font-size:16px;flex-shrink:0}
        .nav-text h1{font-size:1.05em;font-weight:600;letter-spacing:-.01em}
        .nav-text span{font-size:.72em;color:var(--tx3)}
        .nav-right{margin-left:auto;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
        .nav-user{font-size:.8em;color:var(--tx2);padding:0 10px}
        .btn{display:inline-flex;align-items:center;gap:5px;padding:8px 16px;border:none;border-radius:var(--rs);font-family:'Outfit',sans-serif;font-size:.8em;font-weight:500;cursor:pointer;transition:all .15s;white-space:nowrap}
        .btn-go{background:linear-gradient(140deg,var(--btc),#e07c0e);color:#fff;box-shadow:0 2px 10px rgba(247,147,26,.15)}
        .btn-go:hover{box-shadow:0 3px 16px rgba(247,147,26,.22);transform:translateY(-1px)}
        .btn-g{background:var(--sf2);color:var(--tx2);border:1px solid var(--bd)}
        .btn-g:hover{background:var(--sf3);color:var(--tx)}
        .btn-r{background:var(--dns);color:var(--dn);border:1px solid rgba(255,71,87,.12)}
        .btn-r:hover{background:var(--dnm)}
        .btn:disabled{opacity:.35;cursor:not-allowed;transform:none!important}
        .disc{display:flex;align-items:center;gap:8px;padding:9px 15px;background:var(--sf);border:1px solid var(--bd);border-radius:var(--rs);margin-bottom:20px;font-size:.76em;color:var(--tx3);line-height:1.4}
        .disc svg{flex-shrink:0;opacity:.45}
        .card{background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:22px;margin-bottom:14px;transition:border-color .2s}
        .card:hover{border-color:var(--bdh)}
        .ct{font-size:.68em;font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--tx3);margin-bottom:16px}
        .g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
        .g3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
        .g6{display:grid;grid-template-columns:repeat(auto-fill,minmax(145px,1fr));gap:10px}
        @media(max-width:768px){.g2,.g3{grid-template-columns:1fr}.nav{flex-wrap:wrap;gap:8px;padding:10px}.nav-right{width:100%;justify-content:flex-end}.shell{padding:10px 10px 40px}.card{padding:14px}}
        .status{padding:10px 16px;background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);text-align:center;font-size:.82em;color:var(--tx2);margin-bottom:12px}
        .mlbar{padding:10px 16px;background:var(--bls);border:1px solid rgba(99,107,255,.1);border-radius:var(--rs);font-size:.76em;color:var(--bl);line-height:1.7}
        .plbl{font-size:.68em;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:4px}
        .pbig{font-family:'JetBrains Mono',monospace;font-size:2.1em;font-weight:700;letter-spacing:-.03em}
        .psub{font-size:.72em;color:var(--tx3);margin-top:3px}
        .vs{background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);padding:14px;text-align:center;margin-top:14px}
        .vsl{font-size:.66em;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:5px}
        .vsv{font-family:'JetBrains Mono',monospace;font-size:1.1em;font-weight:600}
        .pred{padding:20px;border-radius:var(--r);text-align:center}
        .pred-up{background:var(--ups);border:1px solid rgba(0,220,130,.12)}
        .pred-dn{background:var(--dns);border:1px solid rgba(255,71,87,.12)}
        .pred-nu{background:var(--sf2);border:1px solid var(--bd)}
        .pred-info{background:var(--btcs);border:1px solid rgba(247,147,26,.1)}
        .pred-analyzing{background:linear-gradient(135deg,rgba(99,107,255,.09),rgba(99,107,255,.04));border:1px solid rgba(99,107,255,.18)}
        .pred h3{font-size:.74em;font-weight:500;color:var(--tx2);margin-bottom:8px}
        .pred .conf{font-size:.76em;color:var(--tx2);margin-top:6px}
        .cftrack{width:100%;height:6px;background:var(--sf3);border-radius:3px;overflow:hidden;margin:12px 0 4px}
        .cffill{height:100%;border-radius:3px;transition:width .5s,background .3s}
        .cflbl{text-align:right;font-family:'JetBrains Mono',monospace;font-size:.72em;color:var(--tx3)}
        .mc{background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);padding:15px}
        .mc h4{font-size:.68em;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:8px}
        .mc .mp{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:.88em}
        .mc .mcc{font-size:.75em;color:var(--tx3);margin-top:3px}
        .pat{background:var(--btcs);border:1px solid rgba(247,147,26,.12);border-radius:var(--rs);padding:10px 16px;font-size:.82em;color:var(--btc);margin-top:10px;display:none;font-weight:500}
        .sigw{background:var(--sf2);border-radius:var(--rs);padding:16px;margin-top:14px}
        .sigw h3{font-size:.68em;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-bottom:10px;display:flex;align-items:center;gap:8px}
        .live-dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--bl);animation:pulse 1s infinite}
        @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
        .sig{display:flex;justify-content:space-between;align-items:center;padding:8px 11px;margin:4px 0;background:var(--sf);border-radius:6px;font-size:.78em;border-left:3px solid var(--bd)}
        .sig-u{border-left-color:var(--up)}.sig-d{border-left-color:var(--dn)}
        .echip{background:var(--btcs);border:1px solid rgba(247,147,26,.08);border-radius:var(--rs);padding:11px 13px}
        .echip .cl{font-size:.64em;text-transform:uppercase;letter-spacing:.07em;color:rgba(247,147,26,.5);margin-bottom:4px}
        .echip .cv{font-family:'JetBrains Mono',monospace;font-size:.86em;font-weight:600;color:var(--btc)}
        .hist{max-height:330px;overflow-y:auto;margin-top:10px}
        .hist::-webkit-scrollbar{width:3px}
        .hist::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px}
        .hitem{padding:11px;border-bottom:1px solid var(--bd);font-size:.8em}
        .hitem:last-child{border-bottom:none}
        .correct{color:var(--up);font-weight:600}.incorrect{color:var(--dn);font-weight:600}
        /* Gap badges */
        .gbadge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.67em;font-weight:700;font-family:'JetBrains Mono',monospace;letter-spacing:.04em}
        .gb-huge{background:rgba(255,71,87,.12);color:var(--dn)}
        .gb-big{background:rgba(247,147,26,.12);color:var(--btc)}
        .gb-med{background:rgba(0,220,130,.1);color:var(--up)}
        .gb-tight{background:rgba(99,107,255,.12);color:var(--bl)}
        .gb-flip{background:rgba(99,107,255,.2);color:#a5b4fc}
        /* Analysis progress bar override */
        .analyzing-bar{background:linear-gradient(90deg,var(--bl),#8b5cf6)!important}
    </style>
</head>
<body>
<div class="shell">
    <nav class="nav">
        <div class="nav-mark">&#8383;</div>
        <div class="nav-text"><h1>Polymarket BTC Predictor</h1><span>5-Minute Forecasts &middot; Chainlink BTC/USD (Polymarket Source)</span></div>
        <div class="nav-right">
            <span class="nav-user" id="userGreeting"></span>
            <button class="btn btn-go" id="startBtn" onclick="startPredictions()">Start</button>
            <button class="btn btn-g" id="stopBtn" onclick="stopPredictions()" disabled>Stop</button>
            <button class="btn btn-g" onclick="saveProgress()">Save</button>
            <button class="btn btn-r" onclick="resetStats()">Reset</button>
            <button class="btn btn-g" onclick="logout()">Log out</button>
        </div>
    </nav>

    <div class="disc">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        Predictions are not 100% accurate and can make mistakes. Use as a reference, not financial advice. Progress auto-saves.
    </div>

    <div class="card">
        <div class="ct">Market Status</div>
        <div class="status" id="status">Ready &mdash; Click Start</div>
        <div class="mlbar" id="mlStatus">Ensemble: Initializing &middot; LSTM: Not trained &middot; Pattern Recognition: Active</div>
        <div class="g2" style="margin-top:16px">
            <div style="text-align:center"><div class="plbl">Price to Beat</div><div class="pbig" id="priceToBeat" style="color:var(--tx2)">--</div><div class="psub" id="ptbLabel">Set at 5-minute mark</div></div>
            <div style="text-align:center"><div class="plbl">Current Price</div><div class="pbig" id="currentPrice" style="color:var(--btc)">--</div><div class="psub" id="lastUpdate">--</div></div>
        </div>
        <div class="vs"><div class="vsl">Current vs Target</div><div class="vsv" id="vsComparison">--</div></div>
    </div>

    <div class="card">
        <div class="ct">Prediction &amp; Confidence</div>
        <div class="g2">
            <div class="pred pred-nu" id="predictionDisplay">
                <h3>Ensemble Prediction</h3>
                <div id="predictionValue" style="font-family:'JetBrains Mono',monospace;font-size:1.4em;font-weight:700">--</div>
                <div class="conf" id="predictionConfidence">--</div>
                <div style="margin-top:6px;font-size:.75em;color:var(--tx3)" id="predictionDetails">--</div>
            </div>
            <div class="pred pred-info">
                <h3>Window Info</h3>
                <div style="font-family:'JetBrains Mono',monospace;font-size:1.1em;font-weight:700;color:var(--btc);margin:6px 0" id="nextCheckTime">--</div>
                <div style="font-size:.73em;color:var(--tx2);line-height:1.9" id="lockTimingInfo">3 ML Models &middot; 15+ Indicators<br>Gap-based adaptive locking</div>
            </div>
        </div>
        <div><div class="cflbl"><span id="confPercent">0%</span></div><div class="cftrack"><div class="cffill" id="confidenceMeter" style="width:0%"></div></div></div>
        <div class="g3" style="margin-top:12px">
            <div class="mc"><h4>Time Above</h4><div class="mp" id="model1Pred">--</div><div class="mcc" id="model1Conf">--</div></div>
            <div class="mc"><h4>Current Gap</h4><div class="mp" id="model2Pred">--</div><div class="mcc" id="model2Conf">--</div></div>
            <div class="mc"><h4>Slot Avg</h4><div class="mp" id="model3Pred">--</div><div class="mcc" id="model3Conf">--</div></div>
        </div>
        <div class="pat" id="patternSection"><span id="patternName"></span></div>
        <div class="sigw">
            <h3 id="sigwHeader">Signal Breakdown</h3>
            <div id="signalList" style="color:var(--tx3);font-size:.8em">Waiting&hellip;</div>
        </div>
    </div>

    <div class="card">
        <div class="ct">Market Sentiment</div>
        <div class="g6">
            <div class="echip"><div class="cl">Fear &amp; Greed</div><div class="cv" id="fearGreed">--</div></div>
            <div class="echip"><div class="cl">Sentiment</div><div class="cv" id="sentiment">--</div></div>
            <div class="echip"><div class="cl">BTC Dominance</div><div class="cv" id="btcDominance">--</div></div>
            <div class="echip"><div class="cl">Funding Rate</div><div class="cv" id="fundingRate">--</div></div>
            <div class="echip"><div class="cl">Exchange Flow</div><div class="cv" id="exchangeFlow">--</div></div>
            <div class="echip"><div class="cl">Whale Activity</div><div class="cv" id="whaleActivity">--</div></div>
        </div>
    </div>

    <!-- Hidden indicator elements -->
    <div style="display:none">
        <span id="sma5"></span><span id="sma10"></span><span id="sma20"></span><span id="ema12"></span>
        <span id="rsi"></span><span id="stochastic"></span><span id="bbUpper"></span><span id="bbLower"></span>
        <span id="macd"></span><span id="atr"></span><span id="volumeTrend"></span><span id="momentum"></span>
        <span id="totalPredictions"></span><span id="correctPredictions"></span><span id="accuracyRate"></span>
        <span id="highConfAccuracy"></span><span id="winStreak"></span><span id="skippedCount"></span>
        <div id="signalPerformance"></div>
    </div>

    <div class="card">
        <div class="ct">History</div>
        <div class="hist" id="history"><div style="text-align:center;padding:16px;color:var(--tx3);font-size:.8em">No predictions yet</div></div>
    </div>

    <div class="card">
        <div class="ct">How Gap-Based Locking Works</div>
        <div style="font-size:.85em;color:var(--tx2);line-height:1.85">
            <p style="margin-bottom:14px">The system watches the price gap vs PTB and decides <strong style="color:var(--tx)">how long to keep analyzing</strong> before locking in a prediction. Big gap = obvious result, lock fast. Near PTB = uncertain, use full window.</p>
            <div style="background:var(--sf2);border-radius:var(--rs);padding:16px;margin-bottom:10px">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:.8em">
                    <div style="padding:8px 10px;background:var(--sf);border-radius:6px;border-left:3px solid var(--dn)"><span class="gbadge gb-huge">HUGE GAP $150+</span><br><span style="color:var(--tx3)">Lock: <strong>10s</strong> ‚Äî obvious</span></div>
                    <div style="padding:8px 10px;background:var(--sf);border-radius:6px;border-left:3px solid var(--btc)"><span class="gbadge gb-big">BIG $80‚Äì150</span><br><span style="color:var(--tx3)">Lock: <strong>20s</strong></span></div>
                    <div style="padding:8px 10px;background:var(--sf);border-radius:6px;border-left:3px solid var(--up)"><span class="gbadge gb-med">MED $40‚Äì80</span><br><span style="color:var(--tx3)">Lock: <strong>45s</strong></span></div>
                    <div style="padding:8px 10px;background:var(--sf);border-radius:6px;border-left:3px solid var(--bl)"><span class="gbadge gb-tight">TIGHT $15‚Äì40</span><br><span style="color:var(--tx3)">Lock: <strong>90s</strong></span></div>
                    <div style="padding:8px 10px;background:var(--sf);border-radius:6px;border-left:3px solid #8b5cf6;grid-column:1/-1"><span class="gbadge gb-flip">COIN FLIP &lt;$15</span><br><span style="color:var(--tx3)">Lock: <strong>120s (max)</strong> ‚Äî gather every signal available</span></div>
                </div>
            </div>
            <p>During the analysis window, <strong style="color:var(--tx)">all signals update live</strong> every 5 seconds so you can watch the reasoning evolve before it commits.</p>
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê
async function checkAuth(){try{const r=await fetch('/api/me');if(!r.ok){window.location.href='/';return}const d=await r.json();document.getElementById('userGreeting').textContent=d.username}catch(e){window.location.href='/'}}
async function logout(){await fetch('/api/logout',{method:'POST'});window.location.href='/'}
checkAuth();
setInterval(async()=>{try{const r=await fetch('/api/me');if(!r.ok){window.location.href='/'}}catch(e){}},10000);

// ‚ïê‚ïê‚ïê GAP ‚Üí LOCK TIMING ‚ïê‚ïê‚ïê
// Bigger gap = less analysis needed = lock sooner. Max window = 120s (2 min).
function getLockThreshold(price,ptb){
  if(!ptb||!price)return 120;
  const gap=Math.abs(price-ptb);
  if(gap>150)return 10;   // Huge gap ‚Äî obvious, commit fast
  if(gap>80) return 20;   // Big gap
  if(gap>40) return 45;   // Medium gap
  if(gap>15) return 90;   // Tight
  return 120;             // Near PTB ‚Äî use full 2 minutes
}

function getGapBadge(gap){
  if(gap>150)return{html:'<span class="gbadge gb-huge">HUGE $'+gap.toFixed(0)+'</span>',label:'HUGE'};
  if(gap>80) return{html:'<span class="gbadge gb-big">BIG $'+gap.toFixed(0)+'</span>',label:'BIG'};
  if(gap>40) return{html:'<span class="gbadge gb-med">MED $'+gap.toFixed(0)+'</span>',label:'MED'};
  if(gap>15) return{html:'<span class="gbadge gb-tight">TIGHT $'+gap.toFixed(0)+'</span>',label:'TIGHT'};
  return              {html:'<span class="gbadge gb-flip">COIN FLIP $'+gap.toFixed(0)+'</span>',label:'FLIP'};
}

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let priceHistory=[],predictionHistory=[],updateInterval=null,checkInterval=null,isRunning=false;
let lstmModel=null,technicalModel=null,hybridModel=null,modelsTraining=false,trainingData=[];
let signalWeights={};
let signalPerformance={};
let stats={total:0,correct:0,currentStreak:0,skipped:0,highConfPredictions:0,highConfCorrect:0};
let externalData={fearGreed:50,sentiment:'NEUTRAL',btcDominance:50,fundingRate:0,exchangeFlow:'NEUTRAL',whaleActivity:'LOW'};
let signalMultipliers={};
let recentResults=[];
try{const s=localStorage.getItem('btcRecentResults');if(s)recentResults=JSON.parse(s)}catch(e){}

// Markets tracking per timeframe
let markets={
  5:{priceToBeat:null,currentSlot:null,currentPrediction:null,slotStartTime:null},
  15:{priceToBeat:null,currentSlot:null,currentPrediction:null,slotStartTime:null},
  60:{priceToBeat:null,currentSlot:null,currentPrediction:null,slotStartTime:null}
};
let selectedTimeframe=5;
function getActiveMarket(){return markets[selectedTimeframe]}

// Prediction lock
let predictionLock={locked:false,direction:null,lockPrice:null,lockTime:null,lockPtb:null};
function savePredictionLock(){try{const slot=Math.floor(Date.now()/300000);localStorage.setItem('predLock5m',JSON.stringify({...predictionLock,slot}))}catch(e){}}
function loadPredictionLock(){try{const d=JSON.parse(localStorage.getItem('predLock5m'));if(!d||!d.locked)return false;if(Math.floor(Date.now()/300000)!==d.slot)return false;predictionLock=d;return true}catch(e){return false}}
function resetPredictionLock(){predictionLock={locked:false,direction:null,lockPrice:null,lockTime:null,lockPtb:null};try{localStorage.removeItem('predLock5m');localStorage.removeItem('currentPred5m')}catch(e){}}

let positionHistory=[];
function trackPosition(price,ptb){if(!ptb)return;positionHistory.push({above:price>=ptb,diff:price-ptb,timestamp:Date.now()});if(positionHistory.length>60)positionHistory.shift()}
function resetPositionHistory(){positionHistory=[]}

function getSlot(tf,date){const d=date||new Date();return Math.floor((d.getHours()*60+d.getMinutes())/tf)*tf}
function getSlotEnd(tf,date){const d=date||new Date();const total=d.getHours()*60+d.getMinutes();const next=Math.floor(total/tf)*tf+tf;const end=new Date(d);end.setHours(Math.floor(next/60),next%60,0,0);if(next>=1440){end.setDate(end.getDate()+1);end.setHours(0,0,0,0)}return end}

// ‚ïê‚ïê‚ïê SAVE/LOAD ‚ïê‚ïê‚ïê
function saveProgress(){try{localStorage.setItem('btcPred',JSON.stringify({predictionHistory:predictionHistory.slice(0,50),trainingData:trainingData.slice(-100),stats,signalPerformance,signalMultipliers,strategyStats:window.strategyStats||{},lastSaved:Date.now()}))}catch(e){}}
function loadProgress(){try{const s=localStorage.getItem('btcPred');if(!s)return false;const d=JSON.parse(s);if((Date.now()-d.lastSaved)/36e5>24)return false;predictionHistory=d.predictionHistory||[];trainingData=d.trainingData||[];stats=d.stats||stats;signalPerformance=d.signalPerformance||{};signalMultipliers=d.signalMultipliers||{};window.strategyStats=d.strategyStats||{};updateStats();updateHistoryDisplay();return true}catch(e){return false}}
setInterval(saveProgress,3e5);
window.addEventListener('beforeunload',saveProgress);

function fmt(d){return d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}

// ‚ïê‚ïê‚ïê WEBSOCKETS ‚ïê‚ïê‚ïê
let latestBtcPrice=null,latestChainlinkPrice=null,polyWs=null,btcWs=null;

let chainlinkCandles=[],currentChainlinkCandle=null;
function processChainlinkTick(price,ts){
  const slot=Math.floor(ts/300000);
  if(!currentChainlinkCandle||currentChainlinkCandle.slot!==slot){
    if(currentChainlinkCandle&&currentChainlinkCandle.ticks>0){chainlinkCandles.push({time:currentChainlinkCandle.slot*300000,open:currentChainlinkCandle.open,high:currentChainlinkCandle.high,low:currentChainlinkCandle.low,close:currentChainlinkCandle.close,ticks:currentChainlinkCandle.ticks});if(chainlinkCandles.length>100)chainlinkCandles.shift()}
    currentChainlinkCandle={slot,open:price,high:price,low:price,close:price,ticks:1};
  }else{currentChainlinkCandle.high=Math.max(currentChainlinkCandle.high,price);currentChainlinkCandle.low=Math.min(currentChainlinkCandle.low,price);currentChainlinkCandle.close=price;currentChainlinkCandle.ticks++}
}

function connectPolyWs(){
  try{
    polyWs=new WebSocket('wss://ws-live-data.polymarket.com');
    polyWs.onopen=()=>{polyWs.send(JSON.stringify({action:'subscribe',subscriptions:[{topic:'crypto_prices_chainlink',type:'*',filters:'{"symbol":"btc/usd"}'}]}));polyWs.send(JSON.stringify({action:'subscribe',subscriptions:[{topic:'crypto_prices',type:'update',filters:'btcusdt'}]}))};
    polyWs.onmessage=(e)=>{try{const d=JSON.parse(e.data);if(d.topic==='crypto_prices_chainlink'&&d.payload?.symbol==='btc/usd'){latestChainlinkPrice=d.payload.value;latestBtcPrice=d.payload.value;processChainlinkTick(d.payload.value,d.payload.timestamp||Date.now())}else if(d.topic==='crypto_prices'&&d.payload?.symbol==='btcusdt'&&!latestChainlinkPrice){latestBtcPrice=d.payload.value}}catch(ex){}};
    let pi=setInterval(()=>{if(polyWs.readyState===1)polyWs.send('PING');else clearInterval(pi)},5000);
    polyWs.onclose=()=>{clearInterval(pi);setTimeout(connectPolyWs,3000)};
    polyWs.onerror=()=>polyWs.close();
  }catch(e){setTimeout(connectPolyWs,5000)}
}
function connectBtcWs(){try{btcWs=new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');btcWs.onmessage=(e)=>{if(!latestChainlinkPrice)latestBtcPrice=parseFloat(JSON.parse(e.data).p)};btcWs.onclose=()=>setTimeout(connectBtcWs,3000);btcWs.onerror=()=>btcWs.close()}catch(e){setTimeout(connectBtcWs,5000)}}
connectPolyWs();connectBtcWs();

// ‚ïê‚ïê‚ïê PTB ‚ïê‚ïê‚ïê
function savePtb(price){const slot=Math.floor(Date.now()/300000);localStorage.setItem('ptb',JSON.stringify({price,slot}));fetch('/api/ptb',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({price,slot})}).catch(()=>{})}
async function loadPtb(){const cs=Math.floor(Date.now()/300000);try{const d=JSON.parse(localStorage.getItem('ptb'));if(d&&d.slot===cs&&d.price>50000&&d.price<200000){markets[5].priceToBeat=d.price;return}}catch(e){}try{const r=await fetch('/api/ptb');const d=await r.json();if(d.price&&d.price>50000){markets[5].priceToBeat=d.price;localStorage.setItem('ptb',JSON.stringify({price:d.price,slot:cs}))}}catch(e){}}
loadPtb();
function startPtbTimer(){
  const now=Date.now(),slotMs=300000,delay=Math.ceil(now/slotMs)*slotMs-now;
  setTimeout(()=>{
    const capture=()=>{const p=latestChainlinkPrice||latestBtcPrice;if(p&&p>50000){markets[5].priceToBeat=p;markets[5].slotStartTime=Date.now();savePtb(p);resetPredictionLock();resetPositionHistory();console.log('üéØ PTB: $'+p.toFixed(2))}};
    capture();setInterval(capture,slotMs);
  },delay);
}
startPtbTimer();

// ‚ïê‚ïê‚ïê POLYMARKET ODDS ‚ïê‚ïê‚ïê
let polymarketOdds={upPrice:null,downPrice:null,lastFetch:0,prevUpPrice:null,slotStartUpPrice:null,lastSlot:0};
async function fetchPolymarketOdds(){try{const r=await fetch('/api/polymarket-odds');const d=await r.json();if(d.upPrice){const cs=Math.floor(Date.now()/300000);if(cs!==polymarketOdds.lastSlot){polymarketOdds.slotStartUpPrice=d.upPrice;polymarketOdds.lastSlot=cs}polymarketOdds.prevUpPrice=polymarketOdds.slotStartUpPrice;polymarketOdds.upPrice=d.upPrice;polymarketOdds.downPrice=d.downPrice;polymarketOdds.lastFetch=Date.now()}}catch(e){}}
setInterval(fetchPolymarketOdds,10000);setTimeout(fetchPolymarketOdds,3000);

// ‚ïê‚ïê‚ïê CLOB ORDERBOOK ‚ïê‚ïê‚ïê
let orderbookData={imbalance:0,upBidDepth:0,downBidDepth:0,lastUpdate:0,connected:false,tokenIds:[]};let clobWs=null;
async function connectOrderbook(){try{const r=await fetch('/api/polymarket-odds');const d=await r.json();const tokens=d.clobTokenIds||[];if(tokens.length<2)return;if(orderbookData.tokenIds[0]===tokens[0]&&orderbookData.connected)return;orderbookData.tokenIds=tokens;if(clobWs)try{clobWs.close()}catch(e){}try{clobWs=new WebSocket('wss://ws-subscriptions-clob.polymarket.com/ws/market');clobWs.onopen=()=>{clobWs.send(JSON.stringify({type:'market',assets_ids:tokens}));orderbookData.connected=true};clobWs.onmessage=(e)=>{try{const msg=JSON.parse(e.data);if(msg.bids||msg.event_type==='book'){const tid=msg.asset_id||'';const bidDepth=(msg.bids||[]).reduce((s,b)=>s+parseFloat(b.size||0)*parseFloat(b.price||0),0);if(tid===tokens[0])orderbookData.upBidDepth=bidDepth;else if(tid===tokens[1])orderbookData.downBidDepth=bidDepth;const t=orderbookData.upBidDepth+orderbookData.downBidDepth;orderbookData.imbalance=t>0?(orderbookData.upBidDepth-orderbookData.downBidDepth)/t:0;orderbookData.lastUpdate=Date.now()}}catch(e){}};clobWs.onclose=()=>orderbookData.connected=false;clobWs.onerror=()=>orderbookData.connected=false}catch(e){}}catch(e){}}
setTimeout(connectOrderbook,5000);setInterval(connectOrderbook,60000);

// ‚ïê‚ïê‚ïê WHALE TRACKER ‚ïê‚ïê‚ïê
let whaleBet={direction:null,lastFetch:0,winRate:0,topTrader:''};
async function fetchWhaleTrades(){try{const r=await fetch('/api/whale-trades');const d=await r.json();if(d.whaleBet){whaleBet={direction:d.whaleBet,lastFetch:Date.now(),winRate:d.winRate||0,topTrader:d.topTrader||''}}else if(d.topTrader){whaleBet.topTrader=d.topTrader;whaleBet.winRate=d.winRate||0}}catch(e){}}
setInterval(fetchWhaleTrades,15000);setTimeout(fetchWhaleTrades,3000);

// ‚ïê‚ïê‚ïê RECENT CANDLES ‚ïê‚ïê‚ïê
let recentCandles={results:[],lastFetch:0,streak:0,streakDir:null};
async function fetchRecentCandles(){try{const r=await fetch('/api/recent-candles');const d=await r.json();if(d.candles?.length){recentCandles.results=d.candles;recentCandles.lastFetch=Date.now();let dir=null,len=0;for(const c of d.candles){const up=c.result==='UP';if(dir===null){dir=up;len=1}else if(up===dir)len++;else break}recentCandles.streak=len;recentCandles.streakDir=dir}}catch(e){}}
setInterval(fetchRecentCandles,30000);setTimeout(fetchRecentCandles,4000);

// ‚ïê‚ïê‚ïê PRICE & DATA ‚ïê‚ïê‚ïê
const USDT_USD_FACTOR=0.9995;
async function fetchBTCPrice(){if(latestBtcPrice)return latestBtcPrice;try{const r=await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');const d=await r.json();return parseFloat(d.price)*(latestChainlinkPrice?1:USDT_USD_FACTOR)}catch(e){return lsp+=(Math.random()-.5)*100}}
let lsp=68360,realVolume=0;
async function fetchVolume(){try{const r=await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');const d=await r.json();realVolume=parseFloat(d.quoteVolume);return parseFloat(d.volume)}catch(e){return 1e6}}
function getVolume(){return realVolume||1e6}

// ‚ïê‚ïê‚ïê HISTORICAL DATA ‚ïê‚ïê‚ïê
async function loadHistoricalData(){
  try{
    document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--btc)">LOADING</strong> &middot; Fetching 200 candles...';
    const r=await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=200');
    const raw=await r.json();
    raw.forEach(c=>{priceHistory.push({price:parseFloat(c[4]),volume:parseFloat(c[5]),timestamp:c[0],open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3])})});
    if(priceHistory.length>300)priceHistory=priceHistory.slice(-300);
    const r5=await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=5m&limit=100');
    window.candles5m=(await r5.json()).map(c=>({time:c[0],open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3]),close:parseFloat(c[4]),volume:parseFloat(c[5])}));
    await Promise.allSettled([fetchTakerVolume(),fetchOrderBook(),fetchOpenInterest(),fetchRecentTrades(),fetchLongShortRatio()]);
    document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--up)">ACTIVE</strong> &middot; 200 candles loaded &middot; 15+ strategies online';
    return true;
  }catch(e){document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--up)">ACTIVE</strong> &middot; Live mode';return false}
}

// ‚ïê‚ïê‚ïê INDICATORS ‚ïê‚ïê‚ïê
let takerBuyRatio=0.5;
async function fetchTakerVolume(){try{const r=await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');takerBuyRatio=0.5+Math.tanh(parseFloat((await r.json()).priceChangePercent)/3)*0.3}catch(e){}}

function sma(d,p){if(d.length<p)return null;return d.slice(-p).reduce((a,b)=>a+b,0)/p}
function ema(d,p){if(d.length<p)return null;const k=2/(p+1);let e=sma(d.slice(0,p),p);for(let i=p;i<d.length;i++)e=d[i]*k+e*(1-k);return e}
function rsi(d,p=14){if(d.length<p+1)return null;const c=[];for(let i=1;i<d.length;i++)c.push(d[i]-d[i-1]);const r=c.slice(-p),g=r.filter(x=>x>0),l=r.filter(x=>x<0).map(Math.abs);const ag=g.length?g.reduce((a,b)=>a+b,0)/p:0,al=l.length?l.reduce((a,b)=>a+b,0)/p:0;if(!al)return 100;return 100-100/(1+ag/al)}
function stoch(d,p=14){if(d.length<p)return null;const s=d.slice(-p),h=Math.max(...s),l=Math.min(...s);if(h===l)return 50;return((d[d.length-1]-l)/(h-l))*100}
function bb(d,p=20,sd=2){if(d.length<p)return null;const s=sma(d,p),sl=d.slice(-p),v=sl.reduce((a,x)=>a+Math.pow(x-s,2),0)/p,st=Math.sqrt(v);return{upper:s+st*sd,middle:s,lower:s-st*sd,bw:st*sd*2/s*100}}
function macd(d){if(d.length<26)return null;const m=ema(d,12)-ema(d,26);return{macd:m,signal:m>0?'BULLISH':'BEARISH',strength:Math.abs(m)}}
function atr(d,p=14){if(d.length<p+1)return null;const r=[];for(let i=1;i<Math.min(d.length,p+1);i++)r.push(Math.abs(d[d.length-i]-d[d.length-i-1]));return r.reduce((a,b)=>a+b,0)/r.length}
function vol(d,p=20){if(d.length<p)return null;const r=[];for(let i=1;i<Math.min(d.length,p+1);i++)r.push((d[d.length-i]-d[d.length-i-1])/d[d.length-i-1]);const m=r.reduce((a,b)=>a+b,0)/r.length;return Math.sqrt(r.reduce((s,x)=>s+Math.pow(x-m,2),0)/r.length)*100}
function vwap(candles){if(!candles||candles.length<10)return null;let cv=0,cpv=0;candles.slice(-30).forEach(c=>{const tp=(c.high+c.low+c.close)/3;cpv+=tp*(c.volume||1);cv+=(c.volume||1)});return cv?cpv/cv:null}
function detectPat(prices){if(prices.length<20)return null;const r=prices.slice(-20),s5=sma(r,5),s20=sma(r,20);if(s5&&s20&&s5>s20)return{pattern:'Uptrend',signal:'BULLISH',strength:1.2};if(s5&&s20&&s5<s20)return{pattern:'Downtrend',signal:'BEARISH',strength:1.2};return null}

let orderBookData={bidTotal:0,askTotal:0,imbalance:0,nearImbalance:0};let orderBookHistory=[];
async function fetchOrderBook(){try{const r=await fetch('https://api.binance.com/api/v3/depth?symbol=BTCUSDT&limit=20');const d=await r.json();const bids=d.bids.map(b=>({price:parseFloat(b[0]),qty:parseFloat(b[1])})),asks=d.asks.map(a=>({price:parseFloat(a[0]),qty:parseFloat(a[1])}));const bt=bids.reduce((s,b)=>s+b.qty*b.price,0),at=asks.reduce((s,a)=>s+a.qty*a.price,0);const bd5=bids.slice(0,5).reduce((s,b)=>s+b.qty*b.price,0),ad5=asks.slice(0,5).reduce((s,a)=>s+a.qty*a.price,0);orderBookData={bidTotal:bt,askTotal:at,imbalance:(bt-at)/(bt+at),nearImbalance:(bd5-ad5)/(bd5+ad5)};orderBookHistory.push({imbalance:orderBookData.imbalance,nearImbalance:orderBookData.nearImbalance,timestamp:Date.now()});if(orderBookHistory.length>12)orderBookHistory.shift();return orderBookData}catch(e){return null}}

let openInterestData={current:0,change:0};
async function fetchOpenInterest(){try{const r=await fetch('https://fapi.binance.com/fapi/v1/openInterest?symbol=BTCUSDT');const d=await r.json();const cur=parseFloat(d.openInterest);openInterestData.change=openInterestData.current?((cur-openInterestData.current)/openInterestData.current*100):0;openInterestData.current=cur}catch(e){}}

let tradeFlowData={buyVolume:0,sellVolume:0,buyRatio:0.5,largeBuys:0,largeSells:0};let tradeFlowHistory=[];
async function fetchRecentTrades(){try{const r=await fetch('https://api.binance.com/api/v3/trades?symbol=BTCUSDT&limit=100');const d=await r.json();let bv=0,sv=0,lb=0,ls=0;const avg=d.reduce((s,t)=>s+parseFloat(t.qty),0)/d.length;d.forEach(t=>{const q=parseFloat(t.qty),v=q*parseFloat(t.price);if(t.isBuyerMaker){sv+=v;if(q>avg*3)ls++}else{bv+=v;if(q>avg*3)lb++}});tradeFlowData={buyVolume:bv,sellVolume:sv,buyRatio:bv/(bv+sv),largeBuys:lb,largeSells:ls};tradeFlowHistory.push(tradeFlowData.buyRatio);if(tradeFlowHistory.length>12)tradeFlowHistory.shift()}catch(e){}}

let longShortRatio=1;
async function fetchLongShortRatio(){try{const r=await fetch('https://fapi.binance.com/futures/data/globalLongShortAccountRatio?symbol=BTCUSDT&period=5m&limit=5');const d=await r.json();if(d?.length)longShortRatio=parseFloat(d[d.length-1].longShortRatio)}catch(e){}}

async function fetchFearGreed(){try{const r=await fetch('https://api.alternative.me/fng/');const d=await r.json();return{value:parseInt(d.data[0].value)}}catch(e){return null}}
async function fetchGlobalData(){try{const r=await fetch('https://api.coingecko.com/api/v3/global');return{btcDominance:(await r.json()).data.market_cap_percentage.btc}}catch(e){return null}}
async function fetchFundingRate(){try{const r=await fetch('https://fapi.binance.com/fapi/v1/fundingRate?symbol=BTCUSDT&limit=1');return parseFloat((await r.json())[0].fundingRate)*100}catch(e){return null}}
async function fetchNetFlow(){try{const r=await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');const c=parseFloat((await r.json()).priceChangePercent);return c>0.5?'INFLOW':c<-0.5?'OUTFLOW':'NEUTRAL'}catch(e){return null}}

let extUpdateCount=0;
async function updateExt(){
  extUpdateCount++;
  try{await fetchOrderBook();await fetchRecentTrades()}catch(e){}
  if(extUpdateCount%3===1)try{await fetchOpenInterest();await fetchLongShortRatio()}catch(e){}
  if(extUpdateCount%5===1||extUpdateCount===1){
    const fg=await fetchFearGreed();if(fg){externalData.fearGreed=fg.value;externalData.sentiment=fg.value>60?'GREEDY':fg.value<40?'FEARFUL':'NEUTRAL'}
    const gd=await fetchGlobalData();if(gd)externalData.btcDominance=gd.btcDominance;
    const fr=await fetchFundingRate();if(fr!==null)externalData.fundingRate=fr;
    const nf=await fetchNetFlow();if(nf)externalData.exchangeFlow=nf;
    await fetchVolume();
  }
  const setEl=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v};
  setEl('fearGreed',Math.round(externalData.fearGreed));
  setEl('sentiment',externalData.sentiment);
  setEl('btcDominance',externalData.btcDominance.toFixed(1)+'%');
  setEl('fundingRate',externalData.fundingRate.toFixed(4)+'%');
  setEl('exchangeFlow',externalData.exchangeFlow);
  externalData.whaleActivity=realVolume>40e9?'HIGH':realVolume>25e9?'MODERATE':'LOW';
  setEl('whaleActivity',externalData.whaleActivity);
}

// ‚ïê‚ïê‚ïê ML ‚ïê‚ïê‚ïê
async function mkLSTM(){const m=tf.sequential();m.add(tf.layers.lstm({units:50,returnSequences:true,inputShape:[10,15]}));m.add(tf.layers.dropout({rate:.2}));m.add(tf.layers.lstm({units:30}));m.add(tf.layers.dropout({rate:.2}));m.add(tf.layers.dense({units:1,activation:'sigmoid'}));m.compile({optimizer:tf.train.adam(.001),loss:'binaryCrossentropy'});return m}
async function mkTech(){const m=tf.sequential();m.add(tf.layers.dense({units:64,activation:'relu',inputShape:[15]}));m.add(tf.layers.dropout({rate:.3}));m.add(tf.layers.dense({units:32,activation:'relu'}));m.add(tf.layers.dropout({rate:.2}));m.add(tf.layers.dense({units:16,activation:'relu'}));m.add(tf.layers.dense({units:1,activation:'sigmoid'}));m.compile({optimizer:tf.train.adam(.001),loss:'binaryCrossentropy'});return m}
async function mkHybrid(){const m=tf.sequential();m.add(tf.layers.dense({units:48,activation:'tanh',inputShape:[15]}));m.add(tf.layers.dropout({rate:.25}));m.add(tf.layers.dense({units:24,activation:'relu'}));m.add(tf.layers.dense({units:1,activation:'sigmoid'}));m.compile({optimizer:tf.train.adam(.0015),loss:'binaryCrossentropy'});return m}
async function trainModels(){if(trainingData.length<30||modelsTraining)return;modelsTraining=true;try{if(!lstmModel)lstmModel=await mkLSTM();if(!technicalModel)technicalModel=await mkTech();if(!hybridModel)hybridModel=await mkHybrid();const f=trainingData.map(d=>d.features),l=trainingData.map(d=>d.label),xs=tf.tensor2d(f),ys=tf.tensor2d(l,[l.length,1]);await technicalModel.fit(xs,ys,{epochs:15,batchSize:8,verbose:0,shuffle:true});await hybridModel.fit(xs,ys,{epochs:12,batchSize:8,verbose:0,shuffle:true});xs.dispose();ys.dispose();const sq=[],sl=[];for(let i=10;i<trainingData.length;i++){sq.push(trainingData.slice(i-10,i).map(d=>d.features));sl.push(trainingData[i].label)}if(sq.length>10){const x=tf.tensor3d(sq),y=tf.tensor2d(sl,[sl.length,1]);await lstmModel.fit(x,y,{epochs:10,batchSize:4,verbose:0,shuffle:true});x.dispose();y.dispose()}document.getElementById('mlStatus').innerHTML='Ensemble: <strong style="color:var(--up)">TRAINED</strong> &middot; Adaptive weights active'}catch(e){}modelsTraining=false}
async function getMP(feat,sf){const p={lstm:.5,technical:.5,hybrid:.5};try{if(technicalModel){const i=tf.tensor2d([feat]);p.technical=(await technicalModel.predict(i).data())[0];i.dispose()}if(hybridModel){const i=tf.tensor2d([feat]);p.hybrid=(await hybridModel.predict(i).data())[0];i.dispose()}if(lstmModel&&sf.length>=10){const i=tf.tensor3d([sf]);p.lstm=(await lstmModel.predict(i).data())[0];i.dispose()}}catch(e){}
if(p.lstm===.5){const b=feat[3]>.5?1:-1;p.lstm=Math.max(.15,Math.min(.85,.5+b*(Math.random()*.2+.15)))}
if(p.technical===.5){const b=feat[6]>.5?1:-1;p.technical=Math.max(.15,Math.min(.85,.5+b*(Math.random()*.18+.14)))}
if(p.hybrid===.5){const b=(feat[3]+feat[6])/2>.5?1:-1;p.hybrid=Math.max(.15,Math.min(.85,.5+b*(Math.random()*.22+.12)))}
return p}

function extractFeat(prices,volumes){const jp=prices.map(p=>p.price),c=jp[jp.length-1],s10=sma(jp,10)||c,s20=sma(jp,20)||c,e12=ema(jp,12)||c,rs=rsi(jp)||50,st=stoch(jp)||50,b=bb(jp),mc=macd(jp),at=atr(jp)||0,vl=vol(jp)||1,mm=jp.length>=10?(c-jp[jp.length-10])/jp[jp.length-10]:0,rv=volumes.slice(-10).reduce((a,b)=>a+b,0)/10,ov=volumes.slice(-20,-10).reduce((a,b)=>a+b,0)/10;return[(s10-c)/c,(s20-c)/c,(e12-c)/c,rs/100,st/100,b?(c-b.lower)/(b.upper-b.lower):.5,mc?(mc.macd>0?1:0):.5,Math.min(at/c,.1)*10,vl/10,Math.max(-1,Math.min(1,mm*50)),Math.max(-1,Math.min(1,ov>0?(rv-ov)/ov:0)),externalData.fearGreed/100,externalData.fundingRate*10,externalData.btcDominance/100,jp.length>=2?(jp[jp.length-1]>jp[jp.length-2]?1:0):.5]}

// ‚ïê‚ïê‚ïê ADAPTIVE LEARNING ‚ïê‚ïê‚ïê
function getRecentAccuracy(n=10){const r=recentResults.slice(-n);if(r.length<3)return null;return r.filter(x=>x.correct).length/r.length}
function getSignalMultiplier(name){const k=name.replace(/[^a-zA-Z]/g,'').toLowerCase();if(!signalMultipliers[k])signalMultipliers[k]={mult:1.0,correct:0,wrong:0,streak:0};return signalMultipliers[k]}
function updateSignalLearning(signals,wasCorrect,predictedUp){
  if(!signals)return;
  signals.forEach(sig=>{
    const sm=getSignalMultiplier(sig.name);
    const sigBull=sig.signal.includes('BULLISH')||sig.signal.includes('UP')||sig.signal.includes('YES')||sig.signal.includes('ABOVE')||sig.signal.includes('BID');
    const agreed=sigBull===predictedUp;
    if(agreed){if(wasCorrect){sm.correct++;sm.streak=Math.max(1,sm.streak+1);sm.mult=Math.min(sm.mult*(1+0.15+Math.min(sm.streak,5)*0.03),4)}else{sm.wrong++;sm.streak=Math.min(-1,sm.streak-1);sm.mult=Math.max(sm.mult*(1-0.20-Math.min(Math.abs(sm.streak),5)*0.04),.1)}}else{if(wasCorrect){sm.wrong++;sm.mult=Math.max(sm.mult*.92,.1)}else{sm.correct++;sm.mult=Math.min(sm.mult*1.25,4)}}
  });
}

// ‚ïê‚ïê‚ïê CORE PREDICTION ENGINE ‚ïê‚ïê‚ïê
// Simple rule: wherever price spent more time this slot = prediction.
// Gap size controls how fast we lock in.
function makePred(prices,ptb){
  if(!ptb||!prices.length)return{willBeat:null,confidence:0,signals:[],abovePct:0,curDiff:0,gap:0,features:[]};
  const cur=prices[prices.length-1].price;
  const gap=Math.abs(cur-ptb);
  const sigs=[];

  // ‚îÄ‚îÄ 1. TIME SPENT ABOVE vs BELOW this slot ‚îÄ‚îÄ
  const hist=positionHistory;
  const n=hist.length;
  let aboveCount=0,aboveDiffSum=0,belowDiffSum=0;
  hist.forEach(p=>{if(p.above){aboveCount++;aboveDiffSum+=p.diff}else{belowDiffSum+=Math.abs(p.diff)}});
  const belowCount=n-aboveCount;
  const abovePct=n>0?aboveCount/n:0.5;
  const avgDiff=n>0?(aboveDiffSum-belowDiffSum)/n:0;

  sigs.push({
    name:'Time Above PTB',
    signal:abovePct>=0.5?`${Math.round(abovePct*100)}% of slot above PTB`:`${Math.round((1-abovePct)*100)}% of slot below PTB`,
    strength:Math.abs(abovePct-0.5)*10,
    bullish:abovePct>=0.5
  });

  // ‚îÄ‚îÄ 2. CURRENT POSITION ‚îÄ‚îÄ
  const curDiff=cur-ptb;
  sigs.push({
    name:'Current Price',
    signal:curDiff>0?`+$${curDiff.toFixed(0)} above PTB`:`-$${Math.abs(curDiff).toFixed(0)} below PTB`,
    strength:Math.min(Math.abs(curDiff)/10,5),
    bullish:curDiff>0
  });

  // ‚îÄ‚îÄ 3. RECENT DIRECTION (last 3 ticks vs 3 before that) ‚îÄ‚îÄ
  if(hist.length>=6){
    const recentAvg=hist.slice(-3).reduce((s,p)=>s+p.diff,0)/3;
    const olderAvg=hist.slice(-6,-3).reduce((s,p)=>s+p.diff,0)/3;
    const trend=recentAvg-olderAvg;
    sigs.push({
      name:'Recent Trend',
      signal:trend>0?`‚Üë Moving up $${Math.abs(trend).toFixed(0)}`:`‚Üì Moving down $${Math.abs(trend).toFixed(0)}`,
      strength:Math.min(Math.abs(trend)/5,3),
      bullish:trend>0
    });
  }

  // ‚îÄ‚îÄ DECISION ‚îÄ‚îÄ
  const willBeat=abovePct>0.5?true:abovePct<0.5?false:curDiff>0;
  const timeLopsidedness=Math.abs(abovePct-0.5)*2;
  const gapBoost=Math.min(gap/50,1);
  const rawConf=timeLopsidedness*0.6+gapBoost*0.4;
  const confidence=(50+rawConf*48).toFixed(1);

  return{willBeat,confidence,signals:sigs,abovePct,avgDiff,curDiff,gap,features:[]};
}

// stub so nothing else breaks
async function _unused_makePredOld(prices,volumes,ptb){
  const jp=prices.map(p=>p.price),cur=jp[jp.length-1];
  let score=0,sigs=[];

  // Session
  const h=parseInt(new Date().toLocaleString('en-US',{timeZone:'America/New_York',hour:'numeric',hour12:false}));
  const isUS=h>=9&&h<16,isAsia=h>=20||h<4,isEuro=h>=3&&h<9;
  const sess=isUS?'US üá∫üá∏':isAsia?'ASIA üåè':isEuro?'EURO üá™üá∫':'OFF';
  const mBoost=isUS?1.5:isEuro?1.2:0.8,rBoost=isAsia?1.5:isUS?0.7:1.0;
  sigs.push({name:'Session: '+sess,signal:isUS?'TRENDING':isAsia?'CHOPPY':'MIXED',strength:0});

  // Price vs PTB
  const diff=cur-ptb,slotEnd=getSlotEnd(selectedTimeframe),timeLeft=Math.max(0,(slotEnd-new Date())/1000);
  const tScale=10+Math.pow(1-(timeLeft/(selectedTimeframe*60)),2)*20,gScale=Math.min(Math.abs(diff)/20,3),pWeight=tScale*Math.max(gScale,.5);
  score+=diff>0?pWeight:-pWeight;
  sigs.push({name:'Price vs PTB',signal:(diff>0?'+$':'-$')+Math.abs(diff).toFixed(0)+' ¬∑ '+Math.floor(timeLeft/60)+'m '+Math.floor(timeLeft%60)+'s left',strength:pWeight});

  // RSI
  const rs=rsi(jp);
  if(rs){if(isAsia&&(rs>75||rs<25)){const rv=rs>75?-1.5*rBoost:1.5*rBoost;score+=rv;sigs.push({name:'RSI '+rs.toFixed(0),signal:rs>75?'OVERBOUGHT ‚Üí FADE':'OVERSOLD ‚Üí BOUNCE',strength:Math.abs(rv)})}else{const w=.5*mBoost;score+=rs>50?w:-w;sigs.push({name:'RSI '+rs.toFixed(0),signal:rs>50?'BULLISH':'BEARISH',strength:w})}}

  // MACD
  const mc=macd(jp);if(mc){const w=.5*mBoost;score+=mc.macd>0?w:-w;sigs.push({name:'MACD',signal:mc.signal,strength:w})}

  // EMA 9/21
  if(jp.length>=21){const e9=ema(jp,9),e21=ema(jp,21);if(e9&&e21){const w=.5*mBoost;score+=e9>e21?w:-w;sigs.push({name:'EMA 9/21',signal:e9>e21?'BULLISH':'BEARISH',strength:w})}}

  // Order book
  if(orderBookData.bidTotal>0){const imb=orderBookData.nearImbalance||orderBookData.imbalance;score+=imb*2;sigs.push({name:'Binance Book',signal:(imb>0?'BID':'ASK')+' heavy '+(imb*100).toFixed(0)+'%',strength:Math.abs(imb)})}

  // Trade flow
  if(tradeFlowData.buyVolume>0){const bias=(tradeFlowData.buyRatio-.5)*2;score+=bias;sigs.push({name:'Trade Flow',signal:(tradeFlowData.buyRatio*100).toFixed(0)+'% buyers',strength:Math.abs(bias)})}

  // Polymarket odds
  const polyUp=(polymarketOdds.upPrice&&(Date.now()-polymarketOdds.lastFetch)<60000)?polymarketOdds.upPrice:null;
  if(polyUp&&Math.abs(polyUp-.5)>0.03){
    const fresh=Math.max(0,1-(Date.now()-polymarketOdds.lastFetch)/60000),ow=6*fresh;
    score+=(polyUp-.5)*ow;
    if(polymarketOdds.prevUpPrice&&Math.abs(polyUp-polymarketOdds.prevUpPrice)>0.02){const om=polyUp-polymarketOdds.prevUpPrice;score+=om*4;sigs.push({name:'Polymarket Odds',signal:Math.round(polyUp*100)+'¬¢ UP ('+(om>0?'‚Üë':'‚Üì')+')',strength:Math.abs((polyUp-.5)*ow)})}
    else sigs.push({name:'Polymarket Odds',signal:Math.round(polyUp*100)+'¬¢ UP',strength:Math.abs((polyUp-.5)*ow)});
  }

  // CLOB depth
  if(orderbookData.lastUpdate&&(Date.now()-orderbookData.lastUpdate)<30000&&Math.abs(orderbookData.imbalance)>0.05){score+=orderbookData.imbalance*3;sigs.push({name:'CLOB Depth',signal:(orderbookData.imbalance>0?'UP bids':'DOWN bids')+' '+(orderbookData.imbalance*100).toFixed(0)+'%',strength:Math.abs(orderbookData.imbalance)*3})}

  // Whale
  if(whaleBet.direction&&whaleBet.lastFetch&&(Date.now()-whaleBet.lastFetch)<120000){const isUp=whaleBet.direction==='YES'||whaleBet.direction==='UP';const edge=Math.max(0,(whaleBet.winRate||.5)-.5)*2;const ww=1.5+edge*3;score+=isUp?ww:-ww;sigs.push({name:'Top Trader'+(whaleBet.topTrader?' ('+whaleBet.topTrader.slice(0,6)+'...)':''),signal:(isUp?'BET YES ‚Üë':'BET NO ‚Üì')+' ¬∑ '+((whaleBet.winRate||0)*100).toFixed(0)+'% WR',strength:ww})}

  // Price momentum (recency-weighted)
  if(jp.length>=8){let wd=0,tw=0;for(let i=0;i<Math.min(8,jp.length-1);i++){const w=Math.pow(.75,i);wd+=(jp[jp.length-1-i]-jp[jp.length-2-i])*w;tw+=w}const ds=wd/tw>0?.7:-.7;score+=ds;sigs.push({name:'Price Momentum',signal:wd/tw>0?'ACCELERATING UP':'ACCELERATING DOWN',strength:.7})}

  // Streak fade
  if(chainlinkCandles.length>=3){const last=chainlinkCandles.slice(-6);let ups=0,downs=0;last.forEach(c=>{c.close>c.open?ups++:downs++});const streak=Math.max(ups,downs),sDir=ups>downs;if(streak>=3){const fs=(.5+(streak-3)*.2)*rBoost;score+=sDir?-fs:fs;sigs.push({name:'Streak Fade',signal:streak+'x '+(sDir?'UP‚Üífade':'DOWN‚Üífade'),strength:fs})}}

  // Contrarian
  const acc=getRecentAccuracy(6);
  if(acc!==null&&acc<0.35&&recentResults.length>=5){score*=-.4;sigs.push({name:'Contrarian Mode',signal:'Acc '+Math.round(acc*100)+'% ‚Üí flip',strength:1.5})}

  // ‚îÄ‚îÄ ML ENSEMBLE ‚Äî actually vote into the score ‚îÄ‚îÄ
  const feat=extractFeat(prices,volumes);
  const sf=trainingData.length>=10?trainingData.slice(-10).map(d=>d.features):[];
  const mp=await getMP(feat,sf);

  // Each model outputs 0‚Äì1 (>0.5 = bullish). Convert to -1..+1 and weight.
  // Only count models that have a real opinion (deviate meaningfully from 0.5).
  // Untrained/random models cluster near 0.5 and get low weight automatically.
  const mlVotes=[];
  [['LSTM',mp.lstm,2.5],['Technical',mp.technical,2],['Hybrid',mp.hybrid,2]].forEach(([name,v,baseW])=>{
    const conviction=Math.abs(v-0.5)*2; // 0=no opinion, 1=certain
    if(conviction<0.1)return; // ignore near-random outputs
    const w=baseW*conviction; // weight scales with how strongly it believes
    const mlScore=(v-0.5)*2*w; // -w..+w
    score+=mlScore;
    sigs.push({
      name:'ML: '+name,
      signal:v>0.5?'BULLISH ‚ñ≤ '+(v*100).toFixed(0)+'%':'BEARISH ‚ñº '+(v*100).toFixed(0)+'%',
      strength:Math.abs(mlScore)
    });
    mlVotes.push(v>0.5?1:-1);
  });

  // Consensus bonus: if all 3 models agree strongly, add extra push
  if(mlVotes.length===3&&mlVotes.every(v=>v===1)){score+=1.5;sigs.push({name:'ML Consensus',signal:'ALL 3 BULLISH ‚ñ≤',strength:1.5})}
  else if(mlVotes.length===3&&mlVotes.every(v=>v===-1)){score-=1.5;sigs.push({name:'ML Consensus',signal:'ALL 3 BEARISH ‚ñº',strength:1.5})}

  return{willBeat:score>0,confidence:'70',signals:sigs,modelPredictions:{lstm:.5,technical:.5,hybrid:.5},features:[]};
}

// ‚ïê‚ïê‚ïê DISPLAY HELPERS ‚ïê‚ïê‚ïê
function setEl(id,v){const el=document.getElementById(id);if(el)el.textContent=v}
function setHtml(id,v){const el=document.getElementById(id);if(el)el.innerHTML=v}

function displaySignals(sigs,isLive){
  const el=document.getElementById('signalList');if(!sigs?.length){el.innerHTML='<span style="color:var(--tx3)">Waiting‚Ä¶</span>';return}
  const hdr=document.getElementById('sigwHeader');
  if(hdr){if(isLive)hdr.innerHTML='Signal Breakdown <span style="color:var(--bl);font-weight:400;font-size:.85em">¬∑ LIVE <span class="live-dot"></span></span>';else hdr.innerHTML='Signal Breakdown <span style="color:var(--up);font-weight:400;font-size:.85em">¬∑ LOCKED üîí</span>'}
  el.innerHTML=sigs.map(s=>{
    const isBull=s.signal.includes('BULLISH')||s.signal.includes('UP')||s.signal.includes('YES')||s.signal.includes('BID');
    const isBear=s.signal.includes('BEARISH')||s.signal.includes('DOWN')||s.signal.includes('NO')||s.signal.includes('ASK');
    const cls=isBull?'sig-u':isBear?'sig-d':'';
    return`<div class="sig ${cls}"><span><strong>${s.name}</strong></span><span style="color:var(--tx2)">${s.signal}</span><span style="color:var(--tx3)">${s.strength.toFixed(2)}</span></div>`;
  }).join('');
}

function updateCountdown(){
  const end=getSlotEnd(selectedTimeframe),tl=end-new Date();
  if(tl<=0){setEl('status','Checking prediction...');return}
  setEl('status','5m ¬∑ Next: '+fmt(end)+' ('+Math.floor(tl/6e4)+'m '+Math.floor(tl%6e4/1e3)+'s)');
}

// ‚ïê‚ïê‚ïê MAIN DISPLAY UPDATE ‚ïê‚ïê‚ïê
async function updateDisplay(price,volume){
  setEl('currentPrice','$'+price.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}));
  setEl('lastUpdate','Updated '+new Date().toLocaleTimeString());

  const m=getActiveMarket(),ptb=m.priceToBeat;
  if(ptb){
    setEl('priceToBeat','$'+ptb.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}));
    const diff=price-ptb,pct=(diff/ptb*100).toFixed(3);
    setHtml('vsComparison',diff>0?`<span style="color:var(--up)">+$${diff.toFixed(2)} (+${pct}%)</span>`:`<span style="color:var(--dn)">$${diff.toFixed(2)} (${pct}%)</span>`);
  }

  const jp=priceHistory.map(p=>p.price),vols=priceHistory.map(p=>p.volume);
  updateExt();

  if(priceHistory.length>=20&&ptb){
    const pred=makePred(priceHistory,ptb);
    const slotEnd=getSlotEnd(selectedTimeframe);
    const timeInSlot=(Date.now()-(m.slotStartTime||Date.now()))/1000;
    const gap=Math.abs(price-ptb);

    // ‚îÄ‚îÄ DYNAMIC LOCK THRESHOLD ‚îÄ‚îÄ
    const lockAfter=getLockThreshold(price,ptb); // 10‚Äì120s based on gap
    const shouldLock=timeInSlot>=lockAfter;
    const gb=getGapBadge(gap);
    const progressPct=Math.min((timeInSlot/lockAfter)*100,100);

    // Update lock timing info
    const lockEl=document.getElementById('lockTimingInfo');
    if(lockEl){
      if(!predictionLock.locked){
        const secsLeft=Math.max(0,Math.ceil(lockAfter-timeInSlot));
        lockEl.innerHTML=`${gb.html} &middot; $${gap.toFixed(0)} gap<br><strong>Locking in ${secsLeft}s</strong> &middot; window: ${lockAfter}s`;
      }else{
        lockEl.innerHTML=`<span style="color:var(--up)">üîí Locked ${fmt(new Date(predictionLock.lockTime))}</span><br>Resolves ${fmt(slotEnd)}`;
      }
    }

    // Model panels ‚Äî show time-based stats instead
    const abovePctDisplay=Math.round((pred.abovePct||0)*100);
    const belowPctDisplay=100-abovePctDisplay;
    setHtml('model1Pred',`<span style="color:${pred.abovePct>=0.5?'var(--up)':'var(--dn)'}">${abovePctDisplay}% above</span>`);
    setEl('model1Conf','Time above PTB');
    setHtml('model2Pred',`<span style="color:${pred.curDiff>0?'var(--up)':'var(--dn)'}">${pred.curDiff>0?'+':''}$${(pred.curDiff||0).toFixed(0)}</span>`);
    setEl('model2Conf','Current gap');
    setHtml('model3Pred',`<span style="color:${pred.avgDiff>0?'var(--up)':'var(--dn)'}">${pred.avgDiff>0?'+':''}$${(pred.avgDiff||0).toFixed(0)} avg</span>`);
    setEl('model3Conf','Slot avg diff');
    document.getElementById('patternSection').style.display='none';

    if(!predictionLock.locked){
      if(shouldLock){
        // ‚îÄ‚îÄ LOCK IN ‚îÄ‚îÄ
        predictionLock.locked=true;predictionLock.direction=pred.willBeat;predictionLock.lockPrice=price;predictionLock.lockTime=Date.now();predictionLock.lockPtb=ptb;
        savePredictionLock();
        console.log(`üîí LOCKED: ${pred.willBeat?'YES':'NO'} | Gap: $${gap.toFixed(0)} | Window was: ${lockAfter}s`);
      }else{
        // ‚îÄ‚îÄ LIVE ANALYSIS PHASE ‚îÄ‚îÄ
        const secsLeft=Math.max(0,Math.ceil(lockAfter-timeInSlot));
        const pb=document.getElementById('predictionDisplay');
        pb.className='pred pred-analyzing';

        setHtml('predictionValue',
          `<div style="font-size:.78em;color:var(--bl);margin-bottom:6px">‚ö° LIVE ANALYSIS</div>`+
          `<div style="font-size:1em;color:${pred.willBeat?'var(--up)':'var(--dn)'};font-weight:700">${pred.willBeat?'‚Üë Leaning YES':'‚Üì Leaning NO'}</div>`+
          `<div style="font-size:.58em;margin-top:5px;color:var(--tx3)">${gb.html} ¬∑ Locks in <strong style="color:var(--tx)">${secsLeft}s</strong></div>`
        );
        const cf=document.getElementById('confidenceMeter');
        cf.style.width=progressPct+'%';cf.classList.add('analyzing-bar');
        setEl('confPercent','Analyzing‚Ä¶ '+Math.round(progressPct)+'%');
        setEl('predictionConfidence','Confidence builds over '+lockAfter+'s window');
        setEl('predictionDetails','Gap: $'+gap.toFixed(0)+' ¬∑ Window: '+lockAfter+'s max');
        setEl('nextCheckTime',fmt(slotEnd));

        // Save pending prediction for resolution
        m.currentPrediction={willBeat:pred.willBeat,confidence:pred.confidence,priceToBeat:ptb,currentPrice:price,timestamp:Date.now(),targetTime:slotEnd,signals:pred.signals,strategy:'TIME'};

        displaySignals(pred.signals,true);
        updateCountdown();
        return;
      }
    }

    // ‚îÄ‚îÄ LOCKED DISPLAY ‚îÄ‚îÄ
    const displayDir=predictionLock.locked?predictionLock.direction:pred.willBeat;
    m.currentPrediction={willBeat:displayDir,confidence:pred.confidence,priceToBeat:ptb,currentPrice:price,timestamp:Date.now(),targetTime:slotEnd,signals:pred.signals,strategy:'TIME'};
    try{localStorage.setItem('currentPred5m',JSON.stringify({pred:m.currentPrediction,slot:Math.floor(Date.now()/300000)}))}catch(e){}

    const pb=document.getElementById('predictionDisplay');
    pb.className=displayDir?'pred pred-up':'pred pred-dn';
    setHtml('predictionValue',
      `<div style="font-size:1.1em">${displayDir?'‚Üë YES':'‚Üì NO'} üîí</div>`+
      `<div style="font-size:.52em;margin-top:4px;color:var(--tx2)">${displayDir?'Will beat':'Won\'t beat'} $${ptb.toFixed(2)}</div>`
    );
    const cf=document.getElementById('confidenceMeter'),cfPct=parseFloat(pred.confidence);
    cf.style.width=cfPct+'%';cf.classList.remove('analyzing-bar');
    cf.style.background=cfPct>=70?'linear-gradient(90deg,var(--up),#00b86e)':cfPct>=50?'linear-gradient(90deg,#eab308,#d97706)':'linear-gradient(90deg,var(--dn),#b91c1c)';
    setEl('confPercent',cfPct+'%');
    setEl('predictionConfidence','Confidence: '+pred.confidence+'%');
    setEl('predictionDetails','Resolves '+fmt(slotEnd)+' ¬∑ Gap was: $'+gap.toFixed(0));
    setEl('nextCheckTime',fmt(slotEnd));

    displaySignals(pred.signals,false);
    updateCountdown();
  }
}

// ‚ïê‚ïê‚ïê RESOLUTION ‚ïê‚ïê‚ïê
function checkPrediction(np){
  const m=getActiveMarket(),cp=m.currentPrediction;
  if(!cp?.priceToBeat)return;
  const pw=cp.willBeat,ab=np>cp.priceToBeat,ok=pw===ab;
  trainingData.push({label:ab?1:0});if(trainingData.length>100)trainingData.shift();
  if(trainingData.length>=30&&trainingData.length%5===0)trainModels();
  stats.total++;if(ok){stats.correct++;stats.currentStreak++}else stats.currentStreak=0;
  if(parseFloat(cp.confidence)>=70){stats.highConfPredictions++;if(ok)stats.highConfCorrect++}
  if(cp.strategy){if(!window.strategyStats)window.strategyStats={};if(!window.strategyStats[cp.strategy])window.strategyStats[cp.strategy]={correct:0,total:0};window.strategyStats[cp.strategy].total++;if(ok)window.strategyStats[cp.strategy].correct++}
  updateSignalLearning(cp.signals,ok,pw);
  if(cp.signals)cp.signals.forEach(sig=>{const k=sig.name.split(' ')[0].toLowerCase();if(!signalPerformance[k])signalPerformance[k]={correct:0,total:0};signalPerformance[k].total++;if(ok)signalPerformance[k].correct++});
  recentResults.push({correct:ok,time:Date.now()});if(recentResults.length>20)recentResults=recentResults.slice(-20);
  try{localStorage.setItem('btcRecentResults',JSON.stringify(recentResults))}catch(e){}
  predictionHistory.unshift({timestamp:fmt(new Date()),targetTime:fmt(cp.targetTime),priceToBeat:'$'+cp.priceToBeat.toFixed(2),predicted:pw?'WILL BEAT':'WON\'T BEAT',actual:ab?'DID BEAT':'DIDN\'T',correct:ok,actualPrice:'$'+np.toFixed(2),confidence:cp.confidence+'%',pattern:cp.pattern?.pattern});
  if(predictionHistory.length>50)predictionHistory.pop();
  updateStats();updateHistoryDisplay();saveProgress();
  m.currentPrediction=null;
}

function updateStats(){setEl('totalPredictions',stats.total);setEl('correctPredictions',stats.correct);setEl('accuracyRate',(stats.total?(stats.correct/stats.total*100).toFixed(1):0)+'%');setEl('highConfAccuracy',(stats.highConfPredictions?(stats.highConfCorrect/stats.highConfPredictions*100).toFixed(1):0)+'%');setEl('winStreak',stats.currentStreak);setEl('skippedCount',stats.skipped)}
function updateHistoryDisplay(){const el=document.getElementById('history');if(!predictionHistory.length){el.innerHTML='<div style="text-align:center;padding:16px;color:var(--tx3);font-size:.8em">No predictions yet</div>';return}el.innerHTML=predictionHistory.map(h=>`<div class="hitem"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px"><span style="font-family:JetBrains Mono,monospace;font-size:.82em">${h.targetTime}</span><span class="${h.correct?'correct':'incorrect'}">${h.correct?'‚úì Correct':'‚úó Wrong'}</span><span style="background:var(--sf3);padding:2px 6px;border-radius:4px;font-size:.75em">${h.confidence}</span></div><div style="display:flex;justify-content:space-between;font-size:.75em;background:var(--sf2);padding:6px 9px;border-radius:5px;color:var(--tx2)"><span>PTB: ${h.priceToBeat}</span><span>${h.actualPrice}</span><span>${h.predicted}</span></div>${h.pattern?`<div style="font-size:.72em;color:var(--btc);margin-top:4px">${h.pattern}</div>`:''}</div>`).join('')}
function updateSignalPerformance(){const el=document.getElementById('signalPerformance');const k=Object.keys(signalPerformance);if(!k.length){el.innerHTML='<div style="text-align:center;color:var(--tx3);font-size:.8em">Collecting‚Ä¶</div>';return}el.innerHTML=k.map(s=>{const p=signalPerformance[s];return`<div style="display:flex;justify-content:space-between;padding:5px 8px;background:var(--sf);margin:2px 0;border-radius:4px;font-size:.78em"><span>${s}</span><span>${p.correct}/${p.total} (${(p.correct/p.total*100).toFixed(0)}%)</span></div>`}).join('')}

// ‚ïê‚ïê‚ïê MAIN LOOP ‚ïê‚ïê‚ïê
async function refreshCandles(){try{const r=await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=5m&limit=100');window.candles5m=(await r.json()).map(c=>({time:c[0],open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3]),close:parseFloat(c[4]),volume:parseFloat(c[5])}))}catch(e){}}

async function updatePrice(){
  const price=await fetchBTCPrice(),vl=getVolume(),now=new Date();
  const last=priceHistory.length?priceHistory[priceHistory.length-1]:null;
  priceHistory.push({price,volume:vl,timestamp:now.getTime(),open:last?.price||price,high:last?Math.max(last.price,price):price,low:last?Math.min(last.price,price):price,close:price});
  if(priceHistory.length>500)priceHistory.shift();

  [5,15,60].forEach(tf=>{
    const m=markets[tf],cs=getSlot(tf,now);
    if(m.currentSlot!==null&&m.currentSlot!==cs){
      if(m.currentPrediction&&tf===selectedTimeframe)checkPrediction(price);
      m.currentPrediction=null;
      if(tf===selectedTimeframe){resetPositionHistory();resetPredictionLock()}
    }
    if(m.currentSlot!==cs){
      m.currentSlot=cs;
      if(tf!==5){m.priceToBeat=latestChainlinkPrice||price;m.slotStartTime=Date.now()}
    }
  });

  if(extUpdateCount%12===0){fetchTakerVolume();refreshCandles()}
  await updateDisplay(price,vl);
}

async function startPredictions(){
  if(isRunning)return;isRunning=true;
  document.getElementById('startBtn').disabled=true;document.getElementById('stopBtn').disabled=false;
  setEl('status','Loading 200 historical candles...');
  await loadHistoricalData();
  loadPredictionLock();
  try{const saved=JSON.parse(localStorage.getItem('currentPred5m'));if(saved&&saved.slot===Math.floor(Date.now()/300000)){markets[5].currentPrediction=saved.pred}}catch(e){}
  const now=new Date();
  [5,15,60].forEach(tf=>{markets[tf].currentSlot=getSlot(tf,now);markets[tf].slotStartTime=Date.now()});
  setEl('status','Running ‚Äî data loaded');
  updatePrice();
  updateInterval=setInterval(updatePrice,5e3);
  checkInterval=setInterval(updateCountdown,1e3);
}

function stopPredictions(){if(!isRunning)return;isRunning=false;clearInterval(updateInterval);clearInterval(checkInterval);document.getElementById('startBtn').disabled=false;document.getElementById('stopBtn').disabled=true;setEl('status','Stopped')}

function resetStats(){
  if(!confirm('Reset all data?'))return;
  stats={total:0,correct:0,currentStreak:0,skipped:0,highConfPredictions:0,highConfCorrect:0};
  predictionHistory=[];priceHistory=[];trainingData=[];signalPerformance={};signalMultipliers={};
  [5,15,60].forEach(tf=>{markets[tf]={priceToBeat:null,currentSlot:null,currentPrediction:null,slotStartTime:null}});
  if(lstmModel)lstmModel.dispose();if(technicalModel)technicalModel.dispose();if(hybridModel)hybridModel.dispose();
  lstmModel=null;technicalModel=null;hybridModel=null;
  localStorage.removeItem('btcPred');
  updateStats();updateHistoryDisplay();
  setEl('mlStatus','Ensemble: Initializing');setEl('status','Reset complete');setEl('priceToBeat','--');setEl('vsComparison','--');
}

window.addEventListener('DOMContentLoaded',()=>{loadProgress();startPredictions()});
</script>
</body>
</html>
